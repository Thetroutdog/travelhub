<!DOCTYPE html>
<!--
  Travel Hub ‚Äî Personal Travel Planning
  ¬© 2026 Troutdog Adventures. All rights reserved.
  Replace with your preferred license text (MIT / Apache-2.0 / etc.).
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Travel Hub - Personal Travel Planning</title>
  <link rel="stylesheet" href="./styles.css">
  <!-- Blocking theme script: runs before first paint to prevent flash of wrong theme.
       Reads travelHubTheme from localStorage; defaults to dark if no preference stored. -->
  <script>
    (function () {
      try {
        var stored = localStorage.getItem('travelHubTheme');
        var theme = stored || 'dark';
        document.documentElement.setAttribute('data-theme', theme);
      } catch (e) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script>
</head>
<body>
  <div id="app" v-cloak>
    <div class="app-shell">
      <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <aside class="sidebar" aria-label="App sidebar">
        <!-- Brand / save status -->
        <div class="sidebar__brand">
          <div class="sidebar__brand-row">
            <div class="sidebar__icon" aria-hidden="true">‚úà</div>
            <span class="sidebar__logo">Travel Hub</span>
            <span class="sidebar__version">v2.0.0</span>
          </div>
          <div
            class="sidebar__status"
            :class="{
              'sidebar__status--saving': saveStatus === 'saving',
              'sidebar__status--error': saveStatus === 'error'
            }"
          >
            <span v-if="saveStatus === 'saved' && tripPageMode !== 'create' && saveStatusVisible">All changes saved ‚úì</span>
            <span v-else-if="saveStatus === 'saving'">Saving‚Ä¶</span>
            <span v-else-if="saveStatus === 'error'">
              ‚ö† Save failed ¬∑
              <button type="button" class="sidebar__status-link" @click="backupJSON">Backup now</button>
            </span>
          </div>
        </div>

        <!-- Primary nav: My Trips ‚Üí Calendar ‚Üí Journeys -->
        <nav class="sidebar__nav" aria-label="Primary navigation">
          <button
            type="button"
            class="sidebar__nav-btn"
            :class="{ 'sidebar__nav-btn--active': currentView === 'list' }"
            @click="switchTab('list')"
          >
            <svg width="15" height="15" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M2 4h12M2 8h12M2 12h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            My Trips
          </button>
          <button
            type="button"
            class="sidebar__nav-btn"
            :class="{ 'sidebar__nav-btn--active': currentView === 'calendar' }"
            @click="switchTab('calendar')"
          >
            <svg width="15" height="15" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <rect x="1.5" y="3.5" width="13" height="11" rx="1.5" stroke="currentColor" stroke-width="1.5"/>
              <path d="M5 1.5V4.5M11 1.5V4.5M1.5 7.5h13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            Calendar
          </button>
          <button
            type="button"
            class="sidebar__nav-btn"
            :class="{ 'sidebar__nav-btn--active': currentView === 'journeys' || currentView === 'journey-detail' }"
            @click="switchTab('journeys')"
          >
            <svg width="15" height="15" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M2 3h4l2 2h6v8H2V3z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Journeys
          </button>
          <!-- Help link: shown only when help.html is available (checked on mount) -->
          <button
            v-if="helpAvailable"
            type="button"
            class="sidebar__nav-btn sidebar__nav-btn--help"
            @click="openHelp"
            aria-label="Open Help documentation"
          >
            <svg width="15" height="15" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="8" cy="8" r="6.5" stroke="currentColor" stroke-width="1.5"/>
              <path d="M6.5 6.5a1.5 1.5 0 011.5-1.5 1.5 1.5 0 011.5 1.5c0 .75-.5 1.25-1 1.5C8 8.25 8 8.75 8 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              <circle cx="8" cy="11" r="0.75" fill="currentColor"/>
            </svg>
            Help
          </button>
        </nav>

        <!-- Actions: Create + Tools -->
        <div class="sidebar__section-title">Actions</div>
        <div class="sidebar__actions">
          <!-- Primary create actions -->
          <button type="button" class="sidebar__action-btn sidebar__action-btn--primary" @click="openNewTrip">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            New Trip
          </button>
          <button type="button" class="sidebar__action-btn sidebar__action-btn--primary" @click="openJourneyModal('create')">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            New Journey
          </button>

          <!-- Tools -->
          <div class="sidebar__actions-divider" aria-hidden="true"></div>
          <button type="button" class="sidebar__action-btn" @click="openSearchPalette">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="6.5" cy="6.5" r="4.5" stroke="currentColor" stroke-width="1.5"/>
              <path d="M10 10L14 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            Search
            <kbd class="sidebar__kbd">‚åòK</kbd>
          </button>
          <button type="button" class="sidebar__action-btn" @click="openExportPanel">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M2 11v2a1 1 0 001 1h10a1 1 0 001-1v-2M8 2v8m0 0L5.5 7.5M8 10l2.5-2.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Export‚Ä¶
          </button>

          <!-- Data section (collapsible) -->
          <div class="sidebar__data-section">
            <button
              type="button"
              class="sidebar__data-toggle"
              @click="sidebarDataExpanded = !sidebarDataExpanded"
              :aria-expanded="sidebarDataExpanded.toString()"
            >
              <span>Data</span>
              <svg
                width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"
                class="sidebar__data-chevron"
                :class="{ 'sidebar__data-chevron--open': sidebarDataExpanded }"
                aria-hidden="true"
              >
                <path d="M3 4.5l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div v-if="sidebarDataExpanded" class="sidebar__data-actions">
              <div class="sidebar__backup-row">
                <button type="button" class="sidebar__action-btn sidebar__action-btn--sub sidebar__backup-main-btn" @click="backupJSON">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M2 11v2a1 1 0 001 1h10a1 1 0 001-1v-2M8 2v8m0 0L5.5 7.5M8 10l2.5-2.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Backup
                </button>
                <button
                  type="button"
                  class="sidebar__backup-info-btn"
                  :class="{ 'sidebar__backup-info-btn--active': showBackupInfo }"
                  @click.stop="showBackupInfo = !showBackupInfo"
                  :aria-expanded="showBackupInfo.toString()"
                  aria-label="Where does the backup file go?"
                  title="Where does the backup file go?"
                >
                  <svg width="13" height="13" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <circle cx="8" cy="8" r="6.5" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M8 7v5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    <circle cx="8" cy="5" r="0.75" fill="currentColor"/>
                  </svg>
                </button>
              </div>
              <div v-if="showBackupInfo" class="sidebar__backup-info-panel">
                <p class="sidebar__backup-info-text">
                  Downloads as <strong>travel-hub-backup-YYYY-MM-DD.json</strong> to your <strong>Downloads</strong> folder.
                </p>
                <p class="sidebar__backup-info-text">
                  On <strong>iPhone/iPad</strong>: appears in the Files app under Downloads (Safari) or in-browser (Chrome/Firefox).
                </p>
              </div>
              <button type="button" class="sidebar__action-btn sidebar__action-btn--sub" @click="triggerFileOpen">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M2.5 9.5v3a1 1 0 001 1h9a1 1 0 001-1v-3M8 2.5v8m0-8L5.5 5M8 2.5L10.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Restore
              </button>
              <!-- Load example data: button + (i) info toggle -->
              <div class="sidebar__backup-row">
                <button type="button" class="sidebar__action-btn sidebar__action-btn--sub sidebar__backup-main-btn" @click="loadExampleData">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <circle cx="8" cy="8" r="6.5" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M8 5v6m-3-3l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Load example data
                </button>
                <button
                  type="button"
                  class="sidebar__backup-info-btn"
                  :class="{ 'sidebar__backup-info-btn--active': showExampleHintNearData }"
                  @click.stop="toggleExampleHintNearData"
                  :aria-expanded="showExampleHintNearData.toString()"
                  aria-label="About example data"
                  title="What is example data?"
                >
                  <svg width="13" height="13" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <circle cx="8" cy="8" r="6.5" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M8 7v5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    <circle cx="8" cy="5" r="0.75" fill="currentColor"/>
                  </svg>
                </button>
              </div>
              <!-- Example data hint panel (near Load button) -->
              <div v-if="showExampleHintNearData" class="sidebar__backup-info-panel sidebar__example-hint-panel">
                <p class="sidebar__backup-info-text">
                  Want to see what Travel Hub can do? Load example trips to explore the calendar, tasks, expenses, and journeys.
                </p>
                <p class="sidebar__backup-info-text">
                  When you're ready, clear everything and start planning for real.
                </p>
                <div class="sidebar__example-hint-actions">
                  <button type="button" class="btn btn--primary btn--sm" @click="loadExampleData(); showExampleHintNearData = false">Load example trips</button>
                  <button type="button" class="btn btn--secondary btn--sm" @click="dismissExampleHint">Got it</button>
                </div>
              </div>
              <button v-if="dataFile.trips.length > 0" type="button" class="sidebar__action-btn sidebar__action-btn--danger" @click="openClearDataModal">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M3 4h10M6 4V2.5a.5.5 0 01.5-.5h3a.5.5 0 01.5.5V4M5.5 4l.5 8h4l.5-8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Clear all data
              </button>
            </div>
          </div>
        </div>

        <!-- Backup reminder (shown when no backup in 30+ days, or never) -->
        <div v-if="shouldShowBackupReminder" class="sidebar__backup-reminder">
          <span class="sidebar__backup-text">
            üíæ Consider backing up your trips.
            <button type="button" class="sidebar__backup-toggle" @click="showBackupHint = !showBackupHint">
              {{ showBackupHint ? 'Hide' : 'Why?' }}
            </button>
          </span>
          <div v-if="showBackupHint" class="sidebar__backup-panel">
            <p class="sidebar__backup-body">
              Trips are <strong>autosaved</strong> to this browser. A <strong>backup file</strong> lets you restore in any browser or keep a permanent copy.
            </p>
            <div class="sidebar__backup-actions">
              <button type="button" class="btn btn--primary btn--sm" @click="backupJSON">Backup now</button>
              <button type="button" class="btn btn--secondary btn--sm" @click="showBackupHint = false; settings.lastBackupDate = new Date().toISOString(); saveSettings()">Dismiss</button>
            </div>
          </div>
          <!-- Example data nudge: shown unless dismissed -->
          <div v-if="!exampleHintDismissed" class="sidebar__try-example-row">
            <button
              type="button"
              class="sidebar__backup-toggle"
              @click="toggleExampleHintNearBackup"
              :aria-expanded="showExampleHintNearBackup.toString()"
            >New here? Try example trips.</button>
          </div>
          <div v-if="showExampleHintNearBackup" class="sidebar__backup-panel sidebar__example-hint-panel">
            <p class="sidebar__backup-body">
              Load example trips to explore the calendar, tasks, expenses, and journeys.
              Clear everything whenever you're ready to start fresh.
            </p>
            <div class="sidebar__example-hint-actions">
              <button type="button" class="btn btn--primary btn--sm" @click="loadExampleData(); showExampleHintNearBackup = false">Load example trips</button>
              <button type="button" class="btn btn--secondary btn--sm" @click="dismissExampleHint">Got it</button>
            </div>
          </div>
        </div>

        <!-- Sidebar footer: theme toggle -->
        <div class="sidebar__footer">
          <button
            type="button"
            class="sidebar__theme-btn"
            @click="toggleTheme"
            aria-label="Toggle theme"
            title="Toggle theme"
          >
            <svg v-if="theme === 'light'" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M14 8.5C13.9 11.5 11.4 14 8.4 14C5.4 14 3 11.6 3 8.6C3 5.6 5.5 3.1 8.5 3C8.3 3.3 8.2 3.6 8.2 4C8.2 5.7 9.6 7.1 11.3 7.1C11.7 7.1 12 7 12.3 6.8C12.9 7.6 13.3 8.5 14 8.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <svg v-else width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 11.5C9.933 11.5 11.5 9.933 11.5 8C11.5 6.067 9.933 4.5 8 4.5C6.067 4.5 4.5 6.067 4.5 8C4.5 9.933 6.067 11.5 8 11.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 1V2M8 14V15M15 8H14M2 8H1M12.5 12.5L11.79 11.79M4.21 4.21L3.5 3.5M12.5 3.5L11.79 4.21M4.21 11.79L3.5 12.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="sidebar__theme-label">{{ theme === 'light' ? 'Dark mode' : 'Light mode' }}</span>
          </button>
        </div>
      </aside>
      <!-- ‚îÄ‚îÄ /Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

      <!-- ‚îÄ‚îÄ Main area ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="main-area">
        <!-- Hidden file input (accessible to sidebar and mobile menu) -->
        <input
          type="file"
          ref="fileInput"
          @change="openJSON"
          accept=".json"
          style="display: none;"
        >

        <!-- Mobile tab bar (hidden on desktop, shown on <980px) -->
        <div class="mobile-tabs">
          <nav class="mobile-tabs__nav" role="tablist" aria-label="Main navigation">
            <button type="button" class="mobile-tabs__tab" :class="{ 'mobile-tabs__tab--active': currentView === 'list' }" role="tab" :aria-selected="(currentView === 'list').toString()" @click="switchTab('list')">My Trips</button>
            <button type="button" class="mobile-tabs__tab" :class="{ 'mobile-tabs__tab--active': currentView === 'calendar' }" role="tab" :aria-selected="(currentView === 'calendar').toString()" @click="switchTab('calendar')">Calendar</button>
            <button type="button" class="mobile-tabs__tab" :class="{ 'mobile-tabs__tab--active': currentView === 'journeys' || currentView === 'journey-detail' }" role="tab" :aria-selected="(currentView === 'journeys' || currentView === 'journey-detail').toString()" @click="switchTab('journeys')">Journeys</button>
          </nav>
          <div class="mobile-tabs__actions">
            <button type="button" class="mobile-tabs__icon-btn" @click="toggleTheme" aria-label="Toggle theme">
              <svg v-if="theme === 'light'" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 8.5C13.9 11.5 11.4 14 8.4 14C5.4 14 3 11.6 3 8.6C3 5.6 5.5 3.1 8.5 3C8.3 3.3 8.2 3.6 8.2 4C8.2 5.7 9.6 7.1 11.3 7.1C11.7 7.1 12 7 12.3 6.8C12.9 7.6 13.3 8.5 14 8.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <svg v-else width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 11.5C9.933 11.5 11.5 9.933 11.5 8C11.5 6.067 9.933 4.5 8 4.5C6.067 4.5 4.5 6.067 4.5 8C4.5 9.933 6.067 11.5 8 11.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 1V2M8 14V15M15 8H14M2 8H1M12.5 12.5L11.79 11.79M4.21 4.21L3.5 3.5M12.5 3.5L11.79 4.21M4.21 11.79L3.5 12.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="settings-menu-container">
              <button type="button" class="mobile-tabs__icon-btn" @click="toggleSettingsMenu" aria-label="Settings" aria-haspopup="menu" :aria-expanded="showSettingsMenu.toString()">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M6.5 1.5H9.5L10 3.5C10.4 3.7 10.8 3.9 11.1 4.2L13 3.5L14.5 6L13 7.2C13 7.5 13 7.7 13 8C13 8.3 13 8.5 13 8.8L14.5 10L13 12.5L11.1 11.8C10.8 12.1 10.4 12.3 10 12.5L9.5 14.5H6.5L6 12.5C5.6 12.3 5.2 12.1 4.9 11.8L3 12.5L1.5 10L3 8.8C3 8.5 3 8.3 3 8C3 7.7 3 7.5 3 7.2L1.5 6L3 3.5L4.9 4.2C5.2 3.9 5.6 3.7 6 3.5L6.5 1.5Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                  <circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.5"/>
                </svg>
              </button>
              <div v-if="showSettingsMenu" class="dropdown-menu settings-menu dropdown-menu--right" role="menu" @click.stop>
                <div class="settings-menu__section-label">Data</div>
                <button type="button" class="dropdown-menu__item" role="menuitem" @click="backupJSON(); closeSettingsMenu()">üíæ Backup (download file)</button>
                <button type="button" class="dropdown-menu__item" role="menuitem" @click="triggerFileOpen(); closeSettingsMenu()">üìÇ Restore from backup‚Ä¶</button>
                <button type="button" class="dropdown-menu__item" role="menuitem" @click="loadExampleData(); closeSettingsMenu()">‚ú® Load example data</button>
                <div class="settings-menu__divider" role="separator"></div>
                <div class="settings-menu__section-label">Trips</div>
                <button type="button" class="dropdown-menu__item" role="menuitem" @click="openNewTrip(); closeSettingsMenu()">+ New Trip (full details)</button>
              </div>
            </div>
          </div>
        </div>


        <!-- Main Content -->
        <main class="main">
          <!-- Main topbar: page title (or journey-detail nav bar) -->
          <header class="main__topbar">
            <!-- Journey detail: Back | Journey name (truncated) | Delete -->
            <template v-if="currentView === 'journey-detail' && selectedJourney">
              <button type="button" class="btn btn--secondary btn--sm main__topbar-back" @click="switchTab('journeys')">‚Üê Back</button>
              <div class="main__title main__title--journey">{{ selectedJourney.name }}</div>
              <button type="button" class="btn btn--danger btn--sm main__topbar-delete" @click="deleteJourney(selectedJourney.id)">Delete</button>
            </template>
            <!-- All other views: static page title -->
            <div v-else class="main__title">{{ currentViewTitle }}</div>
          </header>

          <!-- Scrollable main content -->
          <div class="main__content">

            <!-- Stats Row (My Trips only, hidden on first visit) -->
            <div class="stats-row" v-if="currentView === 'list' && dataFile.trips.length > 0">
              <div class="stats-card">
                <div class="stats-card__label">Total Trips</div>
                <div class="stats-card__value">{{ stats.total }}</div>
              </div>
              <div class="stats-card">
                <div class="stats-card__label">Upcoming</div>
                <div class="stats-card__value">{{ stats.upcoming }}</div>
              </div>
              <div class="stats-card">
                <div class="stats-card__label">PLANNED SPEND ({{ currentYear }})</div>
                <div class="stats-card__value">{{ formatCurrency(stats.budget) }}</div>
                <div v-if="stats.budget === 0" class="stats-card__hint">Add expenses to see totals.</div>
              </div>
              <div class="stats-card">
                <div class="stats-card__label">Completed</div>
                <div class="stats-card__value">{{ stats.completed }}</div>
              </div>
              <div v-if="statusFilter.length > 0" class="stats-filter-indicator" aria-live="polite">
                <span class="stats-filter-indicator__pill">Filtered: {{ statusFilter.join(', ') }}</span>
              </div>
            </div>

            <!-- Controls Panel (My Trips only) -->
            <div class="controls-panel" v-if="currentView === 'list'">

              <!-- Row 1: Filter chips + Sort (hidden on first visit) -->
              <div class="controls-panel__chips-row" v-if="dataFile.trips.length > 0">
                <div class="filter-chips">
                  <button
                    type="button"
                    class="filter-chip"
                    :class="{ 'filter-chip--active': statusFilter.length === 0 }"
                    @click="setAllStatuses"
                  >All</button>
                  <button
                    type="button"
                    class="filter-chip"
                    :class="{ 'filter-chip--active': statusFilter.includes('Idea') }"
                    @click="toggleStatus('Idea')"
                  >Ideas</button>
                  <button
                    type="button"
                    class="filter-chip"
                    :class="{ 'filter-chip--active': statusFilter.includes('Planning') }"
                    @click="toggleStatus('Planning')"
                  >Planning</button>
                  <button
                    type="button"
                    class="filter-chip"
                    :class="{ 'filter-chip--active': statusFilter.includes('Committed') }"
                    @click="toggleStatus('Committed')"
                  >Committed</button>
                  <button
                    type="button"
                    class="filter-chip"
                    :class="{ 'filter-chip--active': statusFilter.includes('Canceled') }"
                    @click="toggleStatus('Canceled')"
                  >Canceled</button>
                  <button
                    type="button"
                    class="filter-chip"
                    :class="{ 'filter-chip--active': statusFilter.includes('Completed') }"
                    @click="toggleStatus('Completed')"
                  >Completed</button>
                  <button
                    type="button"
                    class="history-toggle"
                    :class="{ 'history-toggle--active': showHistory }"
                    @click="toggleHistory"
                    :aria-label="showHistory ? 'Hide completed and canceled trips' : 'Show completed and canceled trips'"
                    :aria-pressed="showHistory.toString()"
                  >{{ showHistory ? 'Hide history' : 'History' }}</button>
                </div>
                <div class="sort-control">
                  <select
                    class="select select--sm"
                    v-model="sortMode"
                    @change="onSortChange"
                  >
                    <option value="date-soonest">Date (Soonest)</option>
                    <option value="date-furthest">Date (Furthest)</option>
                    <option value="name-asc">Name (A‚ÄìZ)</option>
                    <option value="name-desc">Name (Z‚ÄìA)</option>
                    <option value="journey">Journey</option>
                  </select>
                </div>
              </div>

              <!-- Row 3: Quick-add -->
              <div class="controls-panel__quickadd-row">
                <span class="controls-panel__quickadd-plus" aria-hidden="true">+</span>
                <input
                  type="text"
                  class="controls-panel__quickadd-input"
                  v-model="quickAddInput"
                  @keydown.enter.prevent="quickAddTrip"
                  @keydown.escape="quickAddInput = ''"
                  placeholder="Add a trip idea ‚Äî just a name is fine"
                  aria-label="Add a trip idea"
                  autocomplete="off"
                  autocorrect="off"
                  autocapitalize="sentences"
                  spellcheck="false"
                  ref="quickAddInput"
                />
                <button
                  type="button"
                  class="btn btn--primary btn--sm"
                  :disabled="!quickAddInput.trim()"
                  @click="quickAddTrip"
                  aria-label="Add trip idea"
                >Add</button>
              </div>

              <!-- Workflow hint (first-time only) -->
              <p v-if="dataFile.trips.length === 0" class="controls-panel__workflow-hint">
                Add an idea ‚Üí Set dates ‚Üí See it on your calendar ‚Üí Group trips into a Journey
              </p>

            </div>

        <!-- List View -->
        <div v-if="currentView === 'list' && tripPageMode === null">

          <!-- Filter empty state (trips exist but none match current filters) -->
          <div v-if="visibleTrips.length === 0 && dataFile.trips.length > 0" class="empty-state empty-state--inline">
            <p style="color: var(--text-muted); margin-bottom: 12px;">No trips match your current filters.</p>
            <button type="button" class="btn btn--secondary btn--sm" @click="resetFilters">Clear filters</button>
          </div>

          <!-- First-time welcome card (no trips exist yet) -->
          <div v-if="dataFile.trips.length === 0" class="welcome-card">
            <div class="welcome-card__icon" aria-hidden="true">‚úàÔ∏è</div>
            <h2 class="welcome-card__title">Plan your year in trips, not lists.</h2>
            <p class="welcome-card__body">See how your time fits together ‚Äî name something you'd love to do and we'll help from there.</p>
            <ol class="welcome-card__steps" aria-label="Getting started">
              <li class="welcome-card__step">
                <span class="welcome-card__step-num" aria-hidden="true">1</span>
                <span class="welcome-card__step-text"><strong>Name a trip</strong> ‚Äî anything on your radar (details come later)</span>
              </li>
              <li class="welcome-card__step">
                <span class="welcome-card__step-num" aria-hidden="true">2</span>
                <span class="welcome-card__step-text"><strong>Add rough dates</strong> ‚Äî tap the card to open and fill in anytime</span>
              </li>
              <li class="welcome-card__step welcome-card__step--highlight">
                <span class="welcome-card__step-num welcome-card__step-num--highlight" aria-hidden="true">3</span>
                <span class="welcome-card__step-text">
                  <strong>See your year on Calendar</strong>
                  <span class="welcome-card__step-sub"> ‚Äî every trip lands here so you can see how your time fits together</span>
                </span>
              </li>
            </ol>
          </div>

          <!-- "Your year is open" nudge ‚Äî shown when trips exist but none are in current year -->
          <div v-if="dataFile.trips.length > 0 && tripsThisYear === 0" class="year-open-nudge">
            Your year is open ‚Äî what would you like to plan?
          </div>

          <!-- Trip list: date-grouped or journey-grouped depending on sort mode -->
          <div v-if="visibleTrips.length > 0" class="trips-grid">
            <template
              v-for="item in displayItems"
              :key="item.type === 'trip' ? 'trip-' + item.trip.id : item.label + '-' + item.type"
            >
              <!-- Section divider (Past trips / No date set) -->
              <div
                v-if="item.type === 'divider'"
                class="list-divider"
                role="separator"
              >
                <hr class="list-divider__line">
                <span class="list-divider__label">{{ item.label }}</span>
              </div>

              <!-- Journey group header -->
              <div
                v-else-if="item.type === 'journey-header'"
                class="journey-group-header"
              >
                <span class="journey-group-header__label">{{ item.label }}</span>
                <span class="journey-group-header__count">{{ item.count }} trip{{ item.count !== 1 ? 's' : '' }}</span>
              </div>

              <!-- Trip card (unified with calendar-trip) -->
              <div
                v-else
                class="calendar-trip"
                :class="{
                  'calendar-trip--new': highlightedTripId && item.trip.id === highlightedTripId,
                  'calendar-trip--completed-pulse': recentlyCompletedTripId === item.trip.id
                }"
                role="button"
                tabindex="0"
                @click="selectTrip(item.trip)"
                @keydown.enter.prevent="selectTrip(item.trip)"
                @keydown.space.prevent="selectTrip(item.trip)"
              >
                <div class="calendar-trip__name">{{ item.trip.name }}</div>
                <div v-if="item.trip.destination" class="calendar-trip__destination">{{ item.trip.destination }}</div>
                <div class="calendar-trip__meta">
                  <span :class="'badge badge--' + item.trip.status.toLowerCase()">{{ item.trip.status }}</span>
                  <span v-if="recentlyCompletedTripId === item.trip.id" class="calendar-trip__completed-check" aria-hidden="true">‚úì</span>
                  <span class="calendar-trip__dates">
                    <span v-if="item.trip.startDate">{{ formatDateRange(item.trip.startDate, item.trip.endDate) }}</span>
                    <span v-else class="calendar-trip__no-date">No date</span>
                  </span>
                </div>
              </div>
            </template>
          </div>

          <!-- Calendar progression card (shown when exactly 1 trip exists) -->
          <template v-if="dataFile.trips.length === 1 && !hasSeenCalendarCard">

            <!-- Case A: No dates yet -->
            <div v-if="!dataFile.trips[0].startDate" class="calendar-guidance-card">
              <div class="calendar-guidance-card__eyebrow">Next step</div>
              <div class="calendar-guidance-card__title">See your year at a glance</div>
              <p class="calendar-guidance-card__body">Add rough dates anytime (you can change them later) ‚Äî then open Calendar to see how your year fits together.</p>
              <div class="calendar-guidance-card__actions">
                <button type="button" class="btn btn--primary btn--sm" @click="viewCalendarFromCard">Open Calendar</button>
                <button type="button" class="btn btn--secondary btn--sm" @click="openTripToAddDates">Add Dates First</button>
              </div>
            </div>

            <!-- Case B: Has dates ‚Äî prompt to view calendar -->
            <div v-else class="calendar-guidance-card">
              <div class="calendar-guidance-card__eyebrow">Next step</div>
              <div class="calendar-guidance-card__title">See your year at a glance</div>
              <p class="calendar-guidance-card__body">Your trip is now on the calendar. Open Calendar to see how your year is shaping up.</p>
              <div class="calendar-guidance-card__actions">
                <button type="button" class="btn btn--primary btn--sm" @click="viewCalendarFromCard">Open Calendar</button>
              </div>
            </div>

          </template>

        </div>

        <!-- Calendar View -->
        <div v-if="currentView === 'calendar' && tripPageMode === null">

          <!-- ‚îÄ‚îÄ Calendar "aha" first-visit callout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
          <div v-if="calendarAhaVisible" class="calendar-aha-callout" role="status" aria-live="polite">
            <span class="calendar-aha-callout__text">This is your year ‚Äî every trip lands here.</span>
            <button type="button" class="calendar-aha-callout__close" @click="calendarAhaVisible = false" aria-label="Dismiss">Got it</button>
          </div>

          <!-- Calendar toolbar: Month/Quarter toggle + month nav + history toggle -->
          <div class="calendar-toolbar">
            <div class="calendar-toolbar__left">
              <div class="calendar-mode-toggle" role="group" aria-label="Calendar view mode">
                <button
                  type="button"
                  class="calendar-mode-toggle__btn"
                  :class="{ 'calendar-mode-toggle__btn--active': calendarViewMode === 'month' }"
                  :aria-pressed="(calendarViewMode === 'month').toString()"
                  @click="calendarViewMode = 'month'; calendarModeUserToggled = true; calendarMonth = { year: new Date().getFullYear(), month: new Date().getMonth() }; saveUIPrefs()"
                >Month</button>
                <button
                  type="button"
                  class="calendar-mode-toggle__btn"
                  :class="{ 'calendar-mode-toggle__btn--active': calendarViewMode === 'quarter' }"
                  :aria-pressed="(calendarViewMode === 'quarter').toString()"
                  @click="calendarViewMode = 'quarter'; calendarModeUserToggled = true; saveUIPrefs()"
                >Quarter</button>
              </div>
              <div v-if="calendarViewMode === 'month'" class="calendar-month-nav">
                <button
                  type="button"
                  class="calendar-month-nav__btn"
                  @click="prevCalendarMonth"
                  aria-label="Previous month"
                >&#8249;</button>
                <span class="calendar-month-nav__label" aria-live="polite">{{ calendarMonthLabel }}</span>
                <button
                  type="button"
                  class="calendar-month-nav__btn"
                  @click="nextCalendarMonth"
                  aria-label="Next month"
                >&#8250;</button>
                <button
                  type="button"
                  class="calendar-today-btn btn btn--secondary btn--sm"
                  @click="jumpToToday"
                  aria-label="Jump to current month"
                >Today</button>
              </div>
            </div>
            <div class="calendar-toolbar__right">
              <button
                type="button"
                class="history-toggle"
                :class="{ 'history-toggle--active': calendarShowHistory }"
                :aria-label="calendarShowHistory ? 'Hide completed and canceled trips from calendar' : 'Show completed and canceled trips in calendar'"
                :aria-pressed="calendarShowHistory.toString()"
                @click="toggleCalendarHistory"
              >{{ calendarShowHistory ? 'Hide history' : 'History' }}</button>
            </div>
          </div>

          <!-- Calendar Filter Chips (mirrors My Trips filters) -->
          <div class="calendar-filter-bar">
            <div class="filter-chips">
              <button
                type="button"
                class="filter-chip"
                :class="{ 'filter-chip--active': statusFilter.length === 0 }"
                @click="setAllStatuses"
              >All</button>
              <button
                type="button"
                class="filter-chip"
                :class="{ 'filter-chip--active': statusFilter.includes('Idea') }"
                @click="toggleStatus('Idea')"
              >Ideas</button>
              <button
                type="button"
                class="filter-chip"
                :class="{ 'filter-chip--active': statusFilter.includes('Planning') }"
                @click="toggleStatus('Planning')"
              >Planning</button>
              <button
                type="button"
                class="filter-chip"
                :class="{ 'filter-chip--active': statusFilter.includes('Committed') }"
                @click="toggleStatus('Committed')"
              >Committed</button>
              <button
                type="button"
                class="filter-chip"
                :class="{ 'filter-chip--active': statusFilter.includes('Canceled') }"
                @click="toggleStatus('Canceled')"
              >Canceled</button>
              <button
                type="button"
                class="filter-chip"
                :class="{ 'filter-chip--active': statusFilter.includes('Completed') }"
                @click="toggleStatus('Completed')"
              >Completed</button>
            </div>
          </div>

          <!-- Month View -->
          <div v-if="calendarViewMode === 'month'" class="calendar-view-panel">
            <!-- Empty state: no dated trips AND no no-date trips -->
            <div v-if="calendarMonthData.length === 0 && calendarNoDateData.length === 0" class="empty-state">
              <p class="empty-state__message">No trips this month</p>
              <p v-if="statusFilter.length > 0" class="text-muted">
                No trips match your filters.
                <button type="button" class="btn btn--secondary btn--sm" @click="setAllStatuses" style="margin-left: 8px;">Clear filters</button>
              </p>
              <p v-else class="text-muted">Try navigating to another month or switching to Quarter view</p>
            </div>

            <!-- Trips with dates overlapping this month -->
            <div v-if="calendarMonthData.length > 0" class="calendar-month-grid">
              <div
                v-for="trip in calendarMonthData"
                :key="trip.id"
                class="calendar-trip"
                role="button"
                tabindex="0"
                :aria-label="trip.name + (trip.destination ? ', ' + trip.destination : '')"
                @click="selectTrip(trip)"
                @keydown.enter.prevent="selectTrip(trip)"
                @keydown.space.prevent="selectTrip(trip)"
              >
                <div class="calendar-trip__name">{{ trip.name }}</div>
                <div v-if="trip.destination" class="calendar-trip__destination">{{ trip.destination }}</div>
                <div class="calendar-trip__meta">
                  <span :class="'badge badge--' + trip.status.toLowerCase()">{{ trip.status }}</span>
                  <span class="calendar-trip__dates">
                    <span v-if="calendarTripSpan(trip).before" class="calendar-trip__span-indicator" aria-label="starts before this month">‚Üê&thinsp;</span>
                    {{ calendarTripDateLabel(trip) }}
                    <span v-if="calendarTripSpan(trip).after" class="calendar-trip__span-indicator" aria-label="ends after this month">&thinsp;‚Üí</span>
                  </span>
                </div>
              </div>
            </div>

            <!-- Undated trips ‚Äî shown below a divider, capped at 5; "View all" links to My Trips -->
            <div v-if="calendarNoDateData.length > 0" class="calendar-nodate-section">
              <hr class="calendar-year__divider">
              <div class="calendar-nodate-header">
                <span class="calendar-nodate-header__title">Undated</span>
                <span class="calendar-quarter__count">
                  {{ calendarNoDateData.length }} trip{{ calendarNoDateData.length !== 1 ? 's' : '' }}
                </span>
                <button
                  type="button"
                  class="calendar-nodate-viewall btn btn--secondary btn--sm"
                  @click="switchTab('list')"
                  aria-label="View all trips in My Trips tab"
                >View all ‚Üí</button>
              </div>
              <div class="calendar-month-grid">
                <div
                  v-for="trip in calendarNoDateData.slice(0, 5)"
                  :key="trip.id"
                  class="calendar-trip"
                  role="button"
                  tabindex="0"
                  :aria-label="trip.name"
                  @click="selectTrip(trip)"
                  @keydown.enter.prevent="selectTrip(trip)"
                  @keydown.space.prevent="selectTrip(trip)"
                >
                  <div class="calendar-trip__name">{{ trip.name }}</div>
                  <div v-if="trip.destination" class="calendar-trip__destination">{{ trip.destination }}</div>
                  <div class="calendar-trip__meta">
                    <span :class="'badge badge--' + trip.status.toLowerCase()">{{ trip.status }}</span>
                    <span class="calendar-trip__dates"><span class="calendar-trip__no-date">No Date</span></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quarter View -->
          <div v-if="calendarViewMode === 'quarter'" class="calendar-view-panel">
            <div v-if="calendarBaseTrips.length === 0" class="empty-state">
              <p class="empty-state__message">No trips found</p>
              <p v-if="statusFilter.length > 0" class="text-muted">
                No trips match your filters.
                <button type="button" class="btn btn--secondary btn--sm" @click="setAllStatuses" style="margin-left: 8px;">Clear filters</button>
              </p>
              <p v-else class="text-muted">Try adjusting your filters or adding a trip</p>
            </div>

          <div v-else class="calendar-view">
            <!-- Year Sections -->
            <div
              v-for="(yearGroup, index) in calendarGroups.years"
              :key="yearGroup.year"
              class="calendar-year"
            >
              <!-- Year Divider (except before first year) -->
              <hr v-if="index > 0" class="calendar-year__divider">

              <!-- Year Header -->
              <div class="calendar-year__header">
                <div class="calendar-year__title-row">
                  <h2 class="calendar-year__title">{{ yearGroup.year }}</h2>
                  <span v-if="yearGroup.year === currentYear" class="calendar-year__chip">This year</span>
                </div>
                <p v-if="yearGroup.year === currentYear + 1" class="calendar-year__future-hint">Next year ideas ‚Äî you can refine later</p>
                <p v-else-if="yearGroup.year >= currentYear + 2" class="calendar-year__future-hint">Future travel ideas</p>
              </div>

              <!-- Year At a Glance insight (quarter view only) -->
              <p v-if="getYearInsight(yearGroup.year)" class="calendar-year__insight">{{ getYearInsight(yearGroup.year) }}</p>

              <!-- Quarters Grid -->
              <div class="calendar-quarters">
                <div
                  v-for="quarter in ['Q1', 'Q2', 'Q3', 'Q4']"
                  :key="quarter"
                  class="calendar-quarter"
                  :class="{
                    'calendar-quarter--empty': yearGroup.quarters[quarter].length === 0,
                    'calendar-quarter--current': yearGroup.year === currentYear && quarter === currentQuarter
                  }"
                >
                  <div class="calendar-quarter__header">
                    <div class="calendar-quarter__title-group">
                      <h3 class="calendar-quarter__title">{{ quarter }}</h3>
                      <span class="calendar-quarter__months">{{ { Q1: 'Jan‚ÄìMar', Q2: 'Apr‚ÄìJun', Q3: 'Jul‚ÄìSep', Q4: 'Oct‚ÄìDec' }[quarter] }}</span>
                    </div>
                    <span v-if="yearGroup.quarters[quarter].length > 0" class="calendar-quarter__count">
                      {{ yearGroup.quarters[quarter].length }} trip{{ yearGroup.quarters[quarter].length !== 1 ? 's' : '' }}
                    </span>
                  </div>

                  <!-- Trip Mini-Cards -->
                  <div v-if="yearGroup.quarters[quarter].length > 0" class="calendar-trips">
                    <div
                      v-for="trip in yearGroup.quarters[quarter]"
                      :key="trip.id"
                      class="calendar-trip"
                      role="button"
                      tabindex="0"
                      @click="selectTrip(trip)"
                      @keydown.enter.prevent="selectTrip(trip)"
                      @keydown.space.prevent="selectTrip(trip)"
                    >
                      <div class="calendar-trip__name">{{ trip.name }}</div>
                      <div v-if="trip.destination" class="calendar-trip__destination">{{ trip.destination }}</div>
                      <div class="calendar-trip__meta">
                        <span :class="'badge badge--' + trip.status.toLowerCase()">
                          {{ trip.status }}
                        </span>
                        <span class="calendar-trip__dates">{{ formatDateRange(trip.startDate, trip.endDate) }}</span>
                      </div>
                    </div>
                  </div>
                  <p v-else class="calendar-quarter__empty">No trips</p>
                </div>
              </div>
            </div>

            <!-- Undated trips (Quarter view ‚Äî same pool as month view) -->
            <div v-if="calendarGroups.noDate.length > 0" class="calendar-nodate-section">
              <hr class="calendar-year__divider">
              <div class="calendar-nodate-header">
                <span class="calendar-nodate-header__title">Undated</span>
                <span class="calendar-quarter__count">
                  {{ calendarGroups.noDate.length }} trip{{ calendarGroups.noDate.length !== 1 ? 's' : '' }}
                </span>
                <button
                  type="button"
                  class="calendar-nodate-viewall btn btn--secondary btn--sm"
                  @click="switchTab('list')"
                  aria-label="View all trips in My Trips tab"
                >View all ‚Üí</button>
              </div>
              <div class="calendar-month-grid">
                <div
                  v-for="trip in calendarGroups.noDate.slice(0, 5)"
                  :key="trip.id"
                  class="calendar-trip"
                  role="button"
                  tabindex="0"
                  :aria-label="trip.name"
                  @click="selectTrip(trip)"
                  @keydown.enter.prevent="selectTrip(trip)"
                  @keydown.space.prevent="selectTrip(trip)"
                >
                  <div class="calendar-trip__name">{{ trip.name }}</div>
                  <div v-if="trip.destination" class="calendar-trip__destination">{{ trip.destination }}</div>
                  <div class="calendar-trip__meta">
                    <span :class="'badge badge--' + trip.status.toLowerCase()">{{ trip.status }}</span>
                    <span class="calendar-trip__dates"><span class="calendar-trip__no-date">No Date</span></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div><!-- end quarter view -->
        </div><!-- end calendar section -->

        <!-- ‚îÄ‚îÄ Journey List View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div v-if="currentView === 'journeys' && tripPageMode === null" class="journey-list-view">

          <!-- Header row: History toggle (left) + New Journey (right) -->
          <div class="journey-list__header">
            <button
              type="button"
              class="history-toggle"
              :class="{ 'history-toggle--active': showJourneyHistory }"
              @click="toggleJourneyHistory"
              :aria-pressed="showJourneyHistory.toString()"
              :aria-label="showJourneyHistory ? 'Hide completed journeys' : 'Show completed journeys'"
            >{{ showJourneyHistory ? 'Hide history' : 'History' }}</button>
            <button type="button" class="btn btn--primary btn--sm" @click="openJourneyModal('create')">
              <span aria-hidden="true">+</span> New Journey
            </button>
          </div>

          <!-- Journey stats row (only shown when there are journeys) -->
          <div class="stats-row" v-if="journeys.length > 0">
            <div class="stats-card">
              <div class="stats-card__label">Total Journeys</div>
              <div class="stats-card__value">{{ journeyStats.total }}</div>
            </div>
            <div class="stats-card">
              <div class="stats-card__label">Active</div>
              <div class="stats-card__value">{{ journeyStats.activeJourneys }}</div>
            </div>
            <div class="stats-card">
              <div class="stats-card__label">Completed</div>
              <div class="stats-card__value">{{ journeyStats.completedJourneys }}</div>
            </div>
            <div class="stats-card">
              <div class="stats-card__label">PLANNED SPEND ({{ currentYear }})</div>
              <div class="stats-card__value">{{ formatCurrency(journeyStats.plannedSpend) }}</div>
              <div v-if="journeyStats.plannedSpend === 0" class="stats-card__hint">Add expenses to see totals.</div>
            </div>
          </div>

          <!-- Explanation -->
          <p class="journey-list__intro">Journeys connect multiple trips into one bigger adventure ‚Äî a road trip, a multi-city visit, or a month abroad. Create a journey, then link your existing trips to see the full itinerary and date range in one place. <span class="journey-list__intro-examples">Try: <em>"Coastal road trip"</em> (San Luis Obispo ‚Üí Santa Barbara ‚Üí Carlsbad) or <em>"Italy 2026"</em> (Rome ‚Üí Florence ‚Üí Venice).</span></p>

          <!-- Empty: no journeys at all -->
          <div v-if="journeys.length === 0" class="empty-state empty-state--inline">
            <p class="empty-state__message">No journeys yet ‚Äî create one to group related trips.</p>
          </div>

          <!-- Empty: journeys exist but all are historical and history is hidden -->
          <div v-else-if="visibleJourneys.length === 0" class="empty-state empty-state--inline">
            <p class="empty-state__message">All journeys are complete.</p>
            <p style="color: var(--text-muted); margin-top: 8px; font-size: 0.875rem;">Enable History above to see them.</p>
          </div>

          <!-- Journey cards -->
          <div v-else class="journey-cards">
            <div
              v-for="journey in visibleJourneys"
              :key="journey.id"
              class="journey-card"
              role="button"
              tabindex="0"
              @click="openJourneyDetail(journey.id)"
              @keydown.enter.prevent="openJourneyDetail(journey.id)"
            >
              <div class="journey-card__name">{{ journey.name }}</div>
              <!-- Date range line: sits just below the name -->
              <div v-if="journeyTripCount(journey.id) > 0" class="journey-card__date-line">
                <span class="journey-card__dates-text">{{ getJourneyDateRange(journey.id).text || 'Trips have no dates yet' }}</span>
                <span v-if="getJourneyDateRange(journey.id).someUndated" class="journey-card__undated-pill">some undated</span>
              </div>
              <!-- Route line: "SLO ‚Üí Santa Barbara ‚Üí Carlsbad" (2+ ordered trips) -->
              <div v-if="getJourneyRoute(journey.id)" class="journey-card__route">{{ getJourneyRoute(journey.id) }}</div>
              <div v-if="journey.description" class="journey-card__desc">{{ journey.description }}</div>
              <!-- Footer: trip count + optional historical badge -->
              <div class="journey-card__footer">
                <span class="journey-card__count">{{ journeyTripCount(journey.id) }} trip{{ journeyTripCount(journey.id) !== 1 ? 's' : '' }}</span>
                <span v-if="isJourneyHistorical(journey.id)" class="journey-card__hist-badge">Done</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ Journey Detail View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div v-if="currentView === 'journey-detail' && selectedJourney && tripPageMode === null" class="journey-detail-view">

          <!-- Header is in main__topbar above. Content starts here. -->
          <div class="overlay-content-inner journey-detail__content">

            <!-- Details card: same visual pattern as Trip Details card -->
            <div class="detail-section section-card section-card--primary">
              <div class="detail-section__header">
                <h3 class="detail-section__title">Details</h3>
                <p v-if="!editingJourneyField" class="subtle-hint" aria-live="off">Tap any field to edit</p>
              </div>
              <div class="detail-section__content">
                <div class="trip-form">

                  <!-- Name: tap-to-edit -->
                  <div class="trip-form__field">
                    <label class="form-label">Name *</label>
                    <div
                      v-if="editingJourneyField !== 'name'"
                      class="trip-field-display"
                      :class="{ 'trip-field-display--placeholder': !selectedJourney.name }"
                      @click="startEditJourneyField('name')"
                      tabindex="0"
                      @keydown.enter.prevent="startEditJourneyField('name')"
                      role="button"
                      aria-label="Edit journey name"
                    >{{ selectedJourney.name || 'Tap to add name‚Ä¶' }}</div>
                    <div v-else>
                      <input
                        type="text"
                        class="input trip-field-input-active"
                        v-model="journeyEditValue"
                        @blur="saveJourneyField"
                        @keydown.enter.prevent="saveJourneyField"
                        @keydown.escape.stop.prevent="editingJourneyField = null"
                        placeholder="Journey name"
                        ref="journeyNameInput"
                      >
                    </div>
                  </div>

                  <!-- Description: tap-to-edit textarea -->
                  <div class="trip-form__field">
                    <label class="form-label">Description</label>
                    <div
                      v-if="editingJourneyField !== 'description'"
                      class="trip-field-display"
                      :class="{ 'trip-field-display--placeholder': !selectedJourney.description }"
                      @click="startEditJourneyField('description')"
                      tabindex="0"
                      @keydown.enter.prevent="startEditJourneyField('description')"
                      role="button"
                      aria-label="Edit journey description"
                      style="white-space: pre-line;"
                    >{{ selectedJourney.description || 'Tap to add a description‚Ä¶' }}</div>
                    <div v-else>
                      <textarea
                        class="textarea trip-field-input-active"
                        v-model="journeyEditValue"
                        @blur="saveJourneyField"
                        @keydown.escape.stop.prevent="editingJourneyField = null"
                        placeholder="Description (optional)"
                        rows="3"
                        ref="journeyDescInput"
                      ></textarea>
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <!-- Date range: simple row below Details card -->
            <div v-if="journeyTrips.length > 0 && getJourneyDateRange(selectedJourney.id).text" class="journey-detail__date-row">
              <span class="journey-detail__dates-text">{{ getJourneyDateRange(selectedJourney.id).text }}</span>
              <span v-if="getJourneyDateRange(selectedJourney.id).someUndated" class="journey-card__undated-pill">some undated</span>
            </div>

            <!-- Trip flow (ordered list) -->
            <div class="journey-detail__section">
              <div class="journey-detail__section-header">
                <h3 class="journey-detail__section-title">Trips ({{ journeyTrips.length }})</h3>
                <div class="journey-detail__section-header-right">
                  <span v-if="journeyTrips.length > 1" class="journey-drag-hint--inline" aria-hidden="true">‚†ø Drag to reorder (or use ‚Üë ‚Üì)</span>
                  <button type="button" class="btn btn--secondary btn--sm" @click="openJourneyModal('add-trip')">
                    + Add Trip
                  </button>
                </div>
              </div>

              <!-- Empty state for trips -->
              <div v-if="journeyTrips.length === 0" class="empty-state empty-state--inline" style="margin-top: 12px;">
                <p class="empty-state__message">No trips linked yet.</p>
                <p style="color: var(--text-muted); margin-top: 4px;">Use "Add Trip" to link existing trips to this journey.</p>
              </div>

              <!-- Trip list -->
              <template v-if="journeyTrips.length > 0">
                <div class="journey-trip-list">
                <div
                  v-for="(trip, index) in journeyTrips"
                  :key="trip.id"
                  class="journey-trip-item"
                  draggable="true"
                  @dragstart="journeyDragStart(trip.id, index, $event)"
                  @dragover="journeyDragOver(index, $event)"
                  @drop="journeyDrop(index, $event)"
                  @dragend="journeyDragEnd"
                  :class="{ 'journey-trip-item--dragging': journeyDragState && journeyDragState.tripId === trip.id }"
                >
                  <div class="journey-trip-item__grip" aria-hidden="true" title="Drag to reorder">‚†ø</div>
                  <div class="journey-trip-item__order">{{ index + 1 }}</div>
                  <div class="journey-trip-item__info" @click="selectTrip(trip)" role="button" tabindex="0" @keydown.enter.prevent="selectTrip(trip)">
                    <div class="journey-trip-item__name">{{ trip.name }}</div>
                    <div v-if="trip.destination" class="journey-trip-item__dest">{{ trip.destination }}</div>
                    <div class="journey-trip-item__meta">
                      <span :class="'badge badge--' + trip.status.toLowerCase()">{{ trip.status }}</span>
                      <span v-if="trip.startDate" class="journey-trip-item__dates">{{ formatDateRange(trip.startDate, trip.endDate) }}</span>
                    </div>
                  </div>
                  <div class="journey-trip-item__actions">
                    <button type="button" class="btn btn--icon btn--sm" @click="moveJourneyTrip(index, -1)" :disabled="index === 0" title="Move up" aria-label="Move trip up">‚Üë</button>
                    <button type="button" class="btn btn--icon btn--sm" @click="moveJourneyTrip(index, 1)" :disabled="index === journeyTrips.length - 1" title="Move down" aria-label="Move trip down">‚Üì</button>
                    <button type="button" class="btn btn--icon btn--sm btn--danger-text" @click="unlinkTripFromJourney(trip.id)" title="Remove from journey" aria-label="Remove trip from journey">‚úï</button>
                  </div>
                </div>
              </div><!-- /.journey-trip-list -->
              </template><!-- /v-if trips.length > 0 -->
            </div><!-- /.journey-detail__section -->

          </div><!-- /.overlay-content-inner -->
        </div><!-- /.journey-detail-view -->

        <!-- ‚îÄ‚îÄ Help Fallback Modal (popup blocked or file:// and no help.html) ‚îÄ‚îÄ -->
        <Teleport to="body">
          <div
            v-if="showHelpFallbackModal"
            class="modal-overlay"
            @click.self="showHelpFallbackModal = false"
            aria-hidden="false"
          >
            <div
              class="modal"
              role="dialog"
              aria-modal="true"
              aria-labelledby="help-fallback-modal-title"
              @keydown.escape.stop.prevent="showHelpFallbackModal = false"
            >
              <div class="modal__header">
                <h3 id="help-fallback-modal-title" class="modal__title">Help &amp; Documentation</h3>
              </div>
              <div class="modal__body">
                <p>To enable Help, add a file named <strong>help.html</strong> in the same folder as <strong>index.html</strong>.</p>
                <p style="margin-top: 8px;">If your browser blocked the new tab, allow popups for this site and try again.</p>
              </div>
              <div class="modal__footer">
                <button type="button" class="btn btn--primary btn--sm" @click="showHelpFallbackModal = false">Close</button>
              </div>
            </div>
          </div>
        </Teleport>

        <!-- ‚îÄ‚îÄ First-run Onboarding Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <Teleport to="body">
          <div
            v-if="showOnboarding"
            class="onboarding-backdrop"
            @click.self="dismissOnboarding"
            aria-hidden="false"
          >
            <div
              class="onboarding-modal"
              role="dialog"
              aria-modal="true"
              aria-labelledby="onboarding-title"
              @keydown.escape.stop.prevent="dismissOnboarding"
            >
              <!-- Icon -->
              <div class="onboarding-modal__icon" aria-hidden="true">‚úàÔ∏è</div>

              <!-- Heading -->
              <h2 id="onboarding-title" class="onboarding-modal__title">Welcome to Travel Hub</h2>

              <!-- Mission statement (exact wording) -->
              <p class="onboarding-modal__mission">Plan your year in trips, not lists. See how your time fits together.</p>

              <!-- Explanation -->
              <p class="onboarding-modal__desc">Capture ideas quickly. Add dates when you're ready. See your year at a glance.</p>

              <!-- 3-step guide -->
              <ol class="onboarding-modal__steps">
                <li>
                  <span class="onboarding-modal__step-num" aria-hidden="true">1</span>
                  <div class="onboarding-modal__step-body">
                    <strong>Add an idea</strong> ‚Äî start by naming a trip (no details needed yet)
                    <p class="onboarding-modal__step-sub">After you name it, we'll help you add destination + dates when you're ready.</p>
                  </div>
                </li>
                <li>
                  <span class="onboarding-modal__step-num" aria-hidden="true">2</span>
                  <div class="onboarding-modal__step-body">
                    <strong>Set dates and details</strong> ‚Äî tap any trip card to open and fill in
                  </div>
                </li>
                <li>
                  <span class="onboarding-modal__step-num" aria-hidden="true">3</span>
                  <div class="onboarding-modal__step-body">
                    <strong>See how it fits</strong> ‚Äî switch to Calendar to see your whole year at once. (Group related trips into a Journey anytime.)
                  </div>
                </li>
              </ol>

              <!-- CTA -->
              <p class="onboarding-modal__cta">Ready? Close this and add your first trip idea.</p>

              <!-- Footer -->
              <div class="onboarding-modal__footer">
                <button
                  type="button"
                  class="btn btn--primary onboarding-modal__btn"
                  @click="dismissOnboarding"
                  autofocus
                >Start Planning</button>
              </div>
            </div>
          </div>
        </Teleport>

        <!-- ‚îÄ‚îÄ Journey Modal (Create / Select) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <Teleport to="body">
          <div v-if="showJourneyModal" class="overlay-backdrop overlay-backdrop--journey" @click.self="closeJourneyModal">
            <div class="journey-modal" role="dialog" aria-modal="true" :aria-label="journeyModalMode === 'create' ? 'Create Journey' : 'Add Trip to Journey'">

              <!-- Create mode -->
              <template v-if="journeyModalMode === 'create'">
                <h3 class="journey-modal__title">New Journey</h3>
                <div class="journey-modal__field">
                  <label class="form-label">Name</label>
                  <input
                    type="text"
                    class="input"
                    v-model="journeyForm.name"
                    placeholder="e.g., Europe 2026"
                    @keydown.enter.prevent="createJourney"
                    ref="journeyNameInput"
                  >
                  <div v-if="journeyFormError" class="inline-error">{{ journeyFormError }}</div>
                </div>
                <div class="journey-modal__field">
                  <label class="form-label">Description <span class="form-label__hint">(optional)</span></label>
                  <input
                    type="text"
                    class="input"
                    v-model="journeyForm.description"
                    placeholder="Brief description‚Ä¶"
                  >
                </div>
                <div class="journey-modal__actions">
                  <!-- Back to picker if invoked from a trip context -->
                  <button
                    v-if="journeyModalTripId"
                    type="button"
                    class="btn btn--secondary btn--sm"
                    @click="journeyModalMode = 'select'"
                    style="margin-right: auto;"
                  >‚Üê Back</button>
                  <button type="button" class="btn btn--secondary btn--sm" @click="closeJourneyModal">Cancel</button>
                  <button type="button" class="btn btn--primary btn--sm" @click="createJourney">Create Journey</button>
                </div>
              </template>

              <!-- Select mode (link trip to existing journey ‚Äî from Trip overlay) -->
              <template v-else-if="journeyModalMode === 'select'">
                <h3 class="journey-modal__title">Add to Journey</h3>

                <!-- Helper paragraph: always shown, explains what a Journey is -->
                <p class="journey-modal__helper">A Journey is a collection of trips that belong together ‚Äî like a road trip with multiple stops.</p>

                <!-- Search input (always shown; filters the list) -->
                <input
                  type="search"
                  class="input journey-modal__search"
                  v-model="journeySearchQuery"
                  placeholder="Search journeys‚Ä¶"
                  ref="journeySearchInput"
                  @keydown.escape.stop.prevent="closeJourneyModal"
                  autocomplete="off"
                  autocorrect="off"
                  spellcheck="false"
                >

                <!-- No journeys at all: prompt to create -->
                <div v-if="journeys.length === 0" class="journey-modal__empty">
                  <p style="color: var(--text-muted); margin-bottom: 12px;">No journeys yet ‚Äî create one to group related trips.</p>
                  <button type="button" class="btn btn--primary btn--sm" @click="journeyModalMode = 'create'">Create a Journey</button>
                </div>

                <!-- No search results -->
                <div v-else-if="filteredJourneysForPicker.length === 0" class="journey-modal__empty">
                  <p style="color: var(--text-muted);">No journeys match "{{ journeySearchQuery }}"</p>
                </div>

                <!-- Journey list (filtered) -->
                <div v-else class="journey-modal__list">
                  <div
                    v-for="j in filteredJourneysForPicker"
                    :key="j.id"
                    class="journey-modal__option"
                    role="button"
                    tabindex="0"
                    @click="selectJourneyForTrip(j.id)"
                    @keydown.enter.prevent="selectJourneyForTrip(j.id)"
                  >
                    <div class="journey-modal__option-name">{{ j.name }}</div>
                    <div class="journey-modal__option-count">{{ journeyTripCount(j.id) }} trip{{ journeyTripCount(j.id) !== 1 ? 's' : '' }}</div>
                  </div>
                  <div class="journey-modal__divider"></div>
                  <button type="button" class="journey-modal__create-trip-btn" @click="journeyModalMode = 'create'">
                    + Create New Journey
                  </button>
                </div>

                <!-- Remove from journey (shown only when this trip is currently linked) -->
                <div
                  v-if="journeyModalTripId && trips.some(t => t.id === journeyModalTripId && t.journeyId)"
                  class="journey-modal__remove-section"
                >
                  <button
                    type="button"
                    class="journey-modal__remove-btn"
                    @click="unlinkTripFromJourney(journeyModalTripId); closeJourneyModal()"
                  >Remove from current journey</button>
                </div>

                <div class="journey-modal__actions" style="margin-top: 12px;">
                  <button type="button" class="btn btn--secondary btn--sm" @click="closeJourneyModal">Cancel</button>
                </div>
              </template>

              <!-- Add-trip mode (pick an unlinked trip to add to current journey ‚Äî from Journey Detail) -->
              <template v-else-if="journeyModalMode === 'add-trip'">
                <h3 class="journey-modal__title">Add Trip to {{ selectedJourney ? selectedJourney.name : 'Journey' }}</h3>

                <!-- Search input -->
                <input
                  type="search"
                  class="input journey-modal__search"
                  v-model="addTripSearchQuery"
                  placeholder="Search trips‚Ä¶"
                  ref="addTripSearchInput"
                  @keydown.escape.stop.prevent="closeJourneyModal"
                  autocomplete="off"
                  autocorrect="off"
                  spellcheck="false"
                >

                <!-- No unlinked trips at all: prompt to create -->
                <div v-if="unlinkedTrips.length === 0" class="journey-modal__empty">
                  <p style="color: var(--text-muted); margin-bottom: 12px;">No unlinked trips available.</p>
                  <button type="button" class="btn btn--primary btn--sm" @click="createTripFromJourney">+ Create new trip</button>
                </div>

                <!-- No search results -->
                <div v-else-if="filteredUnlinkedTrips.length === 0" class="journey-modal__empty">
                  <p style="color: var(--text-muted);">No trips match "{{ addTripSearchQuery }}"</p>
                </div>

                <!-- Unlinked trips list (filtered) -->
                <div v-else class="journey-modal__list">
                  <div
                    v-for="t in filteredUnlinkedTrips"
                    :key="t.id"
                    class="journey-modal__option"
                    role="button"
                    tabindex="0"
                    @click="addTripToCurrentJourney(t.id)"
                    @keydown.enter.prevent="addTripToCurrentJourney(t.id)"
                  >
                    <div class="journey-modal__option-name">{{ t.name }}</div>
                    <div class="journey-modal__option-count">{{ t.destination || 'No destination' }}</div>
                  </div>
                  <div class="journey-modal__divider"></div>
                  <button type="button" class="journey-modal__create-trip-btn" @click="createTripFromJourney">
                    + Create a new trip
                  </button>
                </div>

                <div class="journey-modal__actions" style="margin-top: 12px;">
                  <button type="button" class="btn btn--secondary btn--sm" @click="closeJourneyModal">Cancel</button>
                </div>
              </template>
            </div>
          </div>
        </Teleport>

        <!-- ‚îÄ‚îÄ Search Command Palette (Cmd+K) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <Teleport to="body">
          <div
            v-if="searchPaletteOpen"
            class="search-palette-backdrop"
            @click.self="closeSearchPalette"
          >
            <div
              class="search-palette"
              role="dialog"
              aria-modal="true"
              aria-label="Search trips and journeys"
              @keydown.escape.stop.prevent="closeSearchPalette"
            >
              <!-- Input row -->
              <div class="search-palette__input-row">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="search-palette__icon" aria-hidden="true">
                  <circle cx="6.5" cy="6.5" r="4.5" stroke="currentColor" stroke-width="1.5"/>
                  <path d="M10 10L14 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <input
                  ref="paletteInput"
                  type="text"
                  class="search-palette__input"
                  v-model="searchPaletteQuery"
                  placeholder="Search trips and journeys‚Ä¶"
                  aria-label="Search"
                  autocomplete="off"
                  spellcheck="false"
                >
                <kbd class="search-palette__esc">ESC</kbd>
              </div>

              <!-- States: hint / no results / results -->
              <div v-if="!searchPaletteQuery" class="search-palette__hint">
                Type to search trips and journeys‚Ä¶
              </div>
              <div v-else-if="searchPaletteQuery && !paletteHasResults" class="search-palette__empty">
                No results for "<strong>{{ searchPaletteQuery }}</strong>"
              </div>
              <div v-if="paletteHasResults" class="search-palette__results">
                <!-- Trip results -->
                <div v-if="paletteResults.trips.length > 0" class="search-palette__section">
                  <div class="search-palette__section-label">Trips</div>
                  <button
                    v-for="trip in paletteResults.trips"
                    :key="trip.id"
                    type="button"
                    class="search-palette__result"
                    @click="paletteSelectTrip(trip)"
                  >
                    <div class="search-palette__result-main">
                      <span class="search-palette__result-title">{{ trip.name || 'Untitled trip' }}</span>
                      <span v-if="trip.destination || trip.startDate || trip.endDate" class="search-palette__result-sub">{{ [trip.destination, (trip.startDate || trip.endDate) ? formatDateRange(trip.startDate, trip.endDate) : null].filter(Boolean).join(' ¬∑ ') }}</span>
                    </div>
                    <span class="search-palette__result-badge">Trip</span>
                  </button>
                </div>
                <!-- Journey results -->
                <div v-if="paletteResults.journeys.length > 0" class="search-palette__section">
                  <div class="search-palette__section-label">Journeys</div>
                  <button
                    v-for="journey in paletteResults.journeys"
                    :key="journey.id"
                    type="button"
                    class="search-palette__result"
                    @click="paletteSelectJourney(journey)"
                  >
                    <div class="search-palette__result-main">
                      <span class="search-palette__result-title">{{ journey.name }}</span>
                      <span v-if="journey.description || (journey.tripOrder && journey.tripOrder.length)" class="search-palette__result-sub">{{ journey.description || (journey.tripOrder.length + (journey.tripOrder.length === 1 ? ' trip' : ' trips')) }}</span>
                    </div>
                    <span class="search-palette__result-badge search-palette__result-badge--journey">Journey</span>
                  </button>
                </div>
                <!-- Overflow hint -->
                <div v-if="paletteTotalCount >= 10" class="search-palette__overflow">
                  Keep typing to narrow results
                </div>
              </div>
            </div>
          </div>
        </Teleport>

        <!-- ‚îÄ‚îÄ Export Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <Teleport to="body">
          <div
            v-if="exportPanelOpen"
            class="export-panel-backdrop"
            @click.self="closeExportPanel"
          >
            <div
              class="export-panel"
              role="dialog"
              aria-modal="true"
              aria-label="Export options"
              @keydown.escape.stop.prevent="closeExportPanel"
            >
              <div class="export-panel__header">
                <h2 class="export-panel__title">Export</h2>
                <button type="button" class="export-panel__close" @click="closeExportPanel" aria-label="Close">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
              <p class="export-panel__note">Files are saved to your <strong>Downloads folder</strong>. Your data stays on your device.</p>
              <div class="export-panel__options">

                <!-- ‚îÄ‚îÄ Section: Current trip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                <div class="export-panel__section-label" aria-hidden="true">
                  <span v-if="selectedTrip">{{ selectedTrip.name }}</span>
                  <span v-else>Current trip</span>
                </div>

                <!-- Export this trip (HTML) -->
                <button
                  type="button"
                  class="export-panel__option"
                  :class="{ 'export-panel__option--disabled': !selectedTrip }"
                  :disabled="!selectedTrip"
                  @click="selectedTrip && (exportTripToHTML(), closeExportPanel())"
                >
                  <div class="export-panel__option-icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="2" y="1.5" width="12" height="13" rx="1.5" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M5 5.5h6M5 8h6M5 10.5h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div class="export-panel__option-body">
                    <div class="export-panel__option-title">Export this trip</div>
                    <div class="export-panel__option-desc">
                      <span v-if="selectedTrip">A readable HTML file of this trip.</span>
                      <span v-else class="export-panel__option-disabled-hint">Open a trip to use these options.</span>
                    </div>
                  </div>
                </button>

                <!-- Export calendar file (.ics) -->
                <button
                  type="button"
                  class="export-panel__option"
                  :class="{ 'export-panel__option--disabled': !selectedTrip || (!selectedTrip.startDate && !selectedTrip.endDate) }"
                  :disabled="!selectedTrip || (!selectedTrip.startDate && !selectedTrip.endDate)"
                  @click="selectedTrip && (selectedTrip.startDate || selectedTrip.endDate) && (exportTripToICS(), closeExportPanel())"
                >
                  <div class="export-panel__option-icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="2" y="3" width="12" height="11" rx="1.5" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M5 1.5V4M11 1.5V4M2 6.5h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                      <circle cx="8" cy="10" r="1" fill="currentColor"/>
                    </svg>
                  </div>
                  <div class="export-panel__option-body">
                    <div class="export-panel__option-title">Export calendar file (.ics)</div>
                    <div class="export-panel__option-desc">
                      <span v-if="!selectedTrip" class="export-panel__option-disabled-hint">Open a trip to export a calendar file.</span>
                      <span v-else-if="!selectedTrip.startDate && !selectedTrip.endDate" class="export-panel__option-disabled-hint">Add dates to this trip first.</span>
                      <span v-else>A calendar file you can import into Apple Calendar, Google Calendar, or any calendar app.</span>
                    </div>
                  </div>
                </button>

                <!-- Copy this trip -->
                <button
                  type="button"
                  class="export-panel__option"
                  :class="{ 'export-panel__option--disabled': !selectedTrip }"
                  :disabled="!selectedTrip"
                  @click="selectedTrip && (copyTripSummary(), closeExportPanel())"
                >
                  <div class="export-panel__option-icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="5" y="5" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M3 11V3a1 1 0 011-1h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div class="export-panel__option-body">
                    <div class="export-panel__option-title">Copy this trip</div>
                    <div class="export-panel__option-desc">
                      <span v-if="selectedTrip">Copies this trip as readable text to your clipboard.</span>
                      <span v-else class="export-panel__option-disabled-hint">Open a trip to copy it.</span>
                    </div>
                  </div>
                </button>

                <!-- ‚îÄ‚îÄ Section: All trips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                <div class="export-panel__section-label" aria-hidden="true">All trips</div>

                <!-- Export all trips (HTML) -->
                <button type="button" class="export-panel__option" @click="exportAllTripsToHTML(); closeExportPanel()">
                  <div class="export-panel__option-icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="2" y="1.5" width="12" height="13" rx="1.5" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M5 5.5h6M5 8h6M5 10.5h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div class="export-panel__option-body">
                    <div class="export-panel__option-title">Export all trips</div>
                    <div class="export-panel__option-desc">A readable HTML document you can print or share.</div>
                  </div>
                </button>

                <!-- Copy all trips -->
                <button type="button" class="export-panel__option" @click="copyAllTrips(); closeExportPanel()">
                  <div class="export-panel__option-icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="5" y="5" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M3 11V3a1 1 0 011-1h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div class="export-panel__option-body">
                    <div class="export-panel__option-title">Copy all trips</div>
                    <div class="export-panel__option-desc">Copies all your trip data to your clipboard.</div>
                  </div>
                </button>

              </div>
            </div>
          </div>
        </Teleport>

        <!-- Trip Detail Overlay (full-screen notebook mode) ‚Äî rendered via Teleport to body -->
        <Teleport to="body">
          <div
            v-if="tripPageMode !== null"
            class="overlay-backdrop"
            @click.self="closeTripOverlay"
          >
            <div
              class="overlay-panel"
              role="dialog"
              aria-modal="true"
              aria-label="Trip details"
            >
              <!-- Overlay Header (sticky) -->
              <div class="overlay-header">
                <button
                  ref="overlayBackBtn"
                  type="button"
                  class="overlay-header__back btn btn--secondary btn--sm"
                  @click="closeTripOverlay"
                >{{ tripPageMode === 'create' ? 'Cancel' : '‚Üê Back' }}</button>
                <div class="overlay-header__title" v-if="selectedTrip">
                  <span v-if="tripPageMode === 'create'" class="overlay-header__trip-name">New Trip</span>
                  <span v-else class="overlay-header__trip-name">{{ selectedTrip.name }}</span>
                  <span v-if="tripPageMode === 'edit'" :class="'badge badge--' + (selectedTrip.status || 'planning').toLowerCase()">{{ selectedTrip.status }}</span>
                </div>
                <!-- Create mode: single Create Trip button -->
                <div v-if="tripPageMode === 'create'" class="overlay-header__actions">
                  <button
                    type="button"
                    class="btn btn--primary btn--sm"
                    @click="createTrip"
                  >Create Trip</button>
                </div>
                <!-- Edit mode: action bar -->
                <div v-else class="overlay-header__actions">
                  <button type="button" class="btn btn--danger btn--sm" @click="openDeleteTrip">Delete</button>
                </div>
              </div>

              <!-- Save status strip (beneath sticky header) -->
              <div class="overlay-save-status" v-if="selectedTrip && tripPageMode === 'edit'" aria-live="polite">
                <span v-if="saveStatus === 'saved' && saveStatusVisible" class="overlay-save-status__text overlay-save-status__text--saved">All changes saved ‚úì</span>
                <span v-else-if="saveStatus === 'saving'" class="overlay-save-status__text overlay-save-status__text--saving">Saving‚Ä¶</span>
                <span v-else-if="saveStatus === 'error'" class="overlay-save-status__text overlay-save-status__text--error">‚ö† {{ saveErrorMessage || 'Save failed ‚Äî storage may be full' }}</span>
              </div>

              <!-- Trip summary strip (non-editable, compact) -->
              <div class="overlay-summary-strip" v-if="tripPageMode === 'edit' && selectedTrip && (selectedTrip.destination || selectedTrip.startDate || selectedTrip.endDate || selectedTrip.journey)">
                <span v-if="selectedTrip.destination" class="overlay-summary-strip__item">{{ selectedTrip.destination }}</span>
                <span v-if="selectedTrip.destination && (selectedTrip.startDate || selectedTrip.endDate)" class="overlay-summary-strip__sep" aria-hidden="true">¬∑</span>
                <span v-if="selectedTrip.startDate || selectedTrip.endDate" class="overlay-summary-strip__item">{{ formatDateRange(selectedTrip.startDate, selectedTrip.endDate) }}</span>
                <span v-if="selectedTrip.journey && (selectedTrip.destination || selectedTrip.startDate || selectedTrip.endDate)" class="overlay-summary-strip__sep" aria-hidden="true">¬∑</span>
                <span v-if="selectedTrip.journey" class="overlay-summary-strip__item overlay-summary-strip__item--journey">{{ selectedTrip.journey }}</span>
              </div>

              <!-- Overlay Content (scrollable) -->
              <div class="overlay-content">
                <div class="overlay-content-inner">

          <div class="detail-section section-card section-card--primary">
            <div class="detail-section__header">
              <h3 class="detail-section__title">Details</h3>
              <p v-if="!overlayEditHintShown && tripPageMode === 'edit'" class="subtle-hint" aria-live="off">Tap any field to edit</p>
              <div v-if="createTripError" class="form-error" style="margin-top: 4px;">{{ createTripError }}</div>
            </div>
            <div class="detail-section__content">
              <div class="trip-form">
                <div class="trip-form__row">
                  <!-- Name: tap-to-edit -->
                  <div class="trip-form__field">
                    <label class="form-label">Name *</label>
                    <div
                      v-if="editingTripField !== 'name'"
                      class="trip-field-display"
                      :class="{ 'trip-field-display--placeholder': !selectedTrip.name }"
                      @click="startEditTripField('name')"
                      tabindex="0"
                      @keydown.enter.prevent="startEditTripField('name')"
                      role="button"
                      aria-label="Edit trip name"
                    >{{ selectedTrip.name || 'Tap to add name‚Ä¶' }}</div>
                    <div v-else>
                      <input
                        type="text"
                        class="input trip-field-input-active"
                        v-model="tripFieldDraft"
                        @blur="commitTripField"
                        @keydown.enter.prevent="commitTripField"
                        @keydown.escape.stop.prevent="cancelTripField"
                        placeholder="Trip name"
                      >
                      <div v-if="tripFieldError" class="inline-error">{{ tripFieldError }}</div>
                    </div>
                  </div>

                  <!-- Status: tap-to-edit -->
                  <div class="trip-form__field">
                    <label class="form-label">Status</label>
                    <div
                      v-if="editingTripField !== 'status'"
                      class="trip-field-display"
                      @click="startEditTripField('status')"
                      tabindex="0"
                      @keydown.enter.prevent="startEditTripField('status')"
                      role="button"
                      aria-label="Edit status"
                    >
                      <span :class="'badge badge--' + (selectedTrip.status || 'planning').toLowerCase()">{{ selectedTrip.status || 'Planning' }}</span>
                    </div>
                    <div v-else>
                      <select
                        class="select trip-field-input-active"
                        v-model="tripFieldDraft"
                        @change="commitTripField"
                        @keydown.escape.stop.prevent="cancelTripField"
                      >
                        <option value="Idea">Idea</option>
                        <option value="Planning">Planning</option>
                        <option value="Committed">Committed</option>
                        <option value="Canceled">Canceled</option>
                        <option value="Completed">Completed</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Destination: tap-to-edit -->
                <div class="trip-form__field">
                  <label class="form-label">Destination</label>
                  <div
                    v-if="editingTripField !== 'destination'"
                    class="trip-field-display"
                    :class="{ 'trip-field-display--placeholder': !selectedTrip.destination }"
                    @click="startEditTripField('destination')"
                    tabindex="0"
                    @keydown.enter.prevent="startEditTripField('destination')"
                    role="button"
                    aria-label="Edit destination"
                  >{{ selectedTrip.destination || 'Tap to add destination‚Ä¶' }}</div>
                  <div v-else>
                    <input
                      type="text"
                      class="input trip-field-input-active"
                      v-model="tripFieldDraft"
                      @blur="commitTripField"
                      @keydown.enter.prevent="commitTripField"
                      @keydown.escape.stop.prevent="cancelTripField"
                      placeholder="e.g., Yosemite National Park, CA"
                    >
                    <div v-if="tripFieldError" class="inline-error">{{ tripFieldError }}</div>
                  </div>
                </div>

                <div class="trip-form__row">
                  <!-- Start Date: tap-to-edit -->
                  <div class="trip-form__field">
                    <label class="form-label">Start Date</label>
                    <div
                      v-if="editingTripField !== 'startDate'"
                      class="trip-field-display trip-field-display--with-icon"
                      :class="{ 'trip-field-display--placeholder': !selectedTrip.startDate }"
                      @click="startEditTripField('startDate')"
                      tabindex="0"
                      @keydown.enter.prevent="startEditTripField('startDate')"
                      role="button"
                      aria-label="Edit start date"
                    >
                      <span class="trip-field-display__text">{{ selectedTrip.startDate ? formatDateRange(selectedTrip.startDate, '') : 'No date set' }}</span>
                      <button type="button" class="icon-btn" aria-label="Pick start date" @click.stop.prevent="openDatePicker('startDate')">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="1.5" y="3" width="13" height="11" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M5 1.5V3.5M11 1.5V3.5M1.5 7h13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                      </button>
                    </div>
                    <div v-else>
                      <input
                        type="date"
                        class="input trip-field-input-active"
                        data-date-field="startDate"
                        v-model="tripFieldDraft"
                        @change="commitTripField"
                        @keydown.escape.stop.prevent="cancelTripField"
                      >
                      <div v-if="tripFieldError" class="inline-error">{{ tripFieldError }}</div>
                    </div>
                  </div>

                  <!-- End Date: tap-to-edit -->
                  <div class="trip-form__field">
                    <label class="form-label">End Date</label>
                    <div
                      v-if="editingTripField !== 'endDate'"
                      class="trip-field-display trip-field-display--with-icon"
                      :class="{ 'trip-field-display--placeholder': !selectedTrip.endDate }"
                      @click="startEditTripField('endDate')"
                      tabindex="0"
                      @keydown.enter.prevent="startEditTripField('endDate')"
                      role="button"
                      aria-label="Edit end date"
                    >
                      <span class="trip-field-display__text">{{ selectedTrip.endDate ? formatDateRange(selectedTrip.endDate, '') : 'No date set' }}</span>
                      <button type="button" class="icon-btn" aria-label="Pick end date" @click.stop.prevent="openDatePicker('endDate')">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="1.5" y="3" width="13" height="11" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M5 1.5V3.5M11 1.5V3.5M1.5 7h13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                      </button>
                    </div>
                    <div v-else>
                      <input
                        type="date"
                        class="input trip-field-input-active"
                        data-date-field="endDate"
                        v-model="tripFieldDraft"
                        @change="commitTripField"
                        @keydown.escape.stop.prevent="cancelTripField"
                      >
                      <div v-if="tripFieldError" class="inline-error">{{ tripFieldError }}</div>
                    </div>
                  </div>
                </div>

                <!-- More details toggle (create mode only) -->
                <div v-if="tripPageMode === 'create' && !createMoreDetails" class="create-more-toggle">
                  <button type="button" class="btn btn--secondary btn--sm create-more-toggle__btn" @click="createMoreDetails = true">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: -2px; margin-right: 4px;"><path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    More details
                  </button>
                </div>

                <!-- Journey: progressive disclosure (edit mode only) -->
                <div v-if="tripPageMode !== 'create'" class="trip-journey-disclosure">
                  <template v-if="selectedTrip && selectedTrip.journeyId">
                    <div class="trip-journey-linked">
                      <span class="trip-journey-disclosure__label">Part of:</span>
                      <button
                        type="button"
                        class="trip-journey-linked__name"
                        @click.stop="openJourneyModal('select', selectedTrip.id)"
                        :aria-label="'Journey: ' + (getJourneyName(selectedTrip.journeyId) || selectedTrip.journey) + ' ‚Äî click to change'"
                      >{{ getJourneyName(selectedTrip.journeyId) || selectedTrip.journey }}</button>
                      <button type="button" class="trip-journey-disclosure__action trip-journey-disclosure__action--remove" @click.stop="unlinkTripFromJourney(selectedTrip.id)">Remove</button>
                    </div>
                  </template>
                  <template v-else>
                    <div class="trip-journey-helper">
                      <p class="trip-journey-helper__hint">Journeys link multiple trips into one bigger adventure.</p>
                      <button type="button" class="trip-journey-helper__cta" @click.stop="openJourneyModal('select', selectedTrip.id)">
                        <svg width="13" height="13" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" class="trip-journey-helper__cta-icon">
                          <path d="M2 3h4l2 2h6v8H2V3z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Part of a bigger adventure? Create a Journey
                        <span class="trip-journey-helper__arrow" aria-hidden="true">‚Üí</span>
                      </button>
                      <p class="trip-journey-helper__example">Example: Coastal road trip ‚Äî SLO ‚Üí Santa Barbara ‚Üí San Diego</p>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div>

          <div class="detail-section section-card" :class="{ 'section-card--compact': !selectedTrip.todos || selectedTrip.todos.length === 0 }" v-show="tripPageMode !== 'create' || createMoreDetails">
            <div class="detail-section__header">
              <h3
                class="detail-section__title"
                role="button"
                tabindex="0"
                :aria-expanded="tasksExpanded.toString()"
                @click="tasksExpanded = !tasksExpanded"
                @keydown.enter.prevent="tasksExpanded = !tasksExpanded"
                @keydown.space.prevent="tasksExpanded = !tasksExpanded"
                style="cursor: pointer;"
              >
                Tasks
                <!-- Collapsed summary stat -->
                <span
                  v-if="!tasksExpanded && selectedTrip.todos && selectedTrip.todos.length > 0"
                  class="section-header-stat"
                >{{ selectedTrip.todos.filter(t => t.completed).length }}&thinsp;/&thinsp;{{ selectedTrip.todos.length }} done</span>
                <svg v-if="tasksExpanded" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; margin-left: 8px; vertical-align: middle;">
                  <path d="M4 10L8 6L12 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <svg v-else width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; margin-left: 8px; vertical-align: middle;">
                  <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </h3>
              <div
                v-if="tasksExpanded && (!selectedTrip.todos || selectedTrip.todos.length === 0)"
                class="detail-section__empty-hint"
                aria-live="polite"
              >No tasks yet</div>
              <!-- Subtle tip ‚Äî only when tasks exist and section is open -->
              <span
                v-if="tasksExpanded && selectedTrip.todos && selectedTrip.todos.length > 0"
                class="tasks-tip"
              >Tap to edit ¬∑ check off as you go</span>
            </div>
            <Transition name="fold">
            <div v-show="tasksExpanded" class="detail-section__content">
              <!-- Inline quick-add row -->
              <div class="inline-add-row">
                <input
                  type="text"
                  class="input input--sm inline-add-row__input"
                  v-model="quickAddTaskText"
                  @keydown.enter.prevent="addTaskQuick"
                  @keydown.escape.stop.prevent="quickAddTaskText = ''"
                  placeholder="Add a task‚Ä¶"
                  aria-label="Add a task"
                >
                <button type="button" class="btn btn--primary btn--sm" @click="addTaskQuick">Add</button>
              </div>
              <div v-if="selectedTrip.todos && selectedTrip.todos.length > 0" class="todo-list">
                <div
                  v-for="todo in selectedTrip.todos"
                  :key="todo.id"
                  class="todo-item"
                  :class="{ 'todo-item--editing': editingTodoId === todo.id }"
                >
                  <input
                    type="checkbox"
                    :checked="todo.completed"
                    @change="toggleTodoCompleted(todo)"
                    @click.stop
                    :aria-label="'Mark task ' + todo.title + ' as ' + (todo.completed ? 'incomplete' : 'complete')"
                    class="todo-checkbox"
                  >
                  <!-- Display mode -->
                  <div
                    v-if="editingTodoId !== todo.id"
                    class="todo-content todo-title--editable"
                    :class="{ 'todo-content--completed': todo.completed }"
                    @click="startEditTodoInline(todo)"
                    tabindex="0"
                    @keydown.enter.prevent="startEditTodoInline(todo)"
                    role="button"
                    :aria-label="'Edit task: ' + todo.title"
                  >
                    <div class="todo-title">{{ todo.title }}</div>
                    <template v-if="todo.description">
                      <div
                        class="todo-description"
                        :class="{ 'todo-description--clamped': !expandedTodoNotes[todo.id] }"
                      >{{ todo.description }}</div>
                      <!-- Only show toggle when note might overflow 2 lines -->
                      <button
                        v-if="todo.description.length > 80 || todo.description.includes('\n')"
                        type="button"
                        class="todo-desc-toggle"
                        @click.stop="expandedTodoNotes[todo.id] = !expandedTodoNotes[todo.id]"
                      >{{ expandedTodoNotes[todo.id] ? 'less' : 'more' }}</button>
                    </template>
                    <button v-if="!todo.description" type="button" class="todo-add-note-btn" @click.stop="startEditTodoInline(todo)" title="Add note">+ note</button>
                  </div>
                  <!-- Inline edit mode -->
                  <div v-else class="todo-content todo-inline-edit">
                    <input
                      type="text"
                      class="input todo-title-input"
                      v-model="todoDraft.title"
                      @keydown.enter.prevent="commitTodoInline"
                      @keydown.escape.stop.prevent="cancelTodoInline"
                      placeholder="Task title"
                    >
                    <textarea
                      class="textarea todo-desc-input"
                      v-model="todoDraft.description"
                      @keydown.escape.stop.prevent="cancelTodoInline"
                      placeholder="Description (optional)"
                      rows="2"
                    ></textarea>
                    <div class="todo-inline-actions">
                      <button type="button" class="btn-icon btn-icon--success" @click.stop="commitTodoInline" title="Done" aria-label="Save task">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M2.5 8L6.5 12L13.5 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </button>
                      <button type="button" class="btn-icon" @click.stop="cancelTodoInline" title="Cancel" aria-label="Cancel edit">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="todo-actions">
                    <button type="button" class="btn-icon btn-icon--danger" @click.stop="openDeleteTodo(todo)" aria-label="Delete task">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 4H14M5 4V2.5C5 2.22386 5.22386 2 5.5 2H10.5C10.7761 2 11 2.22386 11 2.5V4M6.5 7.5V11.5M9.5 7.5V11.5M3.5 4L4 13.5C4 13.7761 4.22386 14 4.5 14H11.5C11.7761 14 12 13.7761 12 13.5L12.5 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            </Transition>
          </div>

          <div class="detail-section section-card" :class="{ 'section-card--compact': !selectedTrip.expenses || selectedTrip.expenses.length === 0 }" v-show="tripPageMode !== 'create' || createMoreDetails">
            <div class="detail-section__header">
              <h3
                class="detail-section__title"
                role="button"
                tabindex="0"
                :aria-expanded="expensesExpanded.toString()"
                @click="expensesExpanded = !expensesExpanded"
                @keydown.enter.prevent="expensesExpanded = !expensesExpanded"
                @keydown.space.prevent="expensesExpanded = !expensesExpanded"
                style="cursor: pointer;"
              >
                Expenses
                <!-- Collapsed summary stat -->
                <span
                  v-if="!expensesExpanded && selectedTrip.expenses && selectedTrip.expenses.length > 0"
                  class="section-header-stat"
                >{{ selectedTrip.expenses.length }} expense{{ selectedTrip.expenses.length !== 1 ? 's' : '' }}<template v-if="selectedTrip.expenses.reduce((s,e)=>s+(+e.amount||0),0) > 0">&thinsp;¬∑&thinsp;{{ formatCurrency(selectedTrip.expenses.reduce((s,e)=>s+(+e.amount||0),0)) }}</template></span>
                <svg v-if="expensesExpanded" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; margin-left: 8px; vertical-align: middle;">
                  <path d="M4 10L8 6L12 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <svg v-else width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; margin-left: 8px; vertical-align: middle;">
                  <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </h3>
              <div
                v-if="expensesExpanded && (!selectedTrip.expenses || selectedTrip.expenses.length === 0)"
                class="detail-section__empty-hint"
                aria-live="polite"
              >No expenses ‚Äî only if you're budgeting or tracking</div>
            </div>
            <Transition name="fold">
            <div v-show="expensesExpanded" class="detail-section__content">
              <!-- Inline quick-add row for expenses -->
              <div class="inline-add-row inline-add-row--expense">
                <input
                  type="text"
                  class="input input--sm inline-add-row__input"
                  v-model="quickAddExpenseTitle"
                  @keydown.escape.stop.prevent="quickAddExpenseTitle = ''; quickAddExpenseAmount = ''; quickAddExpenseCategory = ''; quickAddExpenseError = ''"
                  placeholder="Expense title"
                  aria-label="Expense title"
                >
                <input
                  type="number"
                  class="input input--sm inline-add-row__amount"
                  v-model="quickAddExpenseAmount"
                  @keydown.enter.prevent="addExpenseQuick"
                  @keydown.escape.stop.prevent="quickAddExpenseTitle = ''; quickAddExpenseAmount = ''; quickAddExpenseCategory = ''; quickAddExpenseError = ''"
                  placeholder="$0.00"
                  min="0"
                  step="0.01"
                  aria-label="Amount"
                >
                <input
                  type="text"
                  class="input input--sm inline-add-row__category"
                  v-model="quickAddExpenseCategory"
                  :list="isIOSDevice ? null : 'expense-category-list'"
                  @keydown.enter.prevent="addExpenseQuick"
                  @keydown.escape.stop.prevent="quickAddExpenseTitle = ''; quickAddExpenseAmount = ''; quickAddExpenseCategory = ''; quickAddExpenseError = ''"
                  placeholder="Category"
                  aria-label="Category"
                >
                <datalist id="expense-category-list">
                  <option value="Lodging">
                  <option value="Flights">
                  <option value="Transportation">
                  <option value="Food">
                  <option value="Activities">
                  <option value="Tickets">
                  <option value="Gear">
                  <option value="Fees">
                  <option value="Other">
                </datalist>
                <button type="button" class="btn btn--primary btn--sm" @click="addExpenseQuick">Add</button>
                <div v-if="quickAddExpenseError" class="inline-error inline-error--compact" style="width: 100%;">{{ quickAddExpenseError }}</div>
              </div>
              <div v-if="selectedTrip.expenses && selectedTrip.expenses.length > 0">
                <div class="expense-list">
                  <div
                    v-for="expense in selectedTrip.expenses"
                    :key="expense.id"
                    class="expense-item"
                    :class="{ 'expense-item--editing': editingExpenseId === expense.id }"
                  >
                    <!-- Display mode: tap anywhere on content to edit -->
                    <div
                      v-if="editingExpenseId !== expense.id"
                      class="expense-content expense-content--editable"
                      @click="startEditExpenseInline(expense)"
                      tabindex="0"
                      @keydown.enter.prevent="startEditExpenseInline(expense)"
                      role="button"
                      :aria-label="'Edit expense: ' + expense.title"
                    >
                      <div class="expense-header">
                        <div class="expense-title">{{ expense.title }}</div>
                        <div class="expense-amount">{{ formatCurrency(expense.amount) }}</div>
                      </div>
                      <div class="expense-meta">
                        <span class="badge badge--secondary">{{ expense.category }}</span>
                        <span v-if="expense.description" class="expense-description">{{ expense.description }}</span>
                      </div>
                    </div>
                    <!-- Inline edit mode: expanded fields -->
                    <div v-else class="expense-inline-edit">
                      <div class="expense-inline-edit__row">
                        <div class="expense-inline-edit__field">
                          <label class="form-label">Title</label>
                          <input
                            type="text"
                            class="input trip-field-input-active"
                            v-model="expenseDraft.title"
                            @keydown.escape.stop.prevent="cancelExpenseInline"
                            placeholder="Expense title"
                          >
                        </div>
                        <div class="expense-inline-edit__field">
                          <label class="form-label">Amount ($)</label>
                          <input
                            type="number"
                            class="input"
                            v-model="expenseDraft.amount"
                            @keydown.escape.stop.prevent="cancelExpenseInline"
                            placeholder="0.00"
                            min="0"
                            step="0.01"
                          >
                        </div>
                      </div>
                      <div class="expense-inline-edit__field">
                        <label class="form-label">Category</label>
                        <input
                          type="text"
                          class="input"
                          v-model="expenseDraft.category"
                          :list="isIOSDevice ? null : 'expense-category-list'"
                          @keydown.escape.stop.prevent="cancelExpenseInline"
                          placeholder="Category"
                        >
                      </div>
                      <div v-if="expenseDraftError" class="inline-error">{{ expenseDraftError }}</div>
                      <div class="expense-inline-edit__actions">
                        <button type="button" class="btn-icon btn-icon--success" @click.stop="commitExpenseInline" title="Save" aria-label="Save expense">
                          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2.5 8L6.5 12L13.5 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                        <button type="button" class="btn-icon" @click.stop="cancelExpenseInline" title="Cancel" aria-label="Cancel edit">
                          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                    <!-- Delete button always visible -->
                    <div class="expense-actions">
                      <button type="button" class="btn-icon btn-icon--danger" @click.stop="openDeleteExpense(expense)" aria-label="Delete expense">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M2 4H3.33333H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M5.33333 4.00004V2.66671C5.33333 2.31309 5.47381 1.97395 5.72386 1.7239C5.97391 1.47385 6.31304 1.33337 6.66667 1.33337H9.33333C9.68696 1.33337 10.0261 1.47485 10.2761 1.7239C10.5262 1.97395 10.6667 2.31309 10.6667 2.66671V4.00004M12.6667 4.00004V13.3334C12.6667 13.687 12.5262 14.0261 12.2761 14.2762C12.0261 14.5262 11.687 14.6667 11.3333 14.6667H4.66667C4.31304 14.6667 3.97391 14.5262 3.72386 14.2762C3.47381 14.0261 3.33333 13.687 3.33333 13.3334V4.00004H12.6667Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="expense-total">
                  <strong>Total Budget:</strong> {{ formatCurrency(computeTripMeta(selectedTrip).totalBudget) }}
                </div>
              </div>
            </div>
            </Transition>
          </div>

          <div class="detail-section section-card" v-show="tripPageMode !== 'create' || createMoreDetails">
            <div class="detail-section__header">
              <h3 class="detail-section__title">Notes</h3>
            </div>
            <div class="detail-section__content">
              <!-- Display mode: linkified, tap to edit -->
              <div
                v-if="!notesEditMode"
                class="textarea textarea--notebook notes-display"
                :class="{ 'notes-display--empty': !selectedTrip.notes }"
                @click="if ($event.target.tagName !== 'A') { notesEditMode = true; $nextTick(() => $refs.notesTextarea?.focus()); }"
                role="button"
                tabindex="0"
                @keydown.enter.prevent="notesEditMode = true; $nextTick(() => $refs.notesTextarea?.focus())"
                aria-label="Edit notes"
                v-html="selectedTrip.notes ? linkifyNotes(selectedTrip.notes) : '<span class=\'notes-display__placeholder\'>Notes are optional ‚Äî ideas, links, anything‚Ä¶</span>'"
              ></div>
              <!-- Edit mode: plain textarea -->
              <textarea
                v-else
                class="textarea textarea--notebook"
                v-model="selectedTrip.notes"
                @input="markUnsaved"
                @blur="notesEditMode = false"
                placeholder="Notes are optional ‚Äî ideas, links, anything‚Ä¶"
                rows="6"
                ref="notesTextarea"
              ></textarea>
            </div>
          </div>

                </div><!-- end overlay-content-inner -->
              </div><!-- end overlay-content -->
            </div><!-- end overlay-panel -->
          </div><!-- end overlay-backdrop -->
        </Teleport>
          </div><!-- end main__content -->
        </main><!-- end main -->
      </div><!-- end main-area -->
    </div><!-- end app-shell -->

    <!-- Toast Container -->
    <div class="toast-container">
      <div
        v-for="toast in toasts"
        :key="toast.id"
        :class="['toast', 'toast--' + toast.type, { 'toast--clickable': toast.onClick }]"
        @click="handleToastClick(toast)"
      >
        {{ toast.message }}
      </div>
    </div>

    <!-- Fixes Details Modal -->
    <div
      v-if="showFixesModal"
      class="modal-overlay"
      @click.self="closeFixesModal"
    >
      <div
        class="modal modal--wide"
        role="dialog"
        aria-modal="true"
        aria-labelledby="fixes-modal-title"
      >
        <div class="modal__header">
          <h3 id="fixes-modal-title" class="modal__title">Import Fixes Applied</h3>
          <button
            type="button"
            class="modal__close"
            @click="closeFixesModal"
            aria-label="Close"
          >
            &times;
          </button>
        </div>
        <div class="modal__body">
          <p class="text-muted mb-4">
            The following issues were automatically fixed during import:
          </p>
          <div class="fixes-list">
            <div v-for="(fix, index) in importFixes" :key="index" class="fixes-list__item">
              {{ fix }}
            </div>
          </div>
        </div>
        <div class="modal__footer">
          <button type="button" class="btn btn--primary btn--sm" @click="closeFixesModal">OK</button>
        </div>
      </div>
    </div>

    <!-- Confirm Unsaved Changes Modal -->
    <div
      v-if="showConfirmModal"
      class="modal-overlay"
      @click.self="cancelDiscard"
    >
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="confirm-modal-title"
      >
        <div class="modal__header">
          <h3 id="confirm-modal-title" class="modal__title">Save Failed</h3>
        </div>
        <div class="modal__body">
          <p>Autosave is failing (storage may be full). Consider making a backup file before continuing.</p>
        </div>
        <div class="modal__footer">
          <button type="button" class="btn btn--secondary btn--sm" @click="cancelDiscard">Stay</button>
          <button type="button" class="btn btn--secondary btn--sm" @click="backupJSON">Backup now</button>
          <button type="button" class="btn btn--danger btn--sm" @click="confirmDiscard">Continue anyway</button>
        </div>
      </div>
    </div>

    <!-- Discard Draft Modal (replaces native confirm() to avoid ESC-hold bug) -->
    <div
      v-if="showDiscardDraftModal"
      class="modal-overlay"
      @click.self="discardDraftCancel"
    >
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="discard-draft-modal-title"
      >
        <div class="modal__header">
          <h3 id="discard-draft-modal-title" class="modal__title">Discard draft?</h3>
        </div>
        <div class="modal__body">
          <p>You have unsaved changes in this trip draft. Discarding will remove everything you've entered.</p>
        </div>
        <div class="modal__footer">
          <button type="button" class="btn btn--secondary btn--sm" @click="discardDraftCancel">Keep editing</button>
          <button type="button" class="btn btn--danger btn--sm" @click="discardDraftConfirm">Discard</button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Todo Modal -->
    <div
      v-if="showTodoModal"
      class="modal-overlay"
      @click.self="closeTodoModal"
    >
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        :aria-labelledby="todoModalMode === 'add' ? 'add-todo-title' : 'edit-todo-title'"
      >
        <div class="modal__header">
          <h3 :id="todoModalMode === 'add' ? 'add-todo-title' : 'edit-todo-title'" class="modal__title">
            {{ todoModalMode === 'add' ? 'Add Task' : 'Edit Task' }}
          </h3>
          <button
            type="button"
            class="modal__close"
            @click="closeTodoModal"
            aria-label="Close"
          >
            &times;
          </button>
        </div>
        <div class="modal__body">
          <div class="form-field">
            <label for="todo-title" class="form-label">Title <span class="text-error">*</span></label>
            <input
              type="text"
              id="todo-title"
              class="input"
              v-model="todoForm.title"
              placeholder="Enter task title"
              @keydown.enter="submitTodoForm"
            >
            <div v-if="todoFormError" class="form-error">{{ todoFormError }}</div>
          </div>
          <div class="form-field">
            <label for="todo-description" class="form-label">Description</label>
            <textarea
              id="todo-description"
              class="textarea"
              v-model="todoForm.description"
              placeholder="Optional details..."
              rows="3"
            ></textarea>
          </div>
        </div>
        <div class="modal__footer">
          <button type="button" class="btn btn--secondary btn--sm" @click="closeTodoModal">Cancel</button>
          <button type="button" class="btn btn--primary btn--sm" @click="submitTodoForm">
            {{ todoModalMode === 'add' ? 'Add Task' : 'Save' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Todo Confirm Modal -->
    <div
      v-if="showDeleteTodoModal"
      class="modal-overlay"
      @click.self="closeDeleteTodoModal"
    >
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="delete-todo-title"
      >
        <div class="modal__header">
          <h3 id="delete-todo-title" class="modal__title">Delete task?</h3>
        </div>
        <div class="modal__body">
          <p>This will permanently remove <strong>{{ deletingTodo ? deletingTodo.title : '' }}</strong>.</p>
        </div>
        <div class="modal__footer">
          <button type="button" class="btn btn--secondary btn--sm" @click="closeDeleteTodoModal">Cancel</button>
          <button type="button" class="btn btn--danger btn--sm" @click="confirmDeleteTodo">Delete</button>
        </div>
      </div>
    </div>

  <!-- Add/Edit Expense Modal -->
  <div
    v-if="showExpenseModal"
    class="modal-overlay"
    @click.self="closeExpenseModal"
  >
    <div
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="expense-modal-title"
    >
      <div class="modal__header">
        <h3 id="expense-modal-title" class="modal__title">{{ expenseModalMode === 'add' ? 'Add Expense' : 'Edit Expense' }}</h3>
        <button
          type="button"
          class="btn btn--secondary btn--icon-only btn--sm"
          @click="closeExpenseModal"
          aria-label="Close"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <form @submit.prevent="submitExpenseForm">
        <div class="modal__body">
          <div class="form-field">
            <label for="expense-title" class="form-label">Title *</label>
            <input
              id="expense-title"
              type="text"
              class="input"
              v-model="expenseForm.title"
              placeholder="e.g., Hotel booking"
            />
            <div v-if="expenseFormErrors.title" class="form-error">{{ expenseFormErrors.title }}</div>
          </div>

          <div class="form-field">
            <label for="expense-amount" class="form-label">Amount *</label>
            <input
              id="expense-amount"
              type="number"
              step="0.01"
              class="input"
              v-model="expenseForm.amount"
              placeholder="0.00"
            />
            <div v-if="expenseFormErrors.amount" class="form-error">{{ expenseFormErrors.amount }}</div>
          </div>

          <div class="form-field">
            <label for="expense-category" class="form-label">Category</label>
            <input
              id="expense-category"
              type="text"
              class="input"
              v-model="expenseForm.category"
              :list="isIOSDevice ? null : 'expense-category-list'"
              placeholder="Category (optional)"
            >
          </div>

          <div class="form-field">
            <label for="expense-description" class="form-label">Description</label>
            <textarea
              id="expense-description"
              class="textarea"
              v-model="expenseForm.description"
              placeholder="Optional notes..."
              rows="3"
            ></textarea>
          </div>
        </div>
        <div class="modal__footer">
          <button type="button" class="btn btn--secondary btn--sm" @click="closeExpenseModal">Cancel</button>
          <button type="submit" class="btn btn--primary btn--sm">{{ expenseModalMode === 'add' ? 'Add Expense' : 'Save Changes' }}</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Expense Confirm Modal -->
  <div
    v-if="showDeleteExpenseModal"
    class="modal-overlay"
    @click.self="closeDeleteExpenseModal"
  >
    <div
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="delete-expense-title"
    >
      <div class="modal__header">
        <h3 id="delete-expense-title" class="modal__title">Delete expense?</h3>
      </div>
      <div class="modal__body">
        <p>This will permanently remove <strong>{{ deletingExpense ? deletingExpense.title : '' }}</strong>.</p>
      </div>
      <div class="modal__footer">
        <button type="button" class="btn btn--secondary btn--sm" @click="closeDeleteExpenseModal">Cancel</button>
        <button type="button" class="btn btn--danger btn--sm" @click="confirmDeleteExpense">Delete</button>
      </div>
    </div>
  </div>

  <!-- Delete Trip Confirm Modal -->
  <div
    v-if="showDeleteTripModal"
    class="modal-overlay"
    @click.self="closeDeleteTripModal"
  >
    <div
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="delete-trip-title"
    >
      <div class="modal__header">
        <h3 id="delete-trip-title" class="modal__title">Delete trip?</h3>
      </div>
      <div class="modal__body">
        <p>This will permanently delete <strong>{{ deletingTrip ? deletingTrip.name : '' }}</strong> and all its tasks and expenses.</p>
      </div>
      <div class="modal__footer">
        <button type="button" class="btn btn--secondary btn--sm" @click="closeDeleteTripModal">Cancel</button>
        <button type="button" class="btn btn--danger btn--sm" @click="confirmDeleteTrip">Delete</button>
      </div>
    </div>
  </div>

  <!-- Clear All Data Confirm Modal -->
  <div
    v-if="showClearDataModal"
    class="modal-overlay"
    @click.self="closeClearDataModal"
  >
    <div
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="clear-data-title"
    >
      <div class="modal__header">
        <h3 id="clear-data-title" class="modal__title">Clear all data?</h3>
      </div>
      <div class="modal__body">
        <p>This will permanently delete all <strong>{{ dataFile.trips.length }} trip{{ dataFile.trips.length !== 1 ? 's' : '' }}</strong> and <strong>{{ dataFile.journeys.length }} journey{{ dataFile.journeys.length !== 1 ? 's' : '' }}</strong>. This cannot be undone.</p>
      </div>
      <div class="modal__footer">
        <button type="button" class="btn btn--secondary btn--sm" @click="closeClearDataModal">Cancel</button>
        <button type="button" class="btn btn--danger btn--sm" @click="confirmClearData">Clear all data</button>
      </div>
    </div>
  </div>

  <!-- Open or Merge Modal -->
  <div
    v-if="showOpenMergeModal"
    class="modal-overlay"
    @click.self="cancelOpenMerge"
  >
    <div
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="open-merge-title"
    >
      <div class="modal__header">
        <h3 id="open-merge-title" class="modal__title">Restore or Merge?</h3>
      </div>
      <div class="modal__body">
        <p>You already have <strong>{{ dataFile.trips.length }} trip{{ dataFile.trips.length !== 1 ? 's' : '' }}</strong> loaded.</p>
        <p style="margin-top: 12px;">Do you want to <strong>replace</strong> them with the new file, or <strong>merge</strong> the new trips with your existing trips?</p>
        <p v-if="pendingImportData && pendingImportData.trips.length > 0" style="margin-top: 12px; font-size: 14px; color: var(--text-muted);">
          The file contains {{ pendingImportData.trips.length }} trip{{ pendingImportData.trips.length !== 1 ? 's' : '' }}.
        </p>
      </div>
      <div class="modal__footer">
        <button type="button" class="btn btn--secondary btn--sm" @click="cancelOpenMerge">Cancel</button>
        <button type="button" class="btn btn--secondary btn--sm" @click="confirmOpenMerge">Merge</button>
        <button type="button" class="btn btn--primary btn--sm" @click="confirmOpenReplace">Restore (Replace)</button>
      </div>
    </div>
  </div>

  <!-- File Location Info Modal -->
  <div
    v-if="showFileLocationInfoModal"
    class="modal-overlay"
    @click.self="closeFileLocationInfo"
  >
    <div
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="file-location-title"
    >
      <div class="modal__header">
        <h3 id="file-location-title" class="modal__title">üìÅ About Backups</h3>
      </div>
      <div class="modal__body">
        <p><strong>Your trips are autosaved to this browser automatically.</strong></p>
        <p style="margin-top: 12px;">When you create a backup file:</p>
        <ul style="margin: 12px 0; padding-left: 24px;">
          <li style="margin: 6px 0;">The backup downloads to your <strong>Downloads folder</strong></li>
          <li style="margin: 6px 0;">You can restore it in any browser using the <strong>Restore</strong> button</li>
          <li style="margin: 6px 0;">The original backup file <strong>will not be updated</strong> ‚Äî each backup is a new file</li>
        </ul>
        <p style="margin-top: 12px; font-size: 14px; color: var(--text-muted);">
          Tip: Consider keeping your backup files in one folder (like Documents) so they're easy to find when you need to restore.
        </p>
      </div>
      <div class="modal__footer">
        <button type="button" class="btn btn--primary btn--sm" @click="closeFileLocationInfo">Got it</button>
      </div>
    </div>
  </div>

  <!-- Floating Backup Button (Mobile) -->
  <button
    v-if="unsavedChanges"
    type="button"
    class="floating-save-btn"
    @click="backupJSON"
    title="Backup trips to file"
  >
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16L21 8V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M17 21V13H7V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M7 3V8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <span>Backup</span>
  </button>
  </div>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- App Script -->
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          theme: 'light',
          currentView: 'list',        // 'list' | 'calendar' | 'journeys' | 'journey-detail'
          calendarViewMode: 'quarter', // 'month' | 'quarter' ‚Äî defaults to quarter; user can toggle
          calendarModeUserToggled: false, // Session-only: true after user manually clicks Month/Quarter toggle
          calendarMonth: null,        // { year, month(0‚Äì11) } ‚Äî set in mounted()
          selectedTripId: null,
          tripPageMode: null,     // null | 'create' | 'edit'
          draftTrip: null,        // Unsaved trip object in create mode
          createTripError: '',    // Validation error for create mode
          createMoreDetails: false, // Progressive reveal toggle in create mode
          searchQuery: '',
          statusFilter: [],    // [] = All; array of active status strings (multi-select)
          showHistory: false,         // My Trips: hides Completed + Canceled by default
          calendarShowHistory: false, // Calendar: independent history toggle
          isHydrating: false,  // True during data load; prevents dirty-state side-effects
          settingsLoaded: false,  // True after loadSettings() completes; prevents backup-reminder flash
          saveStatus: 'saved',    // 'saved' | 'saving' | 'error'
          saveStatusVisible: false,   // Show 'saved' text only briefly after save
          saveErrorMessage: '',   // shown when saveStatus === 'error'
          showBackupHint: false,  // toggles the inline backup explainer panel
          showBackupInfo: false,  // toggles the (i) file-location tooltip in sidebar Data section
          helpAvailable: false,           // true when help.html is reachable (or on file://)
          showHelpFallbackModal: false,   // shown when window.open is blocked or file missing
          showExampleHintNearData: false, // toggles example-data info panel near Load button
          showExampleHintNearBackup: false, // toggles example-data info panel near backup reminder
          exampleHintDismissed: false,    // persisted in localStorage; hides both hint panels
          expandedTodoNotes: {},  // { [todoId]: true } ‚Äî tracks which task notes are expanded
          notesEditMode: false,   // trip Notes section: false=display (linkified), true=edit (textarea)
          editingJourneyField: null,  // 'name' | 'description' | null
          journeyEditValue: '',       // scratch value while editing journey name/description
          sortMode: 'date-soonest', // 'date-soonest', 'date-furthest', 'name-asc', 'name-desc'
          quickAddInput: '', // Quick-add trip input
          tasksExpanded: false, // Tasks section collapsed by default
          expensesExpanded: false, // Expenses section collapsed by default
          showExportMenu: false,
          showFixesModal: false,
          showConfirmModal: false,
          showDiscardDraftModal: false,  // Replaces native confirm() in cancelCreateTrip
          showTodoModal: false,
          showDeleteTodoModal: false,
          todoModalMode: 'add', // 'add' or 'edit'
          editingTodo: null,
          deletingTodo: null,
          todoForm: {
            title: '',
            description: ''
          },
          todoFormError: '',
          showExpenseModal: false,
          showDeleteExpenseModal: false,
          expenseModalMode: 'add', // 'add' or 'edit'
          editingExpense: null,
          deletingExpense: null,
          expenseForm: {
            title: '',
            description: '',
            amount: '',
            category: 'Lodging'
          },
          expenseFormErrors: {
            title: '',
            amount: ''
          },
          showDeleteTripModal: false,
          deletingTrip: null,
          modalTriggerElement: null,
          unsavedChanges: false,
          // Inline (tap-to-edit) state ‚Äî Trip fields
          editingTripField: null,   // null | 'name' | 'destination' | 'startDate' | 'endDate' | 'status'
          tripFieldDraft: '',        // draft value for the field being edited
          tripFieldOriginal: '',     // original value when editing started (for no-change detection)
          tripFieldError: '',        // inline validation error message
          // Inline (tap-to-edit) state ‚Äî Todos
          editingTodoId: null,       // id of todo being inline-edited (null = none)
          todoDraft: { title: '', description: '' }, // draft for inline todo edit
          // Inline (tap-to-edit) state ‚Äî Expenses
          editingExpenseId: null,    // id of expense being inline-edited (null = none)
          expenseDraft: { title: '', amount: '', category: 'Other' },
          expenseDraftError: '',     // inline error for expense amount validation
          toasts: [],
          importFixes: [],
          pendingNavigation: null,
          lastFocusedEl: null,       // element that opened overlay; restored on close
          lastSavedFileName: null,
          showSettingsMenu: false,   // Gear/settings dropdown in header
          sidebarSearchOpen: false,  // Sidebar inline search toggle (legacy ‚Äî kept for compat)
          searchPaletteOpen: false,  // Command palette modal (Cmd+K or Search button)
          searchPaletteQuery: '',    // Live search text inside the command palette
          exportPanelOpen: false,    // Export options panel
          sidebarDataExpanded: false, // Collapsible Data section in sidebar
          recentlyCompletedTripId: null, // Transient ID for trip-completed card animation (cleared after 1200ms)
          calendarAhaVisible: false,     // Session: first-time calendar callout
          showOnboarding: false,         // true only on very first launch (cleared on dismiss)
          // ‚îÄ‚îÄ Overlay notebook UX state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          overlayEditHintShown: false, // Session flag: hides "Tap to edit" hint after first edit
          quickAddTaskText: '',        // Inline quick-add task input
          quickAddExpenseTitle: '',    // Inline quick-add expense title
          quickAddExpenseAmount: '',
          quickAddExpenseCategory: '',   // Inline quick-add expense category
          quickAddExpenseError: '',    // Inline validation error for quick-add expense
          showOpenMergeModal: false,
          showFileLocationInfoModal: false,
          // ‚îÄ‚îÄ Journey state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          selectedJourneyId: null,        // id of journey being viewed/edited
          showJourneyModal: false,        // create/select journey modal
          journeyModalMode: 'create',     // 'create' | 'select'
          journeyModalTripId: null,       // trip id that triggered the modal (for linking)
          journeyForm: { name: '', description: '' },
          journeyFormError: '',
          journeyDragState: null,         // { tripId, fromIndex } during drag reorder
          pendingJourneyLink: null,       // journeyId to auto-link after trip creation
          showJourneyHistory: false,      // Journeys list: show historical journeys (all Completed/Canceled)
          showClearDataModal: false,      // Confirmation modal for "Clear Example Data"
          hasSeenCalendarCard: false,     // One-time flag: hides Case B calendar guidance after first View Calendar click
          hasHighlightedFirstTripCard: false, // One-time flag: first-trip glow+pill triggered once ever (persisted)
          hasSeenCalendarAha: false,      // One-time flag: "this is your year" callout shown once ever (localStorage)
          highlightedTripId: null,        // Id of trip card currently showing "New" glow (session-only, not persisted)
          journeySearchQuery: '',         // search text in journey picker modal (select mode)
          addTripSearchQuery: '',         // search text in add-trip picker modal
          pendingImportData: null,
          pendingImportFileName: null,
          pendingImportFixes: [],
          pendingImportSource: null,  // 'file' | 'example' ‚Äî used to skip lastSavedFileName for example data
          settings: {
            lastBackupDate: null,  // ISO string; null = never backed up
            hasRunBefore: false    // true after first successful mount; prevents auto-load
          },
          dataFile: {
            version: '2.0.0',
            trips: [],
            journeys: [],
            exportDate: null
          }
        };
      },
      watch: {
        // Add/remove beforeunload listener ONLY when autosave has actually failed.
        // With autosave, unsavedChanges is a transient state (1‚Äì2s debounce), not a data-loss risk.
        // Only saveStatus === 'error' (storage full, etc.) warrants blocking tab close.
        saveStatus(newVal) {
          if (newVal === 'error') {
            window.addEventListener('beforeunload', this.handleBeforeUnload);
          } else {
            window.removeEventListener('beforeunload', this.handleBeforeUnload);
          }
        }
      },
      computed: {
        // iOS Safari converts <input list> and <select> to native wheel pickers,
        // blocking free text entry. On iOS we strip the list attribute entirely
        // so the field behaves as a plain text input.
        isIOSDevice() {
          const ua = navigator.userAgent || '';
          return /iPad|iPhone|iPod/.test(ua) ||
            (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        },
        currentYear() {
          return new Date().getFullYear();
        },
        // Current quarter as "Q1"‚Äì"Q4" (used for quarter accent in calendar)
        currentQuarter() {
          return 'Q' + (Math.floor(new Date().getMonth() / 3) + 1);
        },
        // Count of trips whose startDate is in the current calendar year
        tripsThisYear() {
          const cy = this.currentYear;
          return this.trips.filter(t => {
            if (!t.startDate) return false;
            try { return this.parseLocalDate(t.startDate).getFullYear() === cy; } catch(e) { return false; }
          }).length;
        },
        currentViewTitle() {
          if (this.currentView === 'list') return 'My Trips';
          if (this.currentView === 'calendar') return 'Calendar';
          if (this.currentView === 'journeys') return 'My Journeys';
          if (this.currentView === 'journey-detail') {
            const j = this.selectedJourney;
            return j ? j.name : 'Journey';
          }
          return '';
        },
        trips() {
          return this.dataFile.trips || [];
        },
        journeys() {
          return this.dataFile.journeys || [];
        },
        selectedJourney() {
          if (!this.selectedJourneyId) return null;
          return this.journeys.find(j => j.id === this.selectedJourneyId) || null;
        },
        journeyTrips() {
          // Trips linked to the currently selected journey, ordered by journey's tripOrder
          const j = this.selectedJourney;
          if (!j) return [];
          const order = j.tripOrder || [];
          const linked = this.trips.filter(t => t.journeyId === j.id);
          // Sort by tripOrder position; trips not in tripOrder go at end
          return linked.sort((a, b) => {
            const iA = order.indexOf(a.id);
            const iB = order.indexOf(b.id);
            const posA = iA === -1 ? 9999 : iA;
            const posB = iB === -1 ? 9999 : iB;
            return posA - posB;
          });
        },
        unlinkedTrips() {
          // Trips NOT linked to any journey (for the "add trip" picker)
          return this.trips.filter(t => !t.journeyId);
        },
        filteredJourneysForPicker() {
          // Journeys filtered by search query (used in the select modal)
          const q = (this.journeySearchQuery || '').trim().toLowerCase();
          if (!q) return this.journeys;
          return this.journeys.filter(j => j.name.toLowerCase().includes(q));
        },
        filteredUnlinkedTrips() {
          // Unlinked trips filtered by search (used in the add-trip modal)
          const q = (this.addTripSearchQuery || '').trim().toLowerCase();
          if (!q) return this.unlinkedTrips;
          return this.unlinkedTrips.filter(t =>
            t.name.toLowerCase().includes(q) ||
            (t.destination || '').toLowerCase().includes(q)
          );
        },
        visibleJourneys() {
          // Journeys shown in the list (hide historical unless toggle is on)
          if (this.showJourneyHistory) return this.journeys;
          return this.journeys.filter(j => !this.isJourneyHistorical(j.id));
        },
        selectedTrip() {
          if (this.tripPageMode === 'create' && this.draftTrip) return this.draftTrip;
          if (this.selectedTripId === null) return null;
          return this.trips.find(t => t.id === this.selectedTripId) || null;
        },
        filteredTrips() {
          let trips = this.tripsWithMetadata;

          // History filter: hide Completed + Canceled by default
          // Exception: skip when user explicitly selected those statuses or is searching
          const historyStatuses = ['Completed', 'Canceled'];
          const filteringByHistory = this.statusFilter.some(s => historyStatuses.includes(s));
          if (!this.showHistory && !filteringByHistory && !this.searchQuery) {
            trips = trips.filter(trip => !historyStatuses.includes(trip.status));
          }

          // Apply search filter (searches all trips, including history when searchQuery exists)
          if (this.searchQuery) {
            const query = this.searchQuery.toLowerCase();
            trips = trips.filter(trip =>
              trip.name.toLowerCase().includes(query) ||
              (trip.destination && trip.destination.toLowerCase().includes(query))
            );
          }

          // Apply status filter ([] = All, otherwise match any selected status)
          if (this.statusFilter.length > 0) {
            trips = trips.filter(trip => this.statusFilter.includes(trip.status));
          }

          return trips;
        },
        sortedTrips() {
          // Always sort a shallow copy, never mutate original
          const trips = [...this.filteredTrips];

          if (this.sortMode === 'date-soonest' || this.sortMode === 'date-furthest') {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Split trips into categories
            const upcoming = [];
            const past = [];
            const noDate = [];

            trips.forEach(trip => {
              // Determine effective date (startDate else endDate)
              const effectiveDateStr = trip.startDate || trip.endDate;

              if (!effectiveDateStr) {
                noDate.push(trip);
                return;
              }

              const effectiveDate = this.parseLocalDate(effectiveDateStr);
              effectiveDate.setHours(0, 0, 0, 0);

              if (effectiveDate >= today) {
                upcoming.push({ trip, date: effectiveDate.getTime() });
              } else {
                past.push({ trip, date: effectiveDate.getTime() });
              }
            });

            // Sort based on mode
            if (this.sortMode === 'date-soonest') {
              // Upcoming: ascending (closest to today first)
              upcoming.sort((a, b) => a.date - b.date || a.trip.name.localeCompare(b.trip.name));
              // Past: descending (most recent past first)
              past.sort((a, b) => b.date - a.date || a.trip.name.localeCompare(b.trip.name));
            } else {
              // date-furthest
              // Upcoming: descending (furthest future first)
              upcoming.sort((a, b) => b.date - a.date || a.trip.name.localeCompare(b.trip.name));
              // Past: ascending (oldest past first)
              past.sort((a, b) => a.date - b.date || a.trip.name.localeCompare(b.trip.name));
            }

            // Sort noDate by name
            noDate.sort((a, b) => a.name.localeCompare(b.name));

            // Combine: upcoming + past + noDate
            return [
              ...upcoming.map(item => item.trip),
              ...past.map(item => item.trip),
              ...noDate
            ];
          } else if (this.sortMode === 'name-asc' || this.sortMode === 'name-desc') {
            trips.sort((a, b) => {
              const nameA = a.name.toLowerCase();
              const nameB = b.name.toLowerCase();
              if (this.sortMode === 'name-asc') {
                return nameA.localeCompare(nameB);
              } else {
                return nameB.localeCompare(nameA);
              }
            });
          } else if (this.sortMode === 'journey') {
            // Journey mode: sort by journey label then name.
            // Grouping is handled in journeyGroups computed; sortedTrips
            // just keeps a stable order (journey asc, then name asc).
            trips.sort((a, b) => {
              const jA = (a.journey || '').toLowerCase();
              const jB = (b.journey || '').toLowerCase();
              if (jA !== jB) {
                // Unnamed (empty) journeys sort last
                if (!jA) return 1;
                if (!jB) return -1;
                return jA.localeCompare(jB);
              }
              return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
            });
          }

          return trips;
        },
        visibleTrips() {
          // Final dataset used by list rendering
          return this.sortedTrips;
        },
        listGroups() {
          // Group trips for list view with dividers (date-based)
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          const groups = {
            upcoming: [],
            past: [],
            noDate: []
          };

          this.visibleTrips.forEach(trip => {
            const effectiveDateStr = trip.startDate || trip.endDate;
            if (!effectiveDateStr) {
              groups.noDate.push(trip);
              return;
            }
            const effectiveDate = this.parseLocalDate(effectiveDateStr);
            if (!effectiveDate) {
              groups.noDate.push(trip);
              return;
            }
            effectiveDate.setHours(0, 0, 0, 0);
            if (effectiveDate >= today) {
              groups.upcoming.push(trip);
            } else {
              groups.past.push(trip);
            }
          });

          return groups;
        },
        journeyGroups() {
          // Group visible trips by their journey label for journey sort mode.
          // Named journeys sorted alphabetically; ungrouped trips go to "Other".
          const map = {};
          const ungrouped = [];

          this.visibleTrips.forEach(trip => {
            const j = trip.journey ? trip.journey.trim() : '';
            if (j) {
              if (!map[j]) map[j] = [];
              map[j].push(trip);
            } else {
              ungrouped.push(trip);
            }
          });

          const named = Object.keys(map).sort().map(name => ({ label: name, trips: map[name] }));
          if (ungrouped.length > 0) named.push({ label: 'Other', trips: ungrouped });
          return named;
        },
        displayItems() {
          // Flat list of { type, ... } items for the trip list renderer.
          // Supports both date-based grouping and journey grouping.
          const items = [];

          if (this.sortMode === 'journey') {
            this.journeyGroups.forEach(group => {
              items.push({ type: 'journey-header', label: group.label, count: group.trips.length });
              group.trips.forEach(trip => items.push({ type: 'trip', trip }));
            });
          } else {
            this.listGroups.upcoming.forEach(trip => items.push({ type: 'trip', trip }));
            if (this.listGroups.past.length > 0) {
              items.push({ type: 'divider', label: 'Past trips' });
              this.listGroups.past.forEach(trip => items.push({ type: 'trip', trip }));
            }
            if (this.listGroups.noDate.length > 0) {
              items.push({ type: 'divider', label: 'No date set' });
              this.listGroups.noDate.forEach(trip => items.push({ type: 'trip', trip }));
            }
          }

          return items;
        },
        calendarGroups() {
          // Quarter view: group calendarBaseTrips by year and quarter
          const groups = { years: [], noDate: [] };
          const yearMap = {}; // { 2026: { Q1: [...], Q2: [...], Q3: [...], Q4: [...] } }

          this.calendarBaseTrips.forEach(trip => {
            const dateStr = trip.startDate || trip.endDate;
            if (!dateStr) {
              groups.noDate.push(trip);
              return;
            }
            const date = this.parseLocalDate(dateStr);
            if (!date) {
              // Invalid date ‚Äî treat as undated
              groups.noDate.push(trip);
              return;
            }
            const year = date.getFullYear();
            const quarter = Math.floor(date.getMonth() / 3) + 1;
            const quarterKey = `Q${quarter}`;
            if (!yearMap[year]) yearMap[year] = { Q1: [], Q2: [], Q3: [], Q4: [] };
            yearMap[year][quarterKey].push(trip);
          });

          // Sort years ascending (chronological)
          const years = Object.keys(yearMap).map(y => parseInt(y)).sort((a, b) => a - b);
          groups.years = years.map(year => ({ year, quarters: yearMap[year] }));
          return groups;
        },
        // ‚îÄ‚îÄ Calendar: base trip pool ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Calendar uses ALL trips, filtered by calendarShowHistory AND statusFilter.
        // Note: statusFilter is shared with My Trips, so the same chip selection
        // applies to both tabs. My Trips search does NOT affect the calendar.
        calendarBaseTrips() {
          const historyStatuses = ['Completed', 'Canceled'];
          let trips = this.trips;

          // History filter
          if (!this.calendarShowHistory) {
            trips = trips.filter(trip => !historyStatuses.includes(trip.status));
          }

          // Status filter (shared with My Trips)
          if (this.statusFilter.length > 0) {
            trips = trips.filter(trip => this.statusFilter.includes(trip.status));
          }

          return trips;
        },

        calendarMonthLabel() {
          if (!this.calendarMonth) return '';
          const { year, month } = this.calendarMonth;
          return new Date(year, month, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        },

        // ‚îÄ‚îÄ Calendar month trip list (overlap-correct) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Inclusion rules:
        //   Both dates ‚Üí tripStart <= monthEnd AND tripEnd >= monthStart (standard overlap)
        //   Only startDate ‚Üí startDate within month
        //   Only endDate  ‚Üí endDate within month
        //   No dates      ‚Üí excluded (shown in calendarNoDateData instead)
        // Invalid dates treated as undated (excluded from month list).
        calendarMonthData() {
          if (!this.calendarMonth) return [];
          const { year, month } = this.calendarMonth;
          // monthStart = first millisecond of month; monthEnd = last millisecond of month
          const monthStart = new Date(year, month, 1);
          const monthEnd = new Date(year, month + 1, 0, 23, 59, 59, 999);

          const included = this.calendarBaseTrips.filter(trip => {
            if (!trip.startDate && !trip.endDate) return false;
            const start = trip.startDate ? this.parseLocalDate(trip.startDate) : null;
            const end   = trip.endDate   ? this.parseLocalDate(trip.endDate)   : null;
            // Treat invalid stored dates as undated (skip)
            if (trip.startDate && !start) return false;
            if (trip.endDate   && !end)   return false;

            if (start && end) {
              // Standard overlap: trip interval overlaps month interval
              return start <= monthEnd && end >= monthStart;
            }
            if (start) {
              // Only startDate ‚Äî include if it falls within month
              return start >= monthStart && start <= monthEnd;
            }
            if (end) {
              // Only endDate ‚Äî include if it falls within month
              return end >= monthStart && end <= monthEnd;
            }
            return false;
          });

          // Sort by effective start date (startDate else endDate), then name
          return included.sort((a, b) => {
            const aDate = this.parseLocalDate(a.startDate || a.endDate);
            const bDate = this.parseLocalDate(b.startDate || b.endDate);
            if (aDate && bDate) {
              const diff = aDate.getTime() - bDate.getTime();
              if (diff !== 0) return diff;
            }
            if (aDate && !bDate) return -1;
            if (!aDate && bDate) return 1;
            return a.name.localeCompare(b.name);
          });
        },

        // Trips with no start or end date ‚Äî shown in undated section (calendar-filtered)
        calendarNoDateData() {
          const undated = this.calendarBaseTrips.filter(trip => !trip.startDate && !trip.endDate);
          return undated.sort((a, b) => a.name.localeCompare(b.name));
        },
        tripsWithMetadata() {
          return this.trips.map(trip => {
            const meta = this.computeTripMeta(trip);
            return { ...trip, ...meta };
          });
        },
        stats() {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const cy = this.currentYear;

          // Planned Spend: active (non-completed/canceled) trips whose startDate falls in current year
          const totalBudget = this.visibleTrips.reduce((sum, trip) => {
            if (trip.status === 'Completed' || trip.status === 'Canceled') return sum;
            const startStr = trip.startDate;
            if (!startStr) return sum; // undated trips excluded
            const startYear = this.parseLocalDate(startStr).getFullYear();
            if (startYear !== cy) return sum; // only trips starting this year
            const expenses = trip.expenses || [];
            const tripTotal = expenses.reduce((tripSum, exp) => tripSum + this.safeParseNumber(exp.amount), 0);
            return sum + tripTotal;
          }, 0);

          return {
            total: this.visibleTrips.length,
            upcoming: this.visibleTrips.filter(trip => {
              if (!trip.startDate) return false;
              const start = this.parseLocalDate(trip.startDate);
              return start >= today && trip.status !== 'Canceled' && trip.status !== 'Completed';
            }).length,
            completed: this.visibleTrips.filter(trip => trip.status === 'Completed').length,
            budget: totalBudget
          };
        },
        // True when user has never backed up OR last backup was >30 days ago
        shouldShowBackupReminder() {
          // Wait until settings are fully loaded to prevent flash on page load
          if (!this.settingsLoaded) return false;
          // Don't show on very first visit (user has no data worth backing up)
          if (!this.settings.hasRunBefore) return false;
          if (!this.settings.lastBackupDate) return true;
          const last = new Date(this.settings.lastBackupDate);
          const now = new Date();
          return (now - last) / (1000 * 60 * 60 * 24) > 30;
        },
        // ‚îÄ‚îÄ Journeys page stats row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        journeyStats() {
          const cy = this.currentYear;
          const journeyIds = new Set((this.dataFile.journeys || []).map(j => j.id));
          const total = (this.dataFile.journeys || []).length;
          // Active = has at least one trip that is not Completed/Canceled
          const activeJourneys = (this.dataFile.journeys || []).filter(j => {
            return (this.dataFile.trips || []).some(t =>
              t.journeyId === j.id && t.status !== 'Completed' && t.status !== 'Canceled'
            );
          }).length;
          // Completed journeys = all linked trips are Completed or Canceled (and journey has at least one trip)
          const completedJourneys = (this.dataFile.journeys || []).filter(j => {
            const jTrips = (this.dataFile.trips || []).filter(t => t.journeyId === j.id);
            return jTrips.length > 0 && jTrips.every(t => t.status === 'Completed' || t.status === 'Canceled');
          }).length;
          // Planned spend = journey-linked active trips whose startDate falls in current year
          const plannedSpend = (this.dataFile.trips || []).reduce((sum, trip) => {
            if (!trip.journeyId || !journeyIds.has(trip.journeyId)) return sum;
            if (trip.status === 'Completed' || trip.status === 'Canceled') return sum;
            const startStr = trip.startDate;
            if (!startStr) return sum;
            const startYear = this.parseLocalDate(startStr).getFullYear();
            if (startYear !== cy) return sum;
            const expenses = trip.expenses || [];
            return sum + expenses.reduce((s, exp) => s + this.safeParseNumber(exp.amount), 0);
          }, 0);
          return { total, activeJourneys, completedJourneys, plannedSpend };
        },
        // ‚îÄ‚îÄ Command palette search results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        paletteResults() {
          const q = this.searchPaletteQuery.trim().toLowerCase();
          if (!q) return { trips: [], journeys: [] };
          const trips = (this.dataFile.trips || [])
            .filter(t =>
              (t.name || '').toLowerCase().includes(q) ||
              (t.destination || '').toLowerCase().includes(q) ||
              (t.notes || '').toLowerCase().includes(q)
            )
            .slice(0, 10);
          const journeys = (this.dataFile.journeys || [])
            .filter(j =>
              (j.name || '').toLowerCase().includes(q) ||
              (j.description || '').toLowerCase().includes(q)
            )
            .slice(0, 10);
          return { trips, journeys };
        },
        paletteHasResults() {
          return this.paletteResults.trips.length > 0 || this.paletteResults.journeys.length > 0;
        },
        paletteTotalCount() {
          return this.paletteResults.trips.length + this.paletteResults.journeys.length;
        }
      },
      methods: {
        // ‚îÄ‚îÄ Tab navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        switchTab(view) {
          // Close overlay first so the tab switch feels clean
          if (this.tripPageMode !== null) {
            this.closeTripOverlay();
          }
          // Clear journey state when navigating away from journey detail
          if (view !== 'journey-detail') {
            this.selectedJourneyId = null;
          }

          // Reset calendar mode toggle flag when leaving Calendar
          if (this.currentView === 'calendar' && view !== 'calendar') {
            this.calendarModeUserToggled = false;
          }

          this.currentView = view;

          // Force quarter view when entering Calendar unless user explicitly toggled this session
          if (view === 'calendar' && !this.calendarModeUserToggled) {
            this.calendarViewMode = 'quarter';
          }

          // ‚îÄ‚îÄ Calendar "aha" callout ‚Äî show once ever (persisted in UIPrefs) ‚îÄ‚îÄ
          if (view === 'calendar') {
            const hasDatedTrip = this.dataFile.trips.some(t => t.startDate);
            if (hasDatedTrip && !this.hasSeenCalendarAha) {
              this.hasSeenCalendarAha = true;
              this.saveUIPrefs();
              this.calendarAhaVisible = true;
              setTimeout(() => { this.calendarAhaVisible = false; }, 6000);
            }
          }
        },

        // ‚îÄ‚îÄ Calendar guidance card actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        openTripToAddDates() {
          // Opens the single trip in edit mode and auto-focuses the start date picker
          const trip = this.dataFile.trips[0];
          if (!trip) return;
          this.selectTrip(trip);
          this.$nextTick(() => {
            this.$nextTick(() => {
              this.openDatePicker('startDate');
            });
          });
        },
        viewCalendarFromCard() {
          // Records that user has seen the calendar prompt, then switches to Calendar tab
          this.hasSeenCalendarCard = true;
          this.saveUIPrefs();

          // Jump to quarter view anchored to the trip's start date (if available)
          const trip = this.dataFile.trips[0];
          if (trip && trip.startDate) {
            const parts = trip.startDate.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // 0-indexed (0‚Äì11)
            const quarterStartMonth = Math.floor(month / 3) * 3; // 0, 3, 6, or 9
            this.calendarViewMode = 'quarter';
            this.calendarMonth = { year, month: quarterStartMonth };
          }

          this.switchTab('calendar');
        },

        // ‚îÄ‚îÄ Journey methods ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        openJourneyDetail(journeyId) {
          this.selectedJourneyId = journeyId;
          if (this.tripPageMode !== null) {
            this.closeTripOverlay();
          }
          this.currentView = 'journey-detail';
        },
        createJourney() {
          const name = this.journeyForm.name.trim();
          if (!name) {
            this.journeyFormError = 'Journey name is required.';
            return;
          }
          const journey = {
            id: this.makeId(),
            name: name,
            description: this.journeyForm.description.trim(),
            tripOrder: [],
            createdAt: new Date().toISOString()
          };
          if (!this.dataFile.journeys) this.dataFile.journeys = [];
          this.dataFile.journeys.push(journey);
          this.markUnsaved();

          // If triggered from a trip, link it
          if (this.journeyModalTripId) {
            this.linkTripToJourney(this.journeyModalTripId, journey.id);
          }

          this.closeJourneyModal();
          this.showToast(`Journey "${name}" created`, 'success');

          // Navigate to the new journey
          this.openJourneyDetail(journey.id);
        },
        deleteJourney(journeyId) {
          const journey = this.journeys.find(j => j.id === journeyId);
          if (!journey) return;
          // Unlink all trips from this journey
          this.trips.forEach(t => {
            if (t.journeyId === journeyId) {
              t.journeyId = null;
            }
          });
          // Remove the journey
          this.dataFile.journeys = this.dataFile.journeys.filter(j => j.id !== journeyId);
          this.markUnsaved();
          this.showToast(`Journey "${journey.name}" deleted`, 'success');
          // Navigate back to journey list
          if (this.currentView === 'journey-detail' && this.selectedJourneyId === journeyId) {
            this.switchTab('journeys');
          }
        },
        // Journey detail: tap-to-edit name / description
        startEditJourneyField(field) {
          this.editingJourneyField = field;
          this.journeyEditValue = field === 'name'
            ? (this.selectedJourney.name || '')
            : (this.selectedJourney.description || '');
          this.$nextTick(() => {
            const ref = field === 'name' ? this.$refs.journeyNameInput : this.$refs.journeyDescInput;
            ref?.focus();
            if (ref?.select) ref.select();
          });
        },
        saveJourneyField() {
          if (!this.editingJourneyField || !this.selectedJourney) return;
          const val = this.journeyEditValue.trim();
          const journey = this.journeys.find(j => j.id === this.selectedJourneyId);
          if (!journey) return;
          if (this.editingJourneyField === 'name') {
            if (val) { journey.name = val; this.markUnsaved(); }
          } else {
            journey.description = val;
            this.markUnsaved();
          }
          this.editingJourneyField = null;
        },

        // Notes: linkify http/https URLs safely (HTML-escape first, then wrap URLs)
        linkifyNotes(text) {
          if (!text) return '';
          // Escape HTML entities to prevent XSS
          const esc = text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
          // Preserve line breaks
          const withBreaks = esc.replace(/\n/g, '<br>');
          // Linkify http/https URLs
          return withBreaks.replace(
            /(https?:\/\/[^\s<>"&]+)/g,
            '<a href="$1" target="_blank" rel="noopener noreferrer" class="notes-link">$1</a>'
          );
        },

        linkTripToJourney(tripId, journeyId) {
          const trip = this.trips.find(t => t.id === tripId);
          const journey = this.journeys.find(j => j.id === journeyId);
          if (!trip || !journey) return;
          trip.journeyId = journeyId;
          trip.journey = journey.name; // Keep free-text in sync
          if (!journey.tripOrder.includes(tripId)) {
            journey.tripOrder.push(tripId);
          }
          this.markUnsaved();
        },
        unlinkTripFromJourney(tripId) {
          const trip = this.trips.find(t => t.id === tripId);
          if (!trip || !trip.journeyId) return;
          const journey = this.journeys.find(j => j.id === trip.journeyId);
          trip.journeyId = null;
          trip.journey = '';
          if (journey) {
            journey.tripOrder = journey.tripOrder.filter(id => id !== tripId);
          }
          this.markUnsaved();
          this.showToast('Removed from journey', 'info');
        },
        selectJourneyForTrip(journeyId) {
          // Called from journey modal in "select" mode
          if (this.journeyModalTripId) {
            const jName = this.getJourneyName(journeyId);
            this.linkTripToJourney(this.journeyModalTripId, journeyId);
            this.showToast(`Linked to "${jName}"`, 'success');
          }
          this.closeJourneyModal();
        },
        openJourneyModal(mode, tripId) {
          this.journeyModalMode = mode || 'create';
          this.journeyModalTripId = tripId || null;
          this.journeyForm = { name: '', description: '' };
          this.journeyFormError = '';
          this.journeySearchQuery = '';
          this.addTripSearchQuery = '';
          this.showJourneyModal = true;
          this.$nextTick(() => {
            // Autofocus the search input in select/add-trip modes; name input in create mode
            if ((mode === 'select') && this.$refs.journeySearchInput) {
              this.$refs.journeySearchInput.focus();
            } else if ((mode === 'add-trip') && this.$refs.addTripSearchInput) {
              this.$refs.addTripSearchInput.focus();
            } else if (this.$refs.journeyNameInput) {
              this.$refs.journeyNameInput.focus();
            }
          });
        },
        closeJourneyModal() {
          this.showJourneyModal = false;
          this.journeyModalTripId = null;
          this.journeyForm = { name: '', description: '' };
          this.journeyFormError = '';
          this.journeySearchQuery = '';
          this.addTripSearchQuery = '';
        },
        // Drag reorder within journey detail
        journeyDragStart(tripId, index, event) {
          this.journeyDragState = { tripId, fromIndex: index };
          if (event && event.dataTransfer) {
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', tripId.toString());
          }
        },
        journeyDragOver(index, event) {
          if (!this.journeyDragState) return;
          event.preventDefault();
          event.dataTransfer.dropEffect = 'move';
        },
        journeyDrop(toIndex, event) {
          event.preventDefault();
          if (!this.journeyDragState || !this.selectedJourney) return;
          const { fromIndex } = this.journeyDragState;
          const order = [...this.selectedJourney.tripOrder];
          const [moved] = order.splice(fromIndex, 1);
          order.splice(toIndex, 0, moved);
          this.selectedJourney.tripOrder = order;
          this.journeyDragState = null;
          this.markUnsaved();
        },
        journeyDragEnd() {
          this.journeyDragState = null;
        },
        moveJourneyTrip(index, direction) {
          // Keyboard-accessible reorder (up/down arrows)
          if (!this.selectedJourney) return;
          const order = [...this.selectedJourney.tripOrder];
          const newIndex = index + direction;
          if (newIndex < 0 || newIndex >= order.length) return;
          [order[index], order[newIndex]] = [order[newIndex], order[index]];
          this.selectedJourney.tripOrder = order;
          this.markUnsaved();
        },
        journeyTripCount(journeyId) {
          return this.trips.filter(t => t.journeyId === journeyId).length;
        },
        addTripToCurrentJourney(tripId) {
          // Called from "add-trip" modal on Journey Detail page
          if (this.selectedJourneyId) {
            const tName = (this.trips.find(t => t.id === tripId) || {}).name || 'Trip';
            const prevCount = this.journeyTripCount(this.selectedJourneyId);
            this.linkTripToJourney(tripId, this.selectedJourneyId);
            const newCount = this.journeyTripCount(this.selectedJourneyId);
            // Special delight toast when journey goes from 1 ‚Üí 2 trips
            if (prevCount === 1 && newCount === 2) {
              this.showToast('Nice ‚Äî your journey is starting to take shape.', 'success');
            } else {
              this.showToast(`"${tName}" added to journey`, 'success');
            }
          }
          this.closeJourneyModal();
        },
        createTripFromJourney() {
          // Opens Trip create overlay with a pending journey link
          // so the new trip is auto-linked once created
          this.pendingJourneyLink = this.selectedJourneyId;
          this.closeJourneyModal();
          this.openTripPage({ mode: 'create' });
        },
        getJourneyName(journeyId) {
          const j = this.journeys.find(j => j.id === journeyId);
          return j ? j.name : '';
        },
        isJourneyHistorical(journeyId) {
          // A journey is historical when ALL linked trips are Completed or Canceled.
          // A journey with 0 linked trips is NOT historical.
          const linked = this.trips.filter(t => t.journeyId === journeyId);
          if (linked.length === 0) return false;
          return linked.every(t => t.status === 'Completed' || t.status === 'Canceled');
        },
        toggleJourneyHistory() {
          this.showJourneyHistory = !this.showJourneyHistory;
          this.saveUIPrefs();
        },
        // ‚îÄ‚îÄ Journey route visualization ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Returns "Stop A ‚Üí Stop B ‚Üí Stop C" string (2+ stops, max 4 + "‚Üí ‚Ä¶")
        getJourneyRoute(journeyId) {
          const journey = this.journeys.find(j => j.id === journeyId);
          if (!journey) return '';
          const order = journey.tripOrder || [];
          if (order.length < 2) return '';
          const stops = order
            .map(tid => {
              const t = this.trips.find(tr => tr.id === tid);
              return t ? (t.destination || t.name || '').trim() : '';
            })
            .filter(Boolean);
          if (stops.length < 2) return '';
          const limited = stops.slice(0, 4);
          const route = limited.join(' ‚Üí ');
          return stops.length > 4 ? route + ' ‚Üí ‚Ä¶' : route;
        },

        // ‚îÄ‚îÄ Calendar year insight (quarter view) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Returns e.g. "2 completed ¬∑ 3 planned" or null if no trips for year
        getYearInsight(year) {
          // Use calendarBaseTrips so insight reflects the active status filter
          const trips = this.calendarBaseTrips.filter(t => {
            const ds = t.startDate || t.endDate;
            if (!ds) return false;
            try { return this.parseLocalDate(ds).getFullYear() === year; } catch(e) { return false; }
          });
          if (trips.length === 0) return null;
          const completed = trips.filter(t => t.status === 'Completed').length;
          const planned   = trips.filter(t => ['Idea', 'Planning', 'Committed'].includes(t.status)).length;
          const parts = [];
          if (completed > 0) parts.push(`${completed} completed`);
          if (planned > 0)   parts.push(`${planned} planned`);
          return parts.length > 0 ? parts.join(' ¬∑ ') : null;
        },

        getJourneyDateRange(journeyId) {
          // Returns { text, someUndated } from linked trips
          const linked = this.trips.filter(t => t.journeyId === journeyId);
          if (linked.length === 0) return { text: 'No trips yet', someUndated: false };

          const dated = linked.filter(t => t.startDate || t.endDate);
          const someUndated = dated.length < linked.length;

          if (dated.length === 0) return { text: 'Dates not set', someUndated: false };

          // Find min startDate and max endDate across all dated trips
          let minDate = null;
          let maxDate = null;
          dated.forEach(t => {
            try {
              if (t.startDate) {
                const d = this.parseLocalDate(t.startDate);
                if (d && (!minDate || d < minDate)) minDate = d;
              }
              if (t.endDate) {
                const d = this.parseLocalDate(t.endDate);
                if (d && (!maxDate || d > maxDate)) maxDate = d;
              } else if (t.startDate) {
                // If no endDate, use startDate as upper bound too
                const d = this.parseLocalDate(t.startDate);
                if (d && (!maxDate || d > maxDate)) maxDate = d;
              }
            } catch (e) { /* skip malformed dates */ }
          });

          if (!minDate) return { text: 'Dates not set', someUndated: false };

          // Format as a range string using existing formatDateRange
          const minStr = minDate.toISOString().slice(0, 10);
          const maxStr = maxDate ? maxDate.toISOString().slice(0, 10) : minStr;
          const rangeText = this.formatDateRange(minStr, minStr !== maxStr ? maxStr : '');

          return { text: rangeText, someUndated };
        },

        // ‚îÄ‚îÄ Calendar month navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        prevCalendarMonth() {
          if (!this.calendarMonth) return;
          let { year, month } = this.calendarMonth;
          month -= 1;
          if (month < 0) { month = 11; year -= 1; }
          this.calendarMonth = { year, month };
        },
        nextCalendarMonth() {
          if (!this.calendarMonth) return;
          let { year, month } = this.calendarMonth;
          month += 1;
          if (month > 11) { month = 0; year += 1; }
          this.calendarMonth = { year, month };
        },
        jumpToToday() {
          const now = new Date();
          this.calendarMonth = { year: now.getFullYear(), month: now.getMonth() };
        },
        // Toggle calendar history (Completed/Canceled trips)
        toggleCalendarHistory() {
          this.calendarShowHistory = !this.calendarShowHistory;
          this.saveUIPrefs();
        },
        // ‚îÄ‚îÄ Calendar rendering helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Returns a compact date label for a trip in the calendar month view.
        // Format: "Feb 10‚Äì14", "Feb 10", etc. Uses month-context-aware abbreviation.
        calendarTripDateLabel(trip) {
          const start = trip.startDate ? this.parseLocalDate(trip.startDate) : null;
          const end   = trip.endDate   ? this.parseLocalDate(trip.endDate)   : null;
          const monthOpts = { month: 'short', day: 'numeric' };
          if (start && end) {
            // Same month: "Feb 10‚Äì14"; different months: "Feb 28‚ÄìMar 3"
            if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
              return `${start.toLocaleDateString('en-US', monthOpts)}‚Äì${end.getDate()}`;
            }
            return `${start.toLocaleDateString('en-US', monthOpts)}‚Äì${end.toLocaleDateString('en-US', monthOpts)}`;
          }
          if (start) return start.toLocaleDateString('en-US', monthOpts);
          if (end)   return end.toLocaleDateString('en-US', monthOpts);
          return '';
        },
        // Returns span indicators when a trip overlaps into adjacent months.
        // '‚Üê' if trip started before this month; '‚Üí' if trip ends after this month.
        calendarTripSpan(trip) {
          if (!this.calendarMonth) return { before: false, after: false };
          const { year, month } = this.calendarMonth;
          const monthStart = new Date(year, month, 1);
          const monthEnd   = new Date(year, month + 1, 0, 23, 59, 59, 999);
          const start = trip.startDate ? this.parseLocalDate(trip.startDate) : null;
          const end   = trip.endDate   ? this.parseLocalDate(trip.endDate)   : null;
          return {
            before: !!(start && start < monthStart),
            after:  !!(end   && end   > monthEnd),
          };
        },

        // Compute derived trip metadata from real data
        computeTripMeta(trip) {
          const meta = {};

          // Todos count
          const todos = trip.todos || [];
          meta.totalTodos = todos.length;
          meta.completedTodos = todos.filter(t => t.completed).length;

          // Budget from expenses
          const expenses = trip.expenses || [];
          meta.totalBudget = expenses.reduce((sum, exp) => {
            return sum + this.safeParseNumber(exp.amount);
          }, 0);

          // Days until trip (Safari-safe)
          if (trip.startDate) {
            const start = this.parseLocalDate(trip.startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffTime = start - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            meta.daysUntil = diffDays > 0 ? diffDays : 0;
          }

          // Trip duration (Safari-safe)
          if (trip.startDate && trip.endDate) {
            const start = this.parseLocalDate(trip.startDate);
            const end = this.parseLocalDate(trip.endDate);
            const diffTime = end - start;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            meta.duration = diffDays;
          }

          return meta;
        },
        // Safari-safe date parsing ‚Äî uses explicit year/month/day to avoid UTC offset issues.
        // Parses "YYYY-MM-DD" as a local midnight date. Returns null for any invalid input.
        parseLocalDate(dateString) {
          if (!dateString || typeof dateString !== 'string') return null;
          const parts = dateString.match(/^(\d{4})-(\d{2})-(\d{2})$/);
          if (!parts) return null;
          const y = parseInt(parts[1], 10);
          const m = parseInt(parts[2], 10) - 1; // 0-indexed
          const d = parseInt(parts[3], 10);
          if (m < 0 || m > 11 || d < 1 || d > 31) return null;
          const date = new Date(y, m, d);
          // Validate: JS rolls over invalid days (e.g. Feb 30 ‚Üí Mar 2), so check back
          if (date.getFullYear() !== y || date.getMonth() !== m || date.getDate() !== d) return null;
          return date;
        },
        // Helper: validate ISO date format (YYYY-MM-DD)
        isIsoDate(str) {
          if (typeof str !== 'string') return false;
          const match = /^\d{4}-\d{2}-\d{2}$/.test(str);
          if (!match) return false;
          const date = new Date(str + 'T00:00:00');
          return !isNaN(date.getTime());
        },
        // Helper: safe number parsing
        safeParseNumber(value) {
          const num = parseFloat(value);
          return (isFinite(num) && !isNaN(num)) ? num : 0;
        },
        // Helper: generate unique ID
        makeId() {
          return Date.now() + Math.floor(Math.random() * 100000);
        },
        // Normalize entire imported file
        normalizeFile(rawData) {
          const fixes = [];

          // BACKWARD COMPATIBILITY: Flatten old collection-based structure
          // Old format: { collections: [{name: "X", trips: [...]}] }
          // New format: { version: "2.0.0", trips: [...] }
          if (rawData.collections && Array.isArray(rawData.collections)) {
            const allTrips = [];
            rawData.collections.forEach((collection) => {
              if (collection.trips && Array.isArray(collection.trips)) {
                allTrips.push(...collection.trips);
              }
            });
            rawData = {
              version: rawData.version || '2.0.0',
              trips: allTrips,
              exportDate: rawData.exportDate || new Date().toISOString()
            };
            fixes.push(`Collections flattened during import (${allTrips.length} trips from ${rawData.collections.length} collections)`);
            console.log('Collections flattened during import.');
          }

          // Normalize version
          let version = rawData.version;
          if (!version || typeof version !== 'string') {
            version = '2.0.0';
            fixes.push('Missing version ‚Üí set to 2.0.0');
          }

          // Normalize exportDate
          let exportDate = rawData.exportDate;
          if (!exportDate || typeof exportDate !== 'string') {
            exportDate = new Date().toISOString();
            fixes.push('Missing exportDate ‚Üí set to current timestamp');
          }

          // Normalize trips array
          const trips = Array.isArray(rawData.trips) ? rawData.trips : [];
          const normalizedTrips = trips.map((trip, index) =>
            this.normalizeTrip(trip, index, fixes)
          );

          // Normalize journeys array
          const journeys = Array.isArray(rawData.journeys) ? rawData.journeys : [];
          const normalizedJourneys = journeys.map((j, index) =>
            this.normalizeJourney(j, index, fixes)
          );

          return {
            dataFile: { version, trips: normalizedTrips, journeys: normalizedJourneys, exportDate },
            fixes
          };
        },
        normalizeJourney(raw, index, fixes) {
          const label = `Journey ${index + 1}`;
          const normalized = {};

          // ID
          if (!raw.id || typeof raw.id !== 'number') {
            normalized.id = this.makeId();
            fixes.push(`${label}: missing id ‚Üí generated new id`);
          } else {
            normalized.id = raw.id;
          }

          // Name
          if (!raw.name || typeof raw.name !== 'string' || !raw.name.trim()) {
            normalized.name = 'Untitled Journey';
            fixes.push(`${label}: missing name ‚Üí set to "Untitled Journey"`);
          } else {
            normalized.name = raw.name;
          }

          // Description
          normalized.description = (typeof raw.description === 'string') ? raw.description : '';

          // Trip order (array of trip IDs defining display order)
          normalized.tripOrder = Array.isArray(raw.tripOrder) ? raw.tripOrder : [];

          // Created date
          normalized.createdAt = raw.createdAt || new Date().toISOString();

          return normalized;
        },
        // Normalize a single trip
        normalizeTrip(rawTrip, index, fixes) {
          const tripLabel = `Trip ${index + 1}`;
          const normalized = {};

          // ID
          if (!rawTrip.id || typeof rawTrip.id !== 'number') {
            normalized.id = this.makeId();
            fixes.push(`${tripLabel}: missing id ‚Üí generated new id`);
          } else {
            normalized.id = rawTrip.id;
          }

          // Name
          if (!rawTrip.name || typeof rawTrip.name !== 'string' || !rawTrip.name.trim()) {
            normalized.name = 'Untitled Trip';
            fixes.push(`${tripLabel}: missing name ‚Üí set to "Untitled Trip"`);
          } else {
            normalized.name = rawTrip.name;
          }

          // Destination
          normalized.destination = (typeof rawTrip.destination === 'string') ? rawTrip.destination : '';

          // Description
          normalized.description = (typeof rawTrip.description === 'string') ? rawTrip.description : '';

          // StartDate
          if (rawTrip.startDate && this.isIsoDate(rawTrip.startDate)) {
            normalized.startDate = rawTrip.startDate;
          } else {
            normalized.startDate = '';
            if (rawTrip.startDate) {
              fixes.push(`${tripLabel}: invalid startDate ‚Üí cleared`);
            }
          }

          // EndDate
          if (rawTrip.endDate && this.isIsoDate(rawTrip.endDate)) {
            normalized.endDate = rawTrip.endDate;
          } else {
            normalized.endDate = '';
            if (rawTrip.endDate) {
              fixes.push(`${tripLabel}: invalid endDate ‚Üí cleared`);
            }
          }

          // Status
          const validStatuses = ['Idea', 'Planning', 'Committed', 'Canceled', 'Completed'];
          if (validStatuses.includes(rawTrip.status)) {
            normalized.status = rawTrip.status;
          } else {
            normalized.status = 'Planning';
            if (rawTrip.status) {
              fixes.push(`${tripLabel}: invalid status ‚Üí set to "Planning"`);
            }
          }

          // Todos
          if (!Array.isArray(rawTrip.todos)) {
            normalized.todos = [];
            if (rawTrip.todos !== undefined) {
              fixes.push(`${tripLabel}: invalid todos ‚Üí set to []`);
            }
          } else {
            normalized.todos = rawTrip.todos.map((todo, i) =>
              this.normalizeTodo(todo, tripLabel, i, fixes)
            );
          }

          // Expenses
          if (!Array.isArray(rawTrip.expenses)) {
            normalized.expenses = [];
            if (rawTrip.expenses !== undefined) {
              fixes.push(`${tripLabel}: invalid expenses ‚Üí set to []`);
            }
          } else {
            normalized.expenses = rawTrip.expenses.map((expense, i) =>
              this.normalizeExpense(expense, tripLabel, i, fixes)
            );
          }

          // Notes
          normalized.notes = (typeof rawTrip.notes === 'string') ? rawTrip.notes : '';

          // Journey (optional grouping label)
          normalized.journey = (typeof rawTrip.journey === 'string') ? rawTrip.journey : '';

          // Journey ID (future linking ‚Äî null until journey feature is built)
          normalized.journeyId = rawTrip.journeyId || null;

          return normalized;
        },
        // Normalize a todo item
        normalizeTodo(rawTodo, tripLabel, index, fixes) {
          const normalized = {};
          const todoLabel = `${tripLabel} todo ${index + 1}`;

          // ID
          if (!rawTodo.id || typeof rawTodo.id !== 'number') {
            normalized.id = this.makeId();
          } else {
            normalized.id = rawTodo.id;
          }

          // Title
          if (!rawTodo.title || typeof rawTodo.title !== 'string' || !rawTodo.title.trim()) {
            normalized.title = 'Untitled Task';
            fixes.push(`${todoLabel}: missing title ‚Üí set to "Untitled Task"`);
          } else {
            normalized.title = rawTodo.title;
          }

          // Description
          normalized.description = (typeof rawTodo.description === 'string') ? rawTodo.description : '';

          // Completed
          normalized.completed = Boolean(rawTodo.completed);

          return normalized;
        },
        // Normalize an expense item
        normalizeExpense(rawExpense, tripLabel, index, fixes) {
          const normalized = {};
          const expenseLabel = `${tripLabel} expense ${index + 1}`;

          // ID
          if (!rawExpense.id || typeof rawExpense.id !== 'number') {
            normalized.id = this.makeId();
          } else {
            normalized.id = rawExpense.id;
          }

          // Title
          if (!rawExpense.title || typeof rawExpense.title !== 'string' || !rawExpense.title.trim()) {
            normalized.title = 'Untitled Expense';
            fixes.push(`${expenseLabel}: missing title ‚Üí set to "Untitled Expense"`);
          } else {
            normalized.title = rawExpense.title;
          }

          // Description
          normalized.description = (typeof rawExpense.description === 'string') ? rawExpense.description : '';

          // Amount
          const amount = this.safeParseNumber(rawExpense.amount);
          if (amount === 0 && rawExpense.amount && rawExpense.amount !== 0) {
            fixes.push(`${expenseLabel}: invalid amount ‚Üí set to 0`);
          }
          normalized.amount = amount;

          // Category
          const validCategories = ['Lodging', 'Transportation', 'Food', 'Activities', 'Permits', 'Other'];
          if (validCategories.includes(rawExpense.category)) {
            normalized.category = rawExpense.category;
          } else {
            normalized.category = 'Other';
            if (rawExpense.category) {
              fixes.push(`${expenseLabel}: invalid category ‚Üí set to "Other"`);
            }
          }

          return normalized;
        },
        selectTrip(trip) {
          // Clear first-trip highlight immediately on card interaction
          if (this.highlightedTripId) this.highlightedTripId = null;
          this.openTripPage({ mode: 'edit', tripId: trip.id });
        },
        navigateToList() {
          // With autosave, navigation is always safe ‚Äî data is written to localStorage.
          // Only block navigation if autosave has actually failed (storage full, etc.)
          if (this.saveStatus === 'error') {
            this.pendingNavigation = () => {
              this.clearInlineEditing();
              this.selectedTripId = null;
            };
            this.showConfirmModal = true;
            return;
          }

          this.clearInlineEditing();
          this.selectedTripId = null;
        },
        // ‚îÄ‚îÄ Overlay open/close ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        closeTripOverlay() {
          // Create mode: use cancelCreateTrip (may prompt discard)
          if (this.tripPageMode === 'create') {
            this.cancelCreateTrip();
            return;
          }
          // Edit mode: with autosave, closing is always safe.
          // Only block if autosave has actually failed.
          if (this.saveStatus === 'error') {
            this.pendingNavigation = () => {
              this._doCloseTripOverlay();
            };
            this.showConfirmModal = true;
            return;
          }
          this._doCloseTripOverlay();
        },
        _doCloseTripOverlay() {
          this.clearInlineEditing();
          this.notesEditMode = false;   // Reset notes display/edit toggle
          this.expandedTodoNotes = {};  // Collapse all expanded task notes
          this.selectedTripId = null;
          this.tripPageMode = null;
          this.draftTrip = null;
          this.createTripError = '';
          this.createMoreDetails = false;
          document.body.classList.remove('modal-open');
          const target = this.lastFocusedEl;
          this.lastFocusedEl = null;
          this.$nextTick(() => {
            if (target && target.isConnected) {
              target.focus();
            }
          });
        },
        confirmDiscard() {
          this.unsavedChanges = false;
          this.showConfirmModal = false;
          if (this.pendingNavigation) {
            this.pendingNavigation();
            this.pendingNavigation = null;
          }
        },
        cancelDiscard() {
          this.showConfirmModal = false;
          this.pendingNavigation = null;
        },
        closeFixesModal() {
          this.showFixesModal = false;
        },
        // Todo operations
        toggleTodoCompleted(todo) {
          todo.completed = !todo.completed;
          this.markUnsaved();
        },
        openAddTodo() {
          this.todoModalMode = 'add';
          this.todoForm = {
            title: '',
            description: ''
          };
          this.todoFormError = '';
          this.showTodoModal = true;
        },
        openEditTodo(todo) {
          this.todoModalMode = 'edit';
          this.editingTodo = todo;
          this.todoForm = {
            title: todo.title,
            description: todo.description || ''
          };
          this.todoFormError = '';
          this.showTodoModal = true;
        },
        closeTodoModal() {
          this.showTodoModal = false;
          this.todoForm = { title: '', description: '' };
          this.todoFormError = '';
          this.editingTodo = null;
        },
        submitTodoForm() {
          // Validate title
          const title = this.todoForm.title.trim();
          if (!title) {
            this.todoFormError = 'Title is required';
            return;
          }

          if (this.todoModalMode === 'add') {
            // Add new todo
            const newTodo = {
              id: this.makeId(),
              title: title,
              description: this.todoForm.description.trim(),
              completed: false
            };

            if (!this.selectedTrip.todos) {
              this.selectedTrip.todos = [];
            }
            this.selectedTrip.todos.push(newTodo);
          } else {
            // Edit existing todo
            this.editingTodo.title = title;
            this.editingTodo.description = this.todoForm.description.trim();
          }

          this.markUnsaved();
          this.closeTodoModal();
        },
        openDeleteTodo(todo) {
          this.deletingTodo = todo;
          this.showDeleteTodoModal = true;
        },
        closeDeleteTodoModal() {
          this.showDeleteTodoModal = false;
          this.deletingTodo = null;
        },
        confirmDeleteTodo() {
          if (this.deletingTodo && this.selectedTrip.todos) {
            const index = this.selectedTrip.todos.findIndex(t => t.id === this.deletingTodo.id);
            if (index !== -1) {
              this.selectedTrip.todos.splice(index, 1);
              this.markUnsaved();
            }
          }
          this.closeDeleteTodoModal();
        },
        // Expenses
        openAddExpense() {
          this.expenseModalMode = 'add';
          this.expenseForm = {
            title: '',
            description: '',
            amount: '',
            category: 'Lodging'
          };
          this.expenseFormErrors = {
            title: '',
            amount: ''
          };
          this.showExpenseModal = true;
        },
        openEditExpense(expense) {
          this.expenseModalMode = 'edit';
          this.editingExpense = expense;
          this.expenseForm = {
            title: expense.title,
            description: expense.description || '',
            amount: String(expense.amount),
            category: expense.category
          };
          this.expenseFormErrors = {
            title: '',
            amount: ''
          };
          this.showExpenseModal = true;
        },
        closeExpenseModal() {
          this.showExpenseModal = false;
          this.expenseForm = {
            title: '',
            description: '',
            amount: '',
            category: 'Lodging'
          };
          this.expenseFormErrors = {
            title: '',
            amount: ''
          };
          this.editingExpense = null;
        },
        submitExpenseForm() {
          // Validate title
          const title = this.expenseForm.title.trim();
          if (!title) {
            this.expenseFormErrors.title = 'Title is required';
            return;
          } else {
            this.expenseFormErrors.title = '';
          }

          // Validate amount
          const amountStr = String(this.expenseForm.amount).trim();
          if (amountStr === '' || isNaN(parseFloat(amountStr))) {
            this.expenseFormErrors.amount = 'Valid amount is required';
            return;
          }

          const amount = this.safeParseNumber(this.expenseForm.amount);
          if (amount < 0) {
            this.expenseFormErrors.amount = 'Amount must be positive';
            return;
          }

          this.expenseFormErrors.amount = '';

          if (this.expenseModalMode === 'add') {
            // Add new expense
            const newExpense = {
              id: this.makeId(),
              title: title,
              description: this.expenseForm.description.trim(),
              amount: amount,
              category: this.expenseForm.category
            };

            if (!this.selectedTrip.expenses) {
              this.selectedTrip.expenses = [];
            }
            this.selectedTrip.expenses.push(newExpense);
          } else {
            // Edit existing expense
            this.editingExpense.title = title;
            this.editingExpense.description = this.expenseForm.description.trim();
            this.editingExpense.amount = amount;
            this.editingExpense.category = this.expenseForm.category;
          }

          this.markUnsaved();
          this.closeExpenseModal();
        },
        openDeleteExpense(expense) {
          this.deletingExpense = expense;
          this.showDeleteExpenseModal = true;
        },
        closeDeleteExpenseModal() {
          this.showDeleteExpenseModal = false;
          this.deletingExpense = null;
        },
        confirmDeleteExpense() {
          if (this.deletingExpense && this.selectedTrip.expenses) {
            const index = this.selectedTrip.expenses.findIndex(e => e.id === this.deletingExpense.id);
            if (index !== -1) {
              this.selectedTrip.expenses.splice(index, 1);
              this.markUnsaved();
            }
          }
          this.closeDeleteExpenseModal();
        },
        // Trip CRUD
        openNewTrip() {
          this.openTripPage({ mode: 'create' });
        },
        openTripPage({ mode, tripId }) {
          // Block if autosave has failed
          if (this.saveStatus === 'error') {
            this.pendingNavigation = () => { this.openTripPage({ mode, tripId }); };
            this.showConfirmModal = true;
            return;
          }

          this.clearInlineEditing();

          if (mode === 'create') {
            // Initialize a draft trip ‚Äî NOT persisted until user clicks "Create Trip"
            this.draftTrip = {
              id: this.makeId(),
              name: '',
              destination: '',
              description: '',
              startDate: '',
              endDate: '',
              status: 'Planning',
              todos: [],
              expenses: [],
              notes: '',
              journey: '',
              journeyId: null
            };
            this.createTripError = '';
            this.createMoreDetails = false;
            this.selectedTripId = null;
            this.tripPageMode = 'create';
          } else {
            // Edit mode ‚Äî load existing trip
            this.draftTrip = null;
            this.selectedTripId = tripId;
            this.tripPageMode = 'edit';
          }

          this.lastFocusedEl = document.activeElement;
          document.body.classList.add('modal-open');
          this.$nextTick(() => {
            if (mode === 'create') {
              // Auto-focus the name field display to trigger edit
              this.$nextTick(() => {
                this.startEditTripField('name');
              });
            } else {
              if (this.$refs.overlayBackBtn) this.$refs.overlayBackBtn.focus();
            }
          });
        },
        createTrip() {
          // Validate name
          if (!this.draftTrip || !this.draftTrip.name.trim()) {
            this.createTripError = 'Trip name is required';
            return;
          }
          this.createTripError = '';

          // Trim string fields
          this.draftTrip.name = this.draftTrip.name.trim();
          this.draftTrip.destination = (this.draftTrip.destination || '').trim();
          this.draftTrip.description = (this.draftTrip.description || '').trim();
          this.draftTrip.notes = (this.draftTrip.notes || '').trim();

          // Persist: push into trips array
          this.dataFile.trips.unshift(this.draftTrip);

          const newTripId = this.draftTrip.id;

          // First-trip highlight: one-shot glow + "New" pill (~10 seconds)
          if (this.dataFile.trips.length === 1 && !this.hasHighlightedFirstTripCard) {
            this.hasHighlightedFirstTripCard = true;
            this.highlightedTripId = newTripId;
            this.saveUIPrefs();
            setTimeout(() => {
              if (this.highlightedTripId === newTripId) this.highlightedTripId = null;
            }, 10000);
          }

          // Switch to edit mode seamlessly
          this.selectedTripId = newTripId;
          this.tripPageMode = 'edit';
          this.draftTrip = null;

          // Auto-link to pending journey if set (e.g., "Create trip" from journey detail)
          if (this.pendingJourneyLink) {
            this.linkTripToJourney(newTripId, this.pendingJourneyLink);
            this.pendingJourneyLink = null;
          }

          this.markUnsaved();
          this.showToast('Trip created');
        },
        cancelCreateTrip() {
          // Check if any fields have been filled
          const d = this.draftTrip;
          const hasData = d && (d.name.trim() || d.destination.trim() || d.startDate || d.endDate || d.notes.trim());
          if (hasData) {
            // Show Vue modal instead of native confirm() so ESC hold doesn't dismiss it instantly
            this.showDiscardDraftModal = true;
            return;
          }
          this._doCloseTripOverlay();
        },
        discardDraftConfirm() {
          this.showDiscardDraftModal = false;
          this._doCloseTripOverlay();
        },
        discardDraftCancel() {
          this.showDiscardDraftModal = false;
        },
        // Quick-Add Trip (Idea status) ‚Äî opens create overlay with name prefilled
        quickAddTrip() {
          const name = this.quickAddInput.trim();
          if (!name) return;

          // Clear input first
          this.quickAddInput = '';

          // Open create overlay and prefill name + status
          this.openTripPage({ mode: 'create' });
          // draftTrip is set synchronously in openTripPage, so we can prefill immediately
          if (this.draftTrip) {
            this.draftTrip.name = name;
            this.draftTrip.status = 'Idea';
            // Also update the draft field value since startEditTripField('name') is queued
            // It will pick up draftTrip.name via selectedTrip[field] in $nextTick
          }
        },
        openDeleteTrip() {
          if (this.selectedTrip) {
            this.deletingTrip = this.selectedTrip;
            this.showDeleteTripModal = true;
          }
        },
        closeDeleteTripModal() {
          this.showDeleteTripModal = false;
          this.deletingTrip = null;
        },
        confirmDeleteTrip() {
          if (this.deletingTrip) {
            const index = this.trips.findIndex(t => t.id === this.deletingTrip.id);
            if (index !== -1) {
              this.trips.splice(index, 1);
              this.markUnsaved();

              // Close overlay and navigate back to list view
              this.selectedTripId = null;
              document.body.classList.remove('modal-open');

              // Show toast
              this.showToast('Trip deleted');
            }
          }
          this.closeDeleteTripModal();
        },
        openClearDataModal() {
          this.showClearDataModal = true;
        },
        closeClearDataModal() {
          this.showClearDataModal = false;
        },
        confirmClearData() {
          this.dataFile.trips = [];
          this.dataFile.journeys = [];
          // Close any open trip overlay
          this.selectedTripId = null;
          document.body.classList.remove('modal-open');
          this.closeClearDataModal();
          this.markUnsaved();
          this.showToast('All data cleared', 'info');
        },
        duplicateTrip() {
          if (!this.selectedTrip) return;

          // Duplicating adds data ‚Äî no guard needed with autosave.
          // (Block only if autosave failed.)
          if (this.saveStatus === 'error') {
            this.pendingNavigation = () => { this.duplicateTrip(); };
            this.showConfirmModal = true;
            return;
          }

          const original = this.selectedTrip;

          // Deep copy with new IDs and reset rules
          const duplicated = {
            id: this.makeId(),
            name: `Copy of ${original.name}`,
            destination: original.destination,
            description: original.description,
            startDate: original.startDate,
            endDate: original.endDate,
            status: 'Planning', // Reset status
            todos: (original.todos || []).map(todo => ({
              id: this.makeId(),
              title: todo.title,
              description: todo.description || '',
              completed: false // Reset completion
            })),
            expenses: (original.expenses || []).map(expense => ({
              id: this.makeId(),
              title: expense.title,
              description: expense.description || '',
              amount: expense.amount,
              category: expense.category
            })),
            notes: original.notes || ''
          };

          // Insert after original trip
          const originalIndex = this.trips.findIndex(t => t.id === original.id);
          if (originalIndex !== -1) {
            this.trips.splice(originalIndex + 1, 0, duplicated);
          } else {
            this.trips.push(duplicated);
          }

          // Select duplicated trip ‚Äî stays in overlay showing the new copy
          this.selectedTripId = duplicated.id;
          document.body.classList.add('modal-open');
          this.$nextTick(() => {
            if (this.$refs.overlayBackBtn) this.$refs.overlayBackBtn.focus();
          });

          // Mark unsaved
          this.markUnsaved();

          // Show toast
          this.showToast('Trip duplicated');
        },
        formatCurrency(amount) {
          return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).format(amount || 0);
        },
        formatDateRange(startDate, endDate) {
          if (!startDate) return 'No dates set';

          const options = { month: 'short', day: 'numeric', year: 'numeric' };
          const start = this.parseLocalDate(startDate).toLocaleDateString('en-US', options);

          if (!endDate) return start;

          const end = this.parseLocalDate(endDate).toLocaleDateString('en-US', options);
          return `${start} - ${end}`;
        },
        onTripStartDateChange() {
          // If start date is set and end date is empty, set end date = start date
          if (this.selectedTrip.startDate && !this.selectedTrip.endDate) {
            this.selectedTrip.endDate = this.selectedTrip.startDate;
          }
          this.markUnsaved();
        },

        // ‚îÄ‚îÄ Inline (tap-to-edit): Trip Fields ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        clearInlineEditing() {
          this.editingTripField = null;
          this.tripFieldDraft = '';
          this.tripFieldError = '';
          this.editingTodoId = null;
          this.todoDraft = { title: '', description: '' };
          this.editingExpenseId = null;
          this.expenseDraft = { title: '', amount: '', category: 'Other' };
          this.expenseDraftError = '';
          // Reset quick-add inputs
          this.quickAddTaskText = '';
          this.quickAddExpenseTitle = '';
          this.quickAddExpenseAmount = '';
          this.quickAddExpenseCategory = '';
          this.quickAddExpenseError = '';
        },
        startEditTripField(field) {
          // Dismiss the edit hint on first use (session-only)
          if (!this.overlayEditHintShown) this.overlayEditHintShown = true;
          // Close any other inline edits first
          if (this.editingTodoId !== null) this.cancelTodoInline();
          if (this.editingExpenseId !== null) this.cancelExpenseInline();
          this.editingTripField = field;
          this.tripFieldDraft = this.selectedTrip[field] || '';
          this.tripFieldOriginal = this.tripFieldDraft; // Track original for no-change detection
          this.tripFieldError = '';
          this.$nextTick(() => {
            const input = document.querySelector('.trip-field-input-active');
            if (input) {
              input.focus();
              // Place caret at end for text inputs / select all for date inputs
              if (input.type === 'date' || input.tagName === 'SELECT') {
                // Date/select: just focus is enough
              } else if (input.setSelectionRange && input.value) {
                const len = input.value.length;
                input.setSelectionRange(len, len);
              }
            }
          });
        },
        commitTripField() {
          const field = this.editingTripField;
          if (!field) return;
          const draft = this.tripFieldDraft;
          const prevValue = this.tripFieldOriginal; // capture before clearing

          // If value hasn't changed, just cancel (no save needed)
          if (draft === prevValue) {
            this.cancelTripField();
            return;
          }

          // Date validation
          if (field === 'startDate' || field === 'endDate') {
            if (field === 'endDate' && draft && this.selectedTrip.startDate) {
              if (draft < this.selectedTrip.startDate) {
                this.tripFieldError = 'End date must be on or after start date.';
                return; // Keep in edit mode
              }
            }
            if (field === 'startDate' && draft) {
              // Auto-set end date to start date if empty, or auto-advance if start date moved past it
              if (!this.selectedTrip.endDate || draft > this.selectedTrip.endDate) {
                this.selectedTrip.endDate = draft;
              }
            }
          }

          this.selectedTrip[field] = draft;

          // ‚îÄ‚îÄ Session flag: trip gained a startDate ‚Üí enable calendar callout ‚îÄ‚îÄ
          if (field === 'startDate' && draft) {
            try { sessionStorage.setItem('th_session_hasDatedTrip', '1'); } catch(e) {}
          }

          // ‚îÄ‚îÄ Trip Completed delight ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          if (field === 'status' && draft === 'Completed' && prevValue !== 'Completed') {
            const tripId = this.selectedTrip.id;
            this.recentlyCompletedTripId = tripId;
            setTimeout(() => {
              if (this.recentlyCompletedTripId === tripId) this.recentlyCompletedTripId = null;
            }, 1200);
            // Count completed trips this year (current state includes the just-completed trip)
            const cy = new Date().getFullYear();
            const count = (this.dataFile.trips || []).filter(t =>
              t.status === 'Completed' &&
              t.startDate &&
              this.parseLocalDate(t.startDate).getFullYear() === cy
            ).length;
            const n = count || 1;
            this.showToast(`Nice! You've completed ${n} trip${n !== 1 ? 's' : ''} this year.`, 'success');
          }

          this.editingTripField = null;
          this.tripFieldDraft = '';
          this.tripFieldOriginal = '';
          this.tripFieldError = '';
          this.markUnsaved();
        },
        openDatePicker(fieldName) {
          // Switch field to edit mode (renders the date input), then focus it.
          // We intentionally do NOT call showPicker() or input.click() ‚Äî both can trigger
          // Safari's native date picker overlay, which traps focus (black screen) and limits
          // the year field to 2 digits. Focus-only lets the browser handle the picker
          // natively when the user taps/clicks the input directly.
          this.startEditTripField(fieldName);
          this.$nextTick(() => {
            this.$nextTick(() => {
              const input = document.querySelector('[data-date-field="' + fieldName + '"]');
              if (input) input.focus();
            });
          });
        },
        cancelTripField() {
          this.editingTripField = null;
          this.tripFieldDraft = '';
          this.tripFieldOriginal = '';
          this.tripFieldError = '';
        },

        // ‚îÄ‚îÄ Inline (tap-to-edit): Todos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        startEditTodoInline(todo) {
          if (this.editingTripField !== null) this.cancelTripField();
          if (this.editingExpenseId !== null) this.cancelExpenseInline();
          this.editingTodoId = todo.id;
          this.todoDraft = { title: todo.title || '', description: todo.description || '' };
          this.$nextTick(() => {
            const input = this.$el.querySelector('.todo-title-input');
            if (input) input.focus();
          });
        },
        commitTodoInline() {
          if (this.editingTodoId === null) return;
          const todo = this.selectedTrip.todos.find(t => t.id === this.editingTodoId);
          if (todo && this.todoDraft.title.trim()) {
            todo.title = this.todoDraft.title.trim();
            todo.description = this.todoDraft.description.trim();
            this.markUnsaved();
          }
          this.editingTodoId = null;
          this.todoDraft = { title: '', description: '' };
        },
        cancelTodoInline() {
          this.editingTodoId = null;
          this.todoDraft = { title: '', description: '' };
        },

        // ‚îÄ‚îÄ Inline (tap-to-edit): Expenses ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        startEditExpenseInline(expense) {
          if (this.editingTripField !== null) this.cancelTripField();
          if (this.editingTodoId !== null) this.cancelTodoInline();
          this.editingExpenseId = expense.id;
          this.expenseDraft = {
            title: expense.title || '',
            amount: expense.amount !== undefined ? String(expense.amount) : '',
            category: expense.category || 'Other'
          };
          this.expenseDraftError = '';
        },
        commitExpenseInline() {
          if (this.editingExpenseId === null) return;
          const amount = parseFloat(this.expenseDraft.amount);
          if (isNaN(amount) || amount < 0) {
            this.expenseDraftError = 'Amount must be a number ‚â• 0.';
            return;
          }
          if (!this.expenseDraft.title.trim()) {
            this.expenseDraftError = 'Title is required.';
            return;
          }
          const expense = this.selectedTrip.expenses.find(e => e.id === this.editingExpenseId);
          if (expense) {
            expense.title = this.expenseDraft.title.trim();
            expense.amount = amount;
            expense.category = this.expenseDraft.category;
            this.markUnsaved();
          }
          this.editingExpenseId = null;
          this.expenseDraft = { title: '', amount: '', category: 'Other' };
          this.expenseDraftError = '';
        },
        cancelExpenseInline() {
          this.editingExpenseId = null;
          this.expenseDraft = { title: '', amount: '', category: 'Other' };
          this.expenseDraftError = '';
        },

        // ‚îÄ‚îÄ Inline Quick-Add: Tasks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        addTaskQuick() {
          const title = this.quickAddTaskText.trim();
          if (!title) return;
          if (!this.selectedTrip.todos) this.selectedTrip.todos = [];
          this.selectedTrip.todos.push({
            id: this.makeId(),
            title: title,
            description: '',
            completed: false
          });
          this.quickAddTaskText = '';
          this.markUnsaved();
        },

        // ‚îÄ‚îÄ Inline Quick-Add: Expenses ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        addExpenseQuick() {
          const title = this.quickAddExpenseTitle.trim();
          const amountStr = String(this.quickAddExpenseAmount).trim();
          this.quickAddExpenseError = '';

          if (!title) {
            this.quickAddExpenseError = 'Enter a title';
            return;
          }
          if (amountStr === '' || isNaN(parseFloat(amountStr))) {
            this.quickAddExpenseError = 'Enter a valid amount';
            return;
          }
          const amount = this.safeParseNumber(amountStr);
          if (amount < 0) {
            this.quickAddExpenseError = 'Amount must be positive';
            return;
          }

          if (!this.selectedTrip.expenses) this.selectedTrip.expenses = [];
          this.selectedTrip.expenses.push({
            id: this.makeId(),
            title: title,
            description: '',
            amount: amount,
            category: (this.quickAddExpenseCategory || 'Other').trim() || 'Other'
          });
          this.quickAddExpenseTitle = '';
          this.quickAddExpenseAmount = '';
          this.quickAddExpenseCategory = '';
          this.quickAddExpenseError = '';
          this.markUnsaved();
        },

        toggleTheme() {
          this.theme = this.theme === 'light' ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', this.theme);
          localStorage.setItem('travelHubTheme', this.theme);
        },
        toggleStatus(status) {
          // Selecting Completed or Canceled auto-enables showHistory (Option A)
          const historyStatuses = ['Completed', 'Canceled'];
          if (historyStatuses.includes(status) && !this.showHistory) {
            this.showHistory = true;
          }
          const idx = this.statusFilter.indexOf(status);
          if (idx >= 0) {
            this.statusFilter.splice(idx, 1);
          } else {
            this.statusFilter.push(status);
          }
          this.saveUIPrefs();
        },
        setAllStatuses() {
          this.statusFilter = [];
          this.saveUIPrefs();
        },
        toggleHistory() {
          this.showHistory = !this.showHistory;
          this.saveUIPrefs();
        },
        resetFilters() {
          // One-click "Clear filters" action for empty state
          this.statusFilter = [];
          this.showHistory = false;
          this.searchQuery = '';
          this.saveUIPrefs();
        },
        onSortChange() {
          this.saveUIPrefs();
        },
        // Hydration helper: apply loaded data without triggering dirty-state side-effects.
        // Set isHydrating=true before mutating, false after; reset filters; mark as saved.
        _hydrate(dataFile) {
          // Cancel any stale autosave timer ‚Äî prevents old data from overwriting newly loaded data
          clearTimeout(this._autoSaveTimer);
          this._autoSaveTimer = null;

          this.isHydrating = true;
          this.dataFile = dataFile;
          this.currentView = 'list';
          this.selectedTripId = null;
          this.unsavedChanges = false;
          this.saveStatus = 'saved';
          // Dismiss any stale "Unsaved Changes" confirmation modal and pending navigation
          this.showConfirmModal = false;
          this.pendingNavigation = null;
          // Reset filters so loaded data always shows immediately
          this.statusFilter = [];
          this.showHistory = false;
          this.searchQuery = '';
          this.$nextTick(() => {
            this.isHydrating = false;
            this.saveUIPrefs(); // Persist reset state (All filter, history off) so refresh doesn't resurrect old filter
          });
        },
        saveUIPrefs() {
          if (this.isHydrating) return; // Never write prefs during hydration
          const prefs = {
            statusFilter: this.statusFilter, // now an array
            sortMode: this.sortMode,
            showHistory: this.showHistory,
            showJourneyHistory: this.showJourneyHistory,
            calendarViewMode: this.calendarViewMode,
            calendarShowHistory: this.calendarShowHistory,
            hasSeenCalendarCard: this.hasSeenCalendarCard,
            hasHighlightedFirstTripCard: this.hasHighlightedFirstTripCard,
            hasSeenCalendarAha: this.hasSeenCalendarAha
          };
          try {
            localStorage.setItem('travelHubUIPrefs', JSON.stringify(prefs));
          } catch (e) {
            // Ignore localStorage errors (quota, private mode)
          }
        },
        loadUIPrefs() {
          try {
            const stored = localStorage.getItem('travelHubUIPrefs');
            if (stored) {
              const prefs = JSON.parse(stored);
              const validStatuses = ['Idea', 'Planning', 'Committed', 'Canceled', 'Completed'];

              // Restore statusFilter ‚Äî handles both new array and legacy string formats
              if (Array.isArray(prefs.statusFilter)) {
                this.statusFilter = prefs.statusFilter.filter(s => validStatuses.includes(s));
              } else if (typeof prefs.statusFilter === 'string') {
                // Legacy: 'All' ‚Üí [], valid status string ‚Üí [status]
                this.statusFilter = validStatuses.includes(prefs.statusFilter)
                  ? [prefs.statusFilter]
                  : [];
              }

              // Validate sortMode
              const validSortModes = ['date-soonest', 'date-furthest', 'name-asc', 'name-desc', 'journey'];
              if (prefs.sortMode && validSortModes.includes(prefs.sortMode)) {
                this.sortMode = prefs.sortMode;
              }

              // Restore showHistory preference
              if (typeof prefs.showHistory === 'boolean') {
                this.showHistory = prefs.showHistory;
              }

              // Restore showJourneyHistory preference
              if (typeof prefs.showJourneyHistory === 'boolean') {
                this.showJourneyHistory = prefs.showJourneyHistory;
              }

              // Restore calendarViewMode preference
              if (prefs.calendarViewMode === 'quarter' || prefs.calendarViewMode === 'month') {
                this.calendarViewMode = prefs.calendarViewMode;
              }

              // Restore calendarShowHistory preference
              if (typeof prefs.calendarShowHistory === 'boolean') {
                this.calendarShowHistory = prefs.calendarShowHistory;
              }

              // Restore hasSeenCalendarCard flag
              if (typeof prefs.hasSeenCalendarCard === 'boolean') {
                this.hasSeenCalendarCard = prefs.hasSeenCalendarCard;
              }

              // Restore hasHighlightedFirstTripCard flag (prevents re-triggering glow on reload)
              if (typeof prefs.hasHighlightedFirstTripCard === 'boolean') {
                this.hasHighlightedFirstTripCard = prefs.hasHighlightedFirstTripCard;
              }

              // Restore hasSeenCalendarAha flag (prevents re-showing "this is your year" callout)
              if (typeof prefs.hasSeenCalendarAha === 'boolean') {
                this.hasSeenCalendarAha = prefs.hasSeenCalendarAha;
              }
            }
          } catch (err) {
            console.error('Failed to load UI preferences:', err);
          }
        },
        markUnsaved() {
          if (this.isHydrating) return; // Never dirty during data load
          if (this.tripPageMode === 'create') return; // Draft not persisted yet
          this.unsavedChanges = true;
          this.queueAutoSave();
        },

        // ‚îÄ‚îÄ AutoSave ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        queueAutoSave() {
          if (this.isHydrating) return;
          this.saveStatus = 'saving';
          this.saveStatusVisible = true;
          clearTimeout(this._autoSaveTimer);
          this._autoSaveTimer = setTimeout(() => this.autoSaveNow(), 1500);
        },
        autoSaveNow() {
          if (this.isHydrating) return;
          try {
            const payload = JSON.stringify({
              version: this.dataFile.version || '2.0.0',
              trips: this.dataFile.trips,
              journeys: this.dataFile.journeys || [],
              savedAt: new Date().toISOString()
            });
            localStorage.setItem('travelHub_data', payload);
            this.saveStatus = 'saved';
            this.saveStatusVisible = true;
            clearTimeout(this._saveStatusFadeTimer);
            this._saveStatusFadeTimer = setTimeout(() => { this.saveStatusVisible = false; }, 3000);
            this.saveErrorMessage = '';
            this.unsavedChanges = false; // AutoSave succeeded ‚Äî no data-loss risk
          } catch (e) {
            this.saveStatus = 'error';
            this.saveErrorMessage = 'Unable to save (storage may be full). Please make a backup file.';
            console.error('AutoSave failed:', e);
          }
        },
        loadFromLocalStorage() {
          try {
            const stored = localStorage.getItem('travelHub_data');
            if (!stored) return;
            const data = JSON.parse(stored);
            if (!data || !Array.isArray(data.trips) || data.trips.length === 0) return;
            const { dataFile } = this.normalizeFile(data);
            this._hydrate(dataFile); // Silent restore ‚Äî no toast needed
          } catch (e) {
            console.error('Failed to restore autosave data:', e);
            // Not a fatal error ‚Äî user starts with empty app
          }
        },
        loadSettings() {
          try {
            const stored = localStorage.getItem('travelHubSettings');
            if (!stored) return;
            const s = JSON.parse(stored);
            if (s && s.lastBackupDate) {
              this.settings.lastBackupDate = s.lastBackupDate;
            }
            if (s && typeof s.hasRunBefore === 'boolean') {
              this.settings.hasRunBefore = s.hasRunBefore;
            }
          } catch (e) { /* ignore */ }
          finally {
            this.settingsLoaded = true; // Always set after load attempt; prevents backup-reminder FOUC
          }
        },
        saveSettings() {
          try {
            localStorage.setItem('travelHubSettings', JSON.stringify(this.settings));
          } catch (e) { /* ignore */ }
        },

        handleBeforeUnload(e) {
          // Only block tab close when autosave has FAILED (storage full, quota exceeded, etc.).
          // In all normal cases autosave keeps localStorage up-to-date, so closing is safe.
          if (this.saveStatus === 'error') {
            e.preventDefault();
            e.returnValue = '';
            return '';
          }
        },
        // Open JSON file
        triggerFileOpen() {
          this.$refs.fileInput.click();
        },
        openJSON(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);

              // Validate basic shape
              if (typeof data !== 'object' || data === null) {
                this.showToast('Invalid JSON file', 'error');
                return;
              }

              if (!data.trips || !Array.isArray(data.trips)) {
                this.showToast('File does not contain trips array', 'error');
                return;
              }

              // Normalize and track fixes
              const { dataFile, fixes } = this.normalizeFile(data);

              // Check if imported file has no trips
              if (dataFile.trips.length === 0) {
                this.showToast('No trips found in file', 'info');
                return;
              }

              // Store pending import data
              this.pendingImportData = dataFile;
              this.pendingImportFixes = fixes;
              this.pendingImportFileName = file.name;

              // If no trips loaded, open directly
              if (this.dataFile.trips.length === 0) {
                this.confirmOpenReplace();
              } else {
                // Show open/merge modal
                this.showOpenMergeModal = true;
              }

            } catch (error) {
              console.error('JSON parse error:', error);
              this.showToast('Invalid JSON file', 'error');
            }
          };

          reader.onerror = () => {
            this.showToast('Error reading file', 'error');
          };

          reader.readAsText(file);
          // Reset input so same file can be selected again
          event.target.value = '';
        },
        // Save JSON file
        backupJSON() {
          try {
            // Prepare export data
            const exportData = {
              version: '2.0.0',
              trips: this.dataFile.trips,
              journeys: this.dataFile.journeys || [],
              exportDate: new Date().toISOString()
            };

            // Create blob and download
            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            // Generate filename
            let filename;
            if (this.lastSavedFileName) {
              filename = this.lastSavedFileName;
            } else {
              const today = new Date();
              const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
              filename = `travel-hub-${dateStr}.json`;
            }

            // Trigger download (Safari-compatible)
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // Update backup tracking
            this.lastSavedFileName = filename;
            this.unsavedChanges = false;
            this.settings.lastBackupDate = new Date().toISOString();
            this.saveSettings();
            this.showBackupHint = false; // Dismiss hint panel after backup
            this.showToast(`Backup saved to Downloads`, 'success');

          } catch (error) {
            console.error('Backup error:', error);
            this.showToast('Error creating backup', 'error');
          }
        },
        // Alias kept for any legacy internal calls
        saveJSON() { this.backupJSON(); },
        // Load Example Data
        async loadExampleData() {
          // Check for unsaved changes
          if (this.unsavedChanges) {
            this.pendingNavigation = () => {
              this.unsavedChanges = false;
              this.loadExampleData();
            };
            this.showConfirmModal = true;
            return;
          }

          try {
            // Fetch example data (relative path)
            const response = await fetch('./example-data.json', { cache: 'no-store' });

            if (!response.ok) {
              throw new Error('Failed to fetch');
            }

            // Parse JSON
            const data = await response.json();

            // Validate basic shape
            if (typeof data !== 'object' || data === null) {
              this.showToast('Invalid example data file', 'error');
              return;
            }

            if (!data.trips || !Array.isArray(data.trips)) {
              this.showToast('Example data does not contain trips array', 'error');
              return;
            }

            // Normalize and track fixes
            const { dataFile, fixes } = this.normalizeFile(data);

            // Check if example file has no trips
            if (dataFile.trips.length === 0) {
              this.showToast('No trips found in example data', 'info');
              return;
            }

            // Stage into pending state (same flow as file open)
            this.pendingImportData = dataFile;
            this.pendingImportFixes = fixes;
            this.pendingImportFileName = null; // Not from a real file
            this.pendingImportSource = 'example';

            // If no existing trips: replace immediately; otherwise show merge/replace modal
            if (this.dataFile.trips.length === 0) {
              this.confirmOpenReplace();
            } else {
              this.showOpenMergeModal = true;
            }

          } catch (error) {
            console.error('Failed to load example data:', error);
            this.showToast('Example data isn\'t available here. Download example-data.json and open it manually.', 'error');
          }
        },
        // Confirm: Open (Replace)
        confirmOpenReplace() {
          if (!this.pendingImportData) return;

          // Replace current data (hydrate = no dirty-state side-effects)
          this._hydrate(this.pendingImportData);

          // Example data doesn't have a "saved file" ‚Äî keep lastSavedFileName null
          this.lastSavedFileName = this.pendingImportSource === 'example' ? null : this.pendingImportFileName;

          // Ensure clean state after any replace (redundant with _hydrate but explicit)
          this.unsavedChanges = false;
          this.saveStatus = 'saved';

          // Show toast
          const tripCount = this.pendingImportData.trips.length;
          const tripWord = tripCount !== 1 ? 'trips' : 'trip';
          const fixes = this.pendingImportFixes;

          if (fixes.length === 0) {
            this.showToast(`Opened ${tripCount} ${tripWord}`, 'success');
          } else {
            this.importFixes = fixes;
            const fixCount = fixes.length;
            const fixWord = fixCount !== 1 ? 'fixes' : 'fix';
            this.showToast(`Opened ${tripCount} ${tripWord} with ${fixCount} ${fixWord}. View details`, 'warning', () => {
              this.showFixesModal = true;
            });
          }

          // Save source before clearing (used below to skip modal for example data)
          const importedSource = this.pendingImportSource;

          // Clear pending data and close modal
          this.pendingImportData = null;
          this.pendingImportFixes = [];
          this.pendingImportFileName = null;
          this.pendingImportSource = null;
          this.showOpenMergeModal = false;

          // Show file location info on first open ‚Äî skip for example data (it has
          // no real file, so the "where is your backup stored?" prompt isn't relevant)
          if (importedSource !== 'example') {
            try {
              const hasSeenInfo = localStorage.getItem('travelHubFileLocationInfoSeen');
              if (!hasSeenInfo) {
                this.showFileLocationInfoModal = true;
              }
            } catch (e) {
              // Ignore localStorage errors
            }
          }
        },
        // Confirm: Merge
        confirmOpenMerge() {
          if (!this.pendingImportData) return;

          const incomingTrips = this.pendingImportData.trips;
          const existingIds = new Set(this.dataFile.trips.map(t => t.id));

          // Merge trips with ID collision prevention
          const mergedTrips = incomingTrips.map(trip => {
            // Check if trip ID collides
            let newId = trip.id;
            if (existingIds.has(newId)) {
              newId = this.makeId();
            }
            existingIds.add(newId);

            // Assign new IDs to all todos/expenses to prevent global collisions
            const newTodos = (trip.todos || []).map(todo => ({
              ...todo,
              id: this.makeId()
            }));

            const newExpenses = (trip.expenses || []).map(expense => ({
              ...expense,
              id: this.makeId()
            }));

            return {
              ...trip,
              id: newId,
              todos: newTodos,
              expenses: newExpenses
            };
          });

          // Append merged trips to current trips
          this.dataFile.trips.push(...mergedTrips);

          // Merge journeys (if any in imported data)
          const incomingJourneys = this.pendingImportData.journeys || [];
          if (incomingJourneys.length > 0) {
            if (!this.dataFile.journeys) this.dataFile.journeys = [];
            const existingJourneyIds = new Set(this.dataFile.journeys.map(j => j.id));
            incomingJourneys.forEach(j => {
              let newId = j.id;
              if (existingJourneyIds.has(newId)) {
                newId = this.makeId();
              }
              existingJourneyIds.add(newId);
              this.dataFile.journeys.push({ ...j, id: newId });
            });
          }

          // Merge = new data just landed ‚Äî schedule autosave so it persists on reload
          // markUnsaved() sets unsavedChanges=true AND queues the 1.5s autosave.
          // Previously only set unsavedChanges=true (no autosave triggered) ‚Äî merge was lost on reload.
          this.markUnsaved();
          // Reset filters so merged trips are visible immediately
          this.statusFilter = [];
          this.showHistory = false;
          this.searchQuery = '';

          // Show toast
          const tripCount = mergedTrips.length;
          const tripWord = tripCount !== 1 ? 'trips' : 'trip';
          const fixes = this.pendingImportFixes;

          if (fixes.length === 0) {
            this.showToast(`Merged ${tripCount} ${tripWord}`, 'success');
          } else {
            this.importFixes = fixes;
            const fixCount = fixes.length;
            const fixWord = fixCount !== 1 ? 'fixes' : 'fix';
            this.showToast(`Merged ${tripCount} ${tripWord} with ${fixCount} ${fixWord}. View details`, 'warning', () => {
              this.showFixesModal = true;
            });
          }

          // Clear pending data and close modal
          this.pendingImportData = null;
          this.pendingImportFixes = [];
          this.pendingImportFileName = null;
          this.pendingImportSource = null;
          this.showOpenMergeModal = false;
        },
        // Cancel: Open or Merge
        cancelOpenMerge() {
          this.pendingImportData = null;
          this.pendingImportFixes = [];
          this.pendingImportSource = null;
          this.pendingImportFileName = null;
          this.showOpenMergeModal = false;
        },
        // File Location Info Modal
        closeFileLocationInfo() {
          this.showFileLocationInfoModal = false;
          // Mark that user has seen this info
          try {
            localStorage.setItem('travelHubFileLocationInfoSeen', 'true');
          } catch (e) {
            // Ignore localStorage errors
          }
        },
        // Toast notifications
        showToast(message, type = 'info', onClick = null) {
          const id = Date.now();
          this.toasts.push({ id, message, type, onClick });

          // Auto-remove after 5 seconds (longer for clickable toasts)
          const duration = onClick ? 5000 : 3000;
          setTimeout(() => {
            const index = this.toasts.findIndex(t => t.id === id);
            if (index !== -1) {
              this.toasts.splice(index, 1);
            }
          }, duration);
        },
        handleToastClick(toast) {
          if (toast.onClick) {
            toast.onClick();
            // Remove toast after click
            const index = this.toasts.findIndex(t => t.id === toast.id);
            if (index !== -1) {
              this.toasts.splice(index, 1);
            }
          }
        },
        openExportMenu() {
          this.showExportMenu = true;
          // Add click-outside listener after DOM update
          this.$nextTick(() => {
            document.addEventListener('click', this.handleExportMenuClickOutside);
          });
        },
        closeExportMenu() {
          this.showExportMenu = false;
          // Always remove listener when closing
          document.removeEventListener('click', this.handleExportMenuClickOutside);
        },
        toggleExportMenu() {
          if (this.showExportMenu) {
            this.closeExportMenu();
          } else {
            this.openExportMenu();
          }
        },
        handleExportMenuClickOutside(e) {
          // Close menu if click is outside the dropdown container
          const dropdown = e.target.closest('.dropdown-container');
          if (!dropdown) {
            this.closeExportMenu();
          }
        },
        // ‚îÄ‚îÄ Settings menu (gear icon in header) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        openSettingsMenu() {
          this.showSettingsMenu = true;
          this.$nextTick(() => {
            document.addEventListener('click', this.handleSettingsMenuClickOutside);
          });
        },
        closeSettingsMenu() {
          this.showSettingsMenu = false;
          document.removeEventListener('click', this.handleSettingsMenuClickOutside);
        },
      toggleSidebarSearch() {
        this.sidebarSearchOpen = !this.sidebarSearchOpen;
        if (this.sidebarSearchOpen) {
          this.$nextTick(() => {
            if (this.$refs.sidebarSearchInput) this.$refs.sidebarSearchInput.focus();
          });
        } else {
          this.searchQuery = '';
        }
      },
      closeSidebarSearch() {
        this.sidebarSearchOpen = false;
        this.searchQuery = '';
      },
        // ‚îÄ‚îÄ Search command palette ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        openSearchPalette() {
          this.searchPaletteOpen = true;
          this.searchPaletteQuery = '';
          this.$nextTick(() => {
            this.$refs.paletteInput?.focus();
          });
        },
        closeSearchPalette() {
          this.searchPaletteOpen = false;
          this.searchPaletteQuery = '';
        },
        paletteSelectTrip(trip) {
          this.closeSearchPalette();
          this.selectTrip(trip);
        },
        paletteSelectJourney(journey) {
          this.closeSearchPalette();
          this.openJourneyDetail(journey.id);
        },
        // ‚îÄ‚îÄ Export panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        openExportPanel() {
          this.exportPanelOpen = true;
        },
        closeExportPanel() {
          this.exportPanelOpen = false;
        },
        // ‚îÄ‚îÄ First-run onboarding ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        dismissOnboarding() {
          this.showOnboarding = false;
          this.settings.hasRunBefore = true;
          this.saveSettings();
          // Focus quick-add after the modal closes so user can immediately type a trip name
          this.$nextTick(() => { this.$refs.quickAddInput?.focus(); });
        },

        // ‚îÄ‚îÄ Help link ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async checkHelpAvailability() {
          if (window.location.protocol === 'file:') {
            // Cannot reliably HEAD-check on file://; always show Help
            this.helpAvailable = true;
            return;
          }
          try {
            const res = await fetch('./help.html', { method: 'HEAD', cache: 'no-store' });
            this.helpAvailable = res.ok;
          } catch {
            this.helpAvailable = false;
          }
        },
        openHelp() {
          try {
            const win = window.open('./help.html', '_blank', 'noopener');
            if (!win) {
              // Popup was blocked
              this.showHelpFallbackModal = true;
            }
          } catch {
            this.showHelpFallbackModal = true;
          }
        },

        // ‚îÄ‚îÄ Example data hints ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        toggleExampleHintNearData() {
          const next = !this.showExampleHintNearData;
          this.showExampleHintNearData = next;
          if (next) this.showExampleHintNearBackup = false; // close the other
        },
        toggleExampleHintNearBackup() {
          const next = !this.showExampleHintNearBackup;
          this.showExampleHintNearBackup = next;
          if (next) this.showExampleHintNearData = false; // close the other
        },
        dismissExampleHint() {
          this.exampleHintDismissed = true;
          this.showExampleHintNearData = false;
          this.showExampleHintNearBackup = false;
          try { localStorage.setItem('travelHubExampleHintDismissed', '1'); } catch { /* ignore */ }
        },
        toggleSettingsMenu() {
          if (this.showSettingsMenu) {
            this.closeSettingsMenu();
          } else {
            this.openSettingsMenu();
          }
        },
        handleSettingsMenuClickOutside(e) {
          const menu = e.target.closest('.settings-menu-container');
          if (!menu) {
            this.closeSettingsMenu();
          }
        },
        handleEscapeKey(e) {
          if (e.repeat) return; // Ignore auto-repeat; prevents ESC hold from cycling dialogs
          if (e.key === 'Escape') {
            // Help fallback modal
            if (this.showHelpFallbackModal) {
              this.showHelpFallbackModal = false;
              return;
            }
            // Discard draft modal: ESC = cancel (keep draft)
            if (this.showDiscardDraftModal) {
              this.discardDraftCancel();
              return;
            }
            // Onboarding modal closes at very top priority (first-run)
            if (this.showOnboarding) {
              this.dismissOnboarding();
              return;
            }
            // Search palette and export panel close before other modals
            if (this.searchPaletteOpen) {
              this.closeSearchPalette();
              return;
            }
            if (this.exportPanelOpen) {
              this.closeExportPanel();
              return;
            }
            // Journey modal is highest priority ‚Äî closes first
            if (this.showJourneyModal) {
              this.closeJourneyModal();
            } else if (this.showOpenMergeModal) {
              this.cancelOpenMerge();
            } else if (this.showFileLocationInfoModal) {
              this.closeFileLocationInfo();
            } else if (this.showClearDataModal) {
              this.closeClearDataModal();
            } else if (this.showDeleteTripModal) {
              this.closeDeleteTripModal();
            } else if (this.showDeleteExpenseModal) {
              this.closeDeleteExpenseModal();
            } else if (this.showExpenseModal) {
              this.closeExpenseModal();
            } else if (this.showDeleteTodoModal) {
              this.closeDeleteTodoModal();
            } else if (this.showTodoModal) {
              this.closeTodoModal();
            } else if (this.showFixesModal) {
              this.closeFixesModal();
            } else if (this.showConfirmModal) {
              this.cancelDiscard();
            } else if (this.showSettingsMenu) {
              this.closeSettingsMenu();
            } else if (this.showExportMenu) {
              this.closeExportMenu();
            } else if (this.tripPageMode !== null) {
              // Inline edit inputs use @keydown.escape.stop so they absorb the first ESC
              // and prevent it bubbling here. A second ESC (no active edit) reaches here
              // and closes the overlay.
              this.closeTripOverlay();
            } else if (this.currentView === 'journey-detail') {
              // ESC on journey detail (no modal, no overlay) ‚Üí back to journey list
              this.switchTab('journeys');
            }
          }
        },
        handleKeyboardShortcuts(e) {
          // Use e.code for reliable key detection with modifiers
          const key = e.key ? e.key.toLowerCase() : '';

          // Cmd/Ctrl + S: Backup - prevent FIRST to block Safari's save dialog
          if ((e.metaKey || e.ctrlKey) && (key === 's' || e.code === 'KeyS')) {
            e.preventDefault();
            e.stopPropagation();
            this.backupJSON();
            return;
          }

          // Cmd/Ctrl + Shift + N: New Trip
          if ((e.metaKey || e.ctrlKey) && e.shiftKey && (key === 'n' || e.code === 'KeyN')) {
            e.preventDefault();
            e.stopPropagation();
            this.openNewTrip();
            return;
          }

          // Cmd/Ctrl + K: Toggle search command palette
          if ((e.metaKey || e.ctrlKey) && (key === 'k' || e.code === 'KeyK')) {
            e.preventDefault();
            e.stopPropagation();
            if (this.searchPaletteOpen) {
              this.closeSearchPalette();
            } else {
              this.openSearchPalette();
            }
            return;
          }

          // Don't interfere with typing in inputs/textareas for non-Cmd/Ctrl shortcuts
          const isTyping = e.target.tagName === 'INPUT' ||
                          e.target.tagName === 'TEXTAREA' ||
                          e.target.isContentEditable;

          // / : Focus search (only if not already typing)
          if (key === '/' && !isTyping) {
            const searchInput = document.getElementById('tripSearch');
            if (searchInput && !this.hasOpenModal()) {
              e.preventDefault();
              searchInput.focus();
              return;
            }
          }
        },
        hasOpenModal() {
          return this.searchPaletteOpen ||
                 this.exportPanelOpen ||
                 this.showOpenMergeModal ||
                 this.showFileLocationInfoModal ||
                 this.showClearDataModal ||
                 this.showDeleteTripModal ||
                 this.showExpenseModal ||
                 this.showDeleteExpenseModal ||
                 this.showTodoModal ||
                 this.showDeleteTodoModal ||
                 this.showFixesModal ||
                 this.showConfirmModal ||
                 this.showOnboarding;
        },
        // Export helpers
        sanitizeFilename(name) {
          if (!name || name.trim() === '') return 'trip';
          // Lowercase, replace spaces with hyphens, keep only alphanumeric and hyphens
          return name
            .toLowerCase()
            .trim()
            .replace(/\s+/g, '-')
            .replace(/[^a-z0-9-]/g, '')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '')
            || 'trip';
        },
        escapeHtml(str) {
          if (!str) return '';
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        },
        formatDateForExport(dateStr) {
          if (!dateStr) return '';
          const date = this.parseLocalDate(dateStr);
          const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
          return date.toLocaleDateString('en-US', options);
        },
        // ICS helpers
        formatIcsDate(dateStr) {
          // Convert YYYY-MM-DD to YYYYMMDD for ICS format
          if (!dateStr) return '';
          const date = this.parseLocalDate(dateStr);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}${month}${day}`;
        },
        addDays(dateStr, days) {
          // Add days to a date and return YYYY-MM-DD string
          const date = this.parseLocalDate(dateStr);
          date.setDate(date.getDate() + days);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        },
        escapeIcsText(str) {
          if (!str) return '';
          // Escape backslashes, commas, semicolons, and newlines per ICS spec
          return str
            .replace(/\\/g, '\\\\')
            .replace(/,/g, '\\,')
            .replace(/;/g, '\\;')
            .replace(/\n/g, '\\n');
        },
        exportTripToHTML() {
          if (!this.selectedTrip) {
            this.showToast('No trip selected', 'error');
            return;
          }

          const trip = this.selectedTrip;
          const meta = this.computeTripMeta(trip);

          // Generate filename
          const today = new Date().toISOString().split('T')[0];
          const filename = `trip-${this.sanitizeFilename(trip.name)}-${today}.html`;

          // Generate HTML content
          const html = this.generateTripHTML(trip, meta);

          try {
            // Create blob and download
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            // Create temporary link and click it
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            // Cleanup
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            this.showToast('Exported HTML', 'success');
          } catch (error) {
            console.error('Export error:', error);
            this.showToast('Error exporting trip', 'error');
          }
        },
        exportTripToICS() {
          if (!this.selectedTrip) {
            this.showToast('No trip selected', 'error');
            return;
          }

          const trip = this.selectedTrip;

          // Check if trip has dates
          if (!trip.startDate && !trip.endDate) {
            this.showToast('Trip has no dates', 'error');
            return;
          }

          try {
            // Determine effective start/end dates
            const effectiveStart = trip.startDate || trip.endDate;
            const effectiveEnd = trip.endDate || trip.startDate;

            // Format dates for ICS (YYYYMMDD)
            const dtstart = this.formatIcsDate(effectiveStart);
            // DTEND must be exclusive for all-day events (+1 day)
            const dtendDate = this.addDays(effectiveEnd, 1);
            const dtend = this.formatIcsDate(dtendDate);

            // Generate UID (stable-ish)
            const uid = `trip-${trip.id}@travelhub.local`;

            // Current timestamp in UTC (YYYYMMDDTHHMMSSZ)
            const now = new Date();
            const dtstamp = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

            // Build description from notes, tasks, and expenses
            let description = '';
            if (trip.notes) {
              description += trip.notes + '\n\n';
            }

            // Add tasks summary
            const todos = trip.todos || [];
            if (todos.length > 0) {
              description += 'TASKS:\n';
              todos.forEach(todo => {
                const checkbox = todo.completed ? '[x]' : '[ ]';
                description += `${checkbox} ${todo.title}\n`;
              });
              description += '\n';
            }

            // Add expenses summary
            const expenses = trip.expenses || [];
            if (expenses.length > 0) {
              description += 'EXPENSES:\n';
              let total = 0;
              expenses.forEach(expense => {
                const amount = this.safeParseNumber(expense.amount);
                total += amount;
                description += `${expense.title}: ${this.formatCurrency(amount)}\n`;
              });
              description += `Total: ${this.formatCurrency(total)}\n`;
            }

            // Escape description for ICS
            description = this.escapeIcsText(description.trim());

            // Build ICS content with CRLF line endings
            const icsLines = [
              'BEGIN:VCALENDAR',
              'VERSION:2.0',
              'PRODID:-//Travel Hub//EN',
              'CALSCALE:GREGORIAN',
              'METHOD:PUBLISH',
              'BEGIN:VEVENT',
              `UID:${uid}`,
              `DTSTAMP:${dtstamp}`,
              `DTSTART;VALUE=DATE:${dtstart}`,
              `DTEND;VALUE=DATE:${dtend}`,
              `SUMMARY:${this.escapeIcsText(trip.name)}`,
            ];

            if (trip.destination) {
              icsLines.push(`LOCATION:${this.escapeIcsText(trip.destination)}`);
            }

            if (description) {
              icsLines.push(`DESCRIPTION:${description}`);
            }

            // Optional: add STATUS if canceled
            if (trip.status === 'Canceled') {
              icsLines.push('STATUS:CANCELLED');
            }

            icsLines.push('END:VEVENT');
            icsLines.push('END:VCALENDAR');

            // Join with CRLF
            const icsContent = icsLines.join('\r\n');

            // Generate filename
            const today = new Date().toISOString().split('T')[0];
            const filename = `trip-${this.sanitizeFilename(trip.name)}-${today}.ics`;

            // Create blob and download
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            this.showToast('Exported ICS', 'success');
          } catch (error) {
            console.error('ICS export error:', error);
            this.showToast('Error exporting calendar file', 'error');
          }
        },
        async copyTripSummary() {
          if (!this.selectedTrip) {
            this.showToast('No trip selected', 'error');
            return;
          }

          const trip = this.selectedTrip;
          const meta = this.computeTripMeta(trip);

          try {
            // Build rich HTML for Apple Notes
            let html = `<div style="font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 14px; line-height: 1.5;">`;
            html += `<div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">${this.escapeHtml(trip.name)}</div>`;

            if (trip.destination || trip.status) {
              html += `<div style="color: #64748b; margin-bottom: 8px;">`;
              if (trip.destination) html += this.escapeHtml(trip.destination);
              if (trip.destination && trip.status) html += ' ‚Ä¢ ';
              if (trip.status) html += this.escapeHtml(trip.status);
              html += `</div>`;
            }

            if (trip.startDate) {
              const dateRange = this.formatDateRange(trip.startDate, trip.endDate);
              html += `<div style="margin-bottom: 8px;">${dateRange}`;
              if (meta.duration) {
                html += ` (${meta.duration} day${meta.duration !== 1 ? 's' : ''})`;
              }
              html += `</div>`;
            }

            if (trip.notes) {
              html += `<div style="margin-top: 16px; font-weight: 600;">Notes</div>`;
              html += `<div style="margin-bottom: 12px;">${this.escapeHtml(trip.notes).replace(/\n/g, '<br>')}</div>`;
            }

            const todos = trip.todos || [];
            if (todos.length > 0) {
              html += `<div style="margin-top: 16px; font-weight: 600;">Tasks (${meta.completedTodos}/${meta.totalTodos})</div>`;
              html += `<ul style="margin: 8px 0; padding-left: 20px;">`;
              todos.forEach(todo => {
                const style = todo.completed ? 'text-decoration: line-through; color: #94a3b8;' : '';
                const checkbox = todo.completed ? '‚úì' : '‚óã';
                html += `<li style="${style}">${checkbox} ${this.escapeHtml(todo.title)}</li>`;
              });
              html += `</ul>`;
            }

            const expenses = trip.expenses || [];
            if (expenses.length > 0) {
              html += `<div style="margin-top: 16px; font-weight: 600;">Expenses</div>`;
              html += `<ul style="margin: 8px 0; padding-left: 20px;">`;
              expenses.forEach(expense => {
                const amount = this.safeParseNumber(expense.amount);
                html += `<li>${this.escapeHtml(expense.title)}: ${this.formatCurrency(amount)}`;
                if (expense.category) html += ` (${this.escapeHtml(expense.category)})`;
                html += `</li>`;
              });
              html += `</ul>`;
              html += `<div style="margin-top: 8px; font-weight: 600;">Total: ${this.formatCurrency(meta.totalBudget)}</div>`;
            }

            html += `</div>`;

            // Build plain text fallback
            let plainText = trip.name + '\n';
            if (trip.destination) plainText += trip.destination + '\n';
            if (trip.status) plainText += trip.status + '\n';
            if (trip.startDate) {
              const dateRange = this.formatDateRange(trip.startDate, trip.endDate);
              plainText += dateRange;
              if (meta.duration) plainText += ` (${meta.duration} days)`;
              plainText += '\n';
            }
            if (trip.notes) plainText += '\n' + trip.notes + '\n';
            if (todos.length > 0) {
              plainText += `\nTasks (${meta.completedTodos}/${meta.totalTodos}):\n`;
              todos.forEach(todo => {
                const checkbox = todo.completed ? '[x]' : '[ ]';
                plainText += `  ${checkbox} ${todo.title}\n`;
              });
            }
            if (expenses.length > 0) {
              plainText += '\nExpenses:\n';
              expenses.forEach(expense => {
                const amount = this.safeParseNumber(expense.amount);
                plainText += `  ${expense.title}: ${this.formatCurrency(amount)}\n`;
              });
              plainText += `Total: ${this.formatCurrency(meta.totalBudget)}\n`;
            }

            // Try modern Clipboard API with rich text
            if (navigator.clipboard && window.ClipboardItem) {
              try {
                const blob = new Blob([html], { type: 'text/html' });
                const textBlob = new Blob([plainText], { type: 'text/plain' });
                const clipboardItem = new ClipboardItem({
                  'text/html': blob,
                  'text/plain': textBlob
                });
                await navigator.clipboard.write([clipboardItem]);
                this.showToast('Copied summary', 'success');
                return;
              } catch (err) {
                console.warn('ClipboardItem failed, trying fallback:', err);
              }
            }

            // Fallback: contenteditable + execCommand
            try {
              const div = document.createElement('div');
              div.contentEditable = true;
              div.style.position = 'fixed';
              div.style.left = '-9999px';
              div.innerHTML = html;
              document.body.appendChild(div);

              const selection = window.getSelection();
              const range = document.createRange();
              range.selectNodeContents(div);
              selection.removeAllRanges();
              selection.addRange(range);

              const success = document.execCommand('copy');
              document.body.removeChild(div);

              if (success) {
                this.showToast('Copied summary', 'success');
                return;
              }
            } catch (err) {
              console.warn('contenteditable fallback failed:', err);
            }

            // Final fallback: plain text only
            const textarea = document.createElement('textarea');
            textarea.value = plainText;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();

            const success = document.execCommand('copy');
            document.body.removeChild(textarea);

            if (success) {
              this.showToast('Copied summary (plain text)', 'success');
            } else {
              throw new Error('All copy methods failed');
            }
          } catch (error) {
            console.error('Copy error:', error);
            this.showToast('Copy failed (browser blocked)', 'error');
          }
        },
        async copyAllTrips() {
          const trips = this.visibleTrips && this.visibleTrips.length > 0
            ? this.visibleTrips
            : this.tripsWithMetadata;

          if (trips.length === 0) {
            this.showToast('No trips to copy', 'error');
            return;
          }

          try {
            // Build rich HTML for Apple Notes
            let html = `<div style="font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 14px; line-height: 1.5;">`;
            html += `<div style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">Travel Hub ‚Äî All Trips</div>`;

            trips.forEach((trip, index) => {
              const meta = this.computeTripMeta(trip);

              if (index > 0) {
                html += `<hr style="border: none; border-top: 1px solid #e2e8f0; margin: 16px 0;">`;
              }

              html += `<div style="margin-bottom: 16px;">`;
              html += `<div style="font-weight: 600; font-size: 16px;">${this.escapeHtml(trip.name)}</div>`;

              if (trip.destination || trip.status) {
                html += `<div style="color: #64748b; font-size: 13px; margin-top: 4px;">`;
                if (trip.destination) html += this.escapeHtml(trip.destination);
                if (trip.destination && trip.status) html += ' ‚Ä¢ ';
                if (trip.status) html += this.escapeHtml(trip.status);
                html += `</div>`;
              }

              if (trip.startDate) {
                const dateRange = this.formatDateRange(trip.startDate, trip.endDate);
                html += `<div style="font-size: 13px; color: #64748b; margin-top: 4px;">${dateRange}`;
                if (meta.duration) {
                  html += ` (${meta.duration} day${meta.duration !== 1 ? 's' : ''})`;
                }
                html += `</div>`;
              }

              html += `<div style="font-size: 13px; margin-top: 4px;">`;
              html += `Tasks: ${meta.completedTodos}/${meta.totalTodos} ‚Ä¢ `;
              html += `Budget: ${this.formatCurrency(meta.totalBudget)}`;
              html += `</div>`;
              html += `</div>`;
            });

            html += `</div>`;

            // Build plain text fallback
            let plainText = 'Travel Hub ‚Äî All Trips\n\n';
            trips.forEach((trip, index) => {
              const meta = this.computeTripMeta(trip);

              if (index > 0) plainText += '\n---\n\n';

              plainText += trip.name + '\n';
              if (trip.destination) plainText += trip.destination + '\n';
              if (trip.status) plainText += trip.status + '\n';
              if (trip.startDate) {
                const dateRange = this.formatDateRange(trip.startDate, trip.endDate);
                plainText += dateRange;
                if (meta.duration) plainText += ` (${meta.duration} days)`;
                plainText += '\n';
              }
              plainText += `Tasks: ${meta.completedTodos}/${meta.totalTodos} ‚Ä¢ Budget: ${this.formatCurrency(meta.totalBudget)}\n`;
            });

            // Try modern Clipboard API with rich text
            if (navigator.clipboard && window.ClipboardItem) {
              try {
                const blob = new Blob([html], { type: 'text/html' });
                const textBlob = new Blob([plainText], { type: 'text/plain' });
                const clipboardItem = new ClipboardItem({
                  'text/html': blob,
                  'text/plain': textBlob
                });
                await navigator.clipboard.write([clipboardItem]);
                this.showToast(`Copied ${trips.length} trips`, 'success');
                return;
              } catch (err) {
                console.warn('ClipboardItem failed, trying fallback:', err);
              }
            }

            // Fallback: contenteditable + execCommand
            try {
              const div = document.createElement('div');
              div.contentEditable = true;
              div.style.position = 'fixed';
              div.style.left = '-9999px';
              div.innerHTML = html;
              document.body.appendChild(div);

              const selection = window.getSelection();
              const range = document.createRange();
              range.selectNodeContents(div);
              selection.removeAllRanges();
              selection.addRange(range);

              const success = document.execCommand('copy');
              document.body.removeChild(div);

              if (success) {
                this.showToast(`Copied ${trips.length} trips`, 'success');
                return;
              }
            } catch (err) {
              console.warn('contenteditable fallback failed:', err);
            }

            // Final fallback: plain text only
            const textarea = document.createElement('textarea');
            textarea.value = plainText;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();

            const success = document.execCommand('copy');
            document.body.removeChild(textarea);

            if (success) {
              this.showToast(`Copied ${trips.length} trips (plain text)`, 'success');
            } else {
              throw new Error('All copy methods failed');
            }
          } catch (error) {
            console.error('Copy all trips error:', error);
            this.showToast('Copy failed (browser blocked)', 'error');
          }
        },
        exportAllTripsToHTML() {
          const trips = this.visibleTrips && this.visibleTrips.length > 0
            ? this.visibleTrips
            : this.tripsWithMetadata;

          if (trips.length === 0) {
            this.showToast('No trips to export', 'error');
            return;
          }

          try {
            const now = new Date().toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: 'numeric',
              minute: '2-digit'
            });

            // Build TOC by year
            const tripsByYear = {};
            trips.forEach((trip, index) => {
              const effectiveDateStr = trip.startDate || trip.endDate;
              let year = 'No Date';
              if (effectiveDateStr) {
                const date = this.parseLocalDate(effectiveDateStr);
                year = date.getFullYear().toString();
              }
              if (!tripsByYear[year]) {
                tripsByYear[year] = [];
              }
              tripsByYear[year].push({ trip, index });
            });

            // Sort years
            const sortedYears = Object.keys(tripsByYear).sort((a, b) => {
              if (a === 'No Date') return 1;
              if (b === 'No Date') return -1;
              return b - a; // Descending
            });

            // Build TOC HTML
            let tocHTML = '<ul class="toc-list">';
            sortedYears.forEach(year => {
              tocHTML += `<li class="toc-year"><strong>${year}</strong><ul>`;
              tripsByYear[year].forEach(({ trip, index }) => {
                tocHTML += `<li><a href="#trip-${index}">${this.escapeHtml(trip.name)}</a></li>`;
              });
              tocHTML += `</ul></li>`;
            });
            tocHTML += '</ul>';

            // Build trip sections HTML
            let tripsHTML = '';
            trips.forEach((trip, index) => {
              const meta = this.computeTripMeta(trip);

              // Date range
              let dateRangeDisplay = '';
              if (trip.startDate) {
                const startFormatted = this.formatDateForExport(trip.startDate);
                const endFormatted = trip.endDate ? this.formatDateForExport(trip.endDate) : '';
                if (trip.endDate && trip.endDate !== trip.startDate) {
                  dateRangeDisplay = `${startFormatted} ‚Äì ${endFormatted}`;
                } else {
                  dateRangeDisplay = startFormatted;
                }
              }

              tripsHTML += `
              <div class="trip-section" id="trip-${index}">
                <h2>${this.escapeHtml(trip.name)}</h2>
                ${trip.destination ? `<div class="trip-meta">${this.escapeHtml(trip.destination)}</div>` : ''}
                <div class="trip-meta">
                  <span class="status-badge ${trip.status.toLowerCase()}">${this.escapeHtml(trip.status)}</span>
                  ${dateRangeDisplay ? `<span>${dateRangeDisplay}</span>` : ''}
                  ${meta.duration ? `<span>${meta.duration} day${meta.duration !== 1 ? 's' : ''}</span>` : ''}
                </div>

                ${trip.notes ? `
                <div class="subsection">
                  <h3>Notes</h3>
                  <p>${this.escapeHtml(trip.notes).replace(/\n/g, '<br>')}</p>
                </div>
                ` : ''}

                <div class="subsection">
                  <h3>Tasks (${meta.completedTodos}/${meta.totalTodos})</h3>
                  ${(trip.todos && trip.todos.length > 0) ? `
                    <ul class="compact-list">
                      ${trip.todos.map(todo => `
                        <li ${todo.completed ? 'style="text-decoration: line-through; color: #94a3b8;"' : ''}>
                          ${todo.completed ? '‚úì' : '‚óã'} ${this.escapeHtml(todo.title)}
                        </li>
                      `).join('')}
                    </ul>
                  ` : '<p class="empty">No tasks</p>'}
                </div>

                <div class="subsection">
                  <h3>Expenses (${this.formatCurrency(meta.totalBudget)})</h3>
                  ${(trip.expenses && trip.expenses.length > 0) ? `
                    <ul class="compact-list">
                      ${trip.expenses.map(expense => {
                        const amount = this.safeParseNumber(expense.amount);
                        return `<li>${this.escapeHtml(expense.title)}: ${this.formatCurrency(amount)}</li>`;
                      }).join('')}
                    </ul>
                  ` : '<p class="empty">No expenses</p>'}
                </div>
              </div>
              `;
            });

            // Generate complete HTML
            const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Travel Hub ‚Äî All Trips</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #334155;
      background: #ffffff;
      padding: 24px;
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    .export-info {
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 32px;
    }
    .toc {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 48px;
    }
    .toc h2 {
      font-size: 1.25rem;
      margin-bottom: 16px;
      color: #1e293b;
    }
    .toc-list { list-style: none; }
    .toc-year { margin-bottom: 16px; }
    .toc-year > strong { color: #1e293b; }
    .toc-year > ul {
      list-style: none;
      margin-top: 8px;
      margin-left: 16px;
    }
    .toc-year > ul > li {
      margin-bottom: 4px;
    }
    .toc a {
      color: #2563eb;
      text-decoration: none;
    }
    .toc a:hover {
      text-decoration: underline;
    }
    .trip-section {
      border-top: 2px solid #e2e8f0;
      padding-top: 32px;
      margin-top: 32px;
      page-break-inside: avoid;
    }
    .trip-section:first-of-type {
      border-top: none;
      margin-top: 0;
    }
    .trip-section h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
    }
    .trip-meta {
      color: #64748b;
      margin-bottom: 8px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-badge.planning { background: rgba(37, 99, 235, 0.1); color: #2563eb; }
    .status-badge.committed { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .status-badge.canceled { background: rgba(107, 114, 128, 0.1); color: #6b7280; }
    .status-badge.completed { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .subsection {
      margin-top: 24px;
    }
    .subsection h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #334155;
      margin-bottom: 8px;
    }
    .compact-list {
      list-style: none;
      margin-left: 0;
      padding-left: 20px;
    }
    .compact-list li {
      margin-bottom: 4px;
    }
    .empty {
      color: #94a3b8;
      font-style: italic;
    }
    @media print {
      body { padding: 0; max-width: none; }
      .trip-section { page-break-before: auto; page-break-after: auto; page-break-inside: avoid; }
      .toc { page-break-after: always; }
    }
    @media (max-width: 640px) {
      body { padding: 16px; }
      h1 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <h1>Travel Hub ‚Äî All Trips</h1>
  <div class="export-info">Exported ${trips.length} trip${trips.length !== 1 ? 's' : ''} on ${now}</div>

  <div class="toc">
    <h2>Table of Contents</h2>
    ${tocHTML}
  </div>

  ${tripsHTML}
</body>
</html>`;

            // Generate filename
            const today = new Date().toISOString().split('T')[0];
            const filename = `travel-hub-all-trips-${today}.html`;

            // Create blob and download
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            this.showToast(`Exported ${trips.length} trips`, 'success');
          } catch (error) {
            console.error('Export all trips error:', error);
            this.showToast('Error exporting trips', 'error');
          }
        },
        generateTripHTML(trip, meta) {
          const now = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
          });

          // Format dates
          const startDateFormatted = trip.startDate ? this.formatDateForExport(trip.startDate) : '';
          const endDateFormatted = trip.endDate ? this.formatDateForExport(trip.endDate) : '';

          // Build date range display
          let dateRangeDisplay = '';
          if (trip.startDate) {
            if (trip.endDate && trip.endDate !== trip.startDate) {
              dateRangeDisplay = `${startDateFormatted} ‚Äì ${endDateFormatted}`;
            } else {
              dateRangeDisplay = startDateFormatted;
            }
          }

          // Duration display
          const durationDisplay = meta.duration ? `${meta.duration} day${meta.duration !== 1 ? 's' : ''}` : '';

          // Todos section
          const todos = trip.todos || [];
          let todosHTML = '';
          if (todos.length > 0) {
            todosHTML = todos.map(todo => `
              <li class="todo-item ${todo.completed ? 'completed' : ''}">
                <span class="checkbox">${todo.completed ? '‚úì' : ' '}</span>
                <span class="todo-text">${this.escapeHtml(todo.title)}</span>
                ${todo.description ? `<div class="todo-description">${this.escapeHtml(todo.description)}</div>` : ''}
              </li>
            `).join('');
          } else {
            todosHTML = '<p class="empty-message">No tasks added</p>';
          }

          // Expenses section
          const expenses = trip.expenses || [];
          let expensesHTML = '';
          let categoryTotals = {};

          if (expenses.length > 0) {
            expensesHTML = expenses.map(expense => {
              const amount = this.safeParseNumber(expense.amount);
              const category = expense.category || 'Other';

              // Track category totals
              categoryTotals[category] = (categoryTotals[category] || 0) + amount;

              return `
              <tr>
                <td>
                  <div class="expense-title">${this.escapeHtml(expense.title)}</div>
                  ${expense.description ? `<div class="expense-description">${this.escapeHtml(expense.description)}</div>` : ''}
                </td>
                <td>${this.escapeHtml(category)}</td>
                <td class="amount">${this.formatCurrency(amount)}</td>
              </tr>
              `;
            }).join('');
          } else {
            expensesHTML = '<tr><td colspan="3" class="empty-message">No expenses added</td></tr>';
          }

          // Category subtotals
          let categorySubtotalsHTML = '';
          if (Object.keys(categoryTotals).length > 0) {
            const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
            categorySubtotalsHTML = `
              <div class="category-subtotals">
                <h3>By Category</h3>
                <ul>
                  ${sortedCategories.map(([cat, total]) =>
                    `<li><span class="category-name">${this.escapeHtml(cat)}</span><span class="category-total">${this.formatCurrency(total)}</span></li>`
                  ).join('')}
                </ul>
              </div>
            `;
          }

          // Notes with preserved newlines
          const notesHTML = trip.notes
            ? this.escapeHtml(trip.notes).replace(/\n/g, '<br>')
            : '<p class="empty-message">No notes added</p>';

          // Generate complete HTML document
          return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>${this.escapeHtml(trip.name)} - Travel Hub Export</title>
  <style>
    /* Reset & Base */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #334155;
      background: #ffffff;
      padding: 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 24px;
      margin-bottom: 32px;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 12px;
    }

    .destination {
      font-size: 1.25rem;
      color: #64748b;
      margin-bottom: 12px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .status-badge.planning { background: rgba(37, 99, 235, 0.1); color: #2563eb; }
    .status-badge.committed { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .status-badge.canceled { background: rgba(107, 114, 128, 0.1); color: #6b7280; }
    .status-badge.completed { background: rgba(16, 185, 129, 0.1); color: #10b981; }

    .date-range {
      font-size: 1rem;
      color: #334155;
      margin-bottom: 8px;
    }

    .export-info {
      font-size: 0.875rem;
      color: #94a3b8;
      margin-top: 16px;
    }

    /* Summary Box */
    .summary {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 32px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .summary-item {
      text-align: center;
    }

    .summary-label {
      font-size: 0.875rem;
      color: #64748b;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1e293b;
    }

    /* Sections */
    .section {
      margin-bottom: 32px;
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #334155;
      margin: 16px 0 8px;
    }

    .notes {
      color: #334155;
      white-space: pre-wrap;
    }

    /* Tasks List */
    .todo-list {
      list-style: none;
    }

    .todo-item {
      display: flex;
      align-items: flex-start;
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
    }

    .todo-item:last-child {
      border-bottom: none;
    }

    .checkbox {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border: 2px solid #cbd5e1;
      border-radius: 4px;
      margin-right: 12px;
      flex-shrink: 0;
      font-size: 14px;
      font-weight: 700;
      color: #10b981;
    }

    .todo-item.completed .checkbox {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }

    .todo-item.completed .todo-text {
      text-decoration: line-through;
      color: #94a3b8;
    }

    .todo-description {
      font-size: 0.875rem;
      color: #64748b;
      margin-top: 4px;
      margin-left: 32px;
    }

    .todo-item.completed .todo-description {
      text-decoration: line-through;
      color: #94a3b8;
    }

    /* Expenses Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
    }

    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
    }

    th {
      background: #f8fafc;
      font-weight: 600;
      color: #1e293b;
    }

    td.amount {
      text-align: right;
      font-weight: 600;
      white-space: nowrap;
    }

    .expense-title {
      font-weight: 600;
      color: #334155;
    }

    .expense-description {
      font-size: 0.875rem;
      color: #64748b;
      margin-top: 4px;
    }

    .table-total {
      text-align: right;
      font-weight: 700;
      color: #1e293b;
      padding: 16px 12px;
      border-top: 2px solid #334155;
      font-size: 1.125rem;
    }

    /* Category Subtotals */
    .category-subtotals {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .category-subtotals h3 {
      margin: 0 0 12px;
      border: none;
      padding: 0;
    }

    .category-subtotals ul {
      list-style: none;
    }

    .category-subtotals li {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .category-subtotals li:last-child {
      border-bottom: none;
    }

    .category-name {
      color: #64748b;
    }

    .category-total {
      font-weight: 600;
      color: #1e293b;
    }

    /* Empty States */
    .empty-message {
      color: #94a3b8;
      font-style: italic;
      padding: 16px;
      text-align: center;
    }

    /* Print Styles */
    @media print {
      body {
        padding: 0;
        max-width: none;
      }

      .header {
        page-break-after: avoid;
      }

      .section {
        page-break-inside: avoid;
      }

      .todo-item, tr {
        page-break-inside: avoid;
      }

      table { page-break-inside: auto; }
      tr    { page-break-inside: avoid; page-break-after: auto; }
    }

    /* Mobile Responsive */
    @media (max-width: 640px) {
      body {
        padding: 16px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .summary {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 0.875rem;
      }

      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>${this.escapeHtml(trip.name)}</h1>
    ${trip.destination ? `<div class="destination">${this.escapeHtml(trip.destination)}</div>` : ''}
    <div class="status-badge ${trip.status.toLowerCase()}">${this.escapeHtml(trip.status)}</div>
    ${dateRangeDisplay ? `<div class="date-range">${dateRangeDisplay}</div>` : ''}
    ${durationDisplay ? `<div class="date-range">${durationDisplay}</div>` : ''}
    <div class="export-info">Exported from Travel Hub on ${now}</div>
  </div>

  <div class="summary">
    <div class="summary-item">
      <div class="summary-label">Tasks</div>
      <div class="summary-value">${meta.completedTodos}/${meta.totalTodos}</div>
    </div>
    <div class="summary-item">
      <div class="summary-label">Total Budget</div>
      <div class="summary-value">${this.formatCurrency(meta.totalBudget)}</div>
    </div>
  </div>

  ${trip.notes ? `
  <div class="section">
    <h2>Notes</h2>
    <div class="notes">${notesHTML}</div>
  </div>
  ` : ''}

  <div class="section">
    <h2>Tasks</h2>
    ${todos.length > 0 ? `<ul class="todo-list">${todosHTML}</ul>` : todosHTML}
  </div>

  <div class="section">
    <h2>Expenses</h2>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Category</th>
          <th style="text-align: right;">Amount</th>
        </tr>
      </thead>
      <tbody>
        ${expensesHTML}
      </tbody>
    </table>
    ${expenses.length > 0 ? `<div class="table-total">Total: ${this.formatCurrency(meta.totalBudget)}</div>` : ''}
    ${categorySubtotalsHTML}
  </div>
</body>
</html>`;
        },
        initTheme() {
          // Check localStorage first; default to dark if no preference stored.
          // (A blocking script in <head> already applies the theme before first paint
          //  to prevent flash-of-wrong-theme on iOS Safari and other browsers.)
          const stored = localStorage.getItem('travelHubTheme');
          this.theme = stored || 'dark';
          document.documentElement.setAttribute('data-theme', this.theme);
        }
      },
      mounted() {
        // Non-reactive timer handle for autosave debounce
        this._autoSaveTimer = null;

        // Initialize calendar month to current month (non-persisted ‚Äî always starts fresh)
        const now = new Date();
        this.calendarMonth = { year: now.getFullYear(), month: now.getMonth() };

        // Initialize theme
        this.initTheme();

        // Load UI preferences (filter/sort + calendarViewMode)
        this.loadUIPrefs();

        // Load settings (lastBackupDate, hasRunBefore)
        this.loadSettings();

        // Check if help.html is available (HEAD request on http/https; always true on file://)
        this.checkHelpAvailability();

        // Restore example hint dismissed state
        try {
          if (localStorage.getItem('travelHubExampleHintDismissed')) {
            this.exampleHintDismissed = true;
          }
        } catch { /* ignore */ }

        // Add keyboard event listeners (stored as named functions for cleanup)
        document.addEventListener('keydown', this.handleEscapeKey);
        // Use capture phase (true) to intercept Cmd+S/Cmd+N before Safari handles them
        document.addEventListener('keydown', this.handleKeyboardShortcuts, true);

        // First run shows empty state by design. Example data only via button.
        // hasRunBefore persists in travelHubSettings (localStorage).
        // - False on very first open: skip restore ‚Üí user sees 0 trips.
        // - True on every subsequent open: restore autosaved trips normally.
        // Note: if user loads example data and it gets autosaved, it WILL restore on next launch.
        // That is intentional ‚Äî it's their data now.
        if (!this.settings.hasRunBefore) {
          // Show onboarding modal for very first launch.
          // hasRunBefore is set to true only when the user dismisses the modal
          // (via dismissOnboarding) ‚Äî not here ‚Äî so if they close the browser
          // before dismissing they'll see the modal again next time.
          this.showOnboarding = true;
          return; // Start empty ‚Äî do NOT call loadFromLocalStorage()
        }

        // Restore autosaved trip data from localStorage (silent, no toast)
        this.loadFromLocalStorage();

        // Auto-focus quick-add if returning to an empty list
        this.$nextTick(() => {
          if (!this.dataFile.trips.length) this.$refs.quickAddInput?.focus();
        });
      },
      beforeUnmount() {
        // Cleanup event listeners (must match addEventListener parameters)
        document.removeEventListener('keydown', this.handleEscapeKey);
        document.removeEventListener('keydown', this.handleKeyboardShortcuts, true);
        window.removeEventListener('beforeunload', this.handleBeforeUnload);
        document.removeEventListener('click', this.handleSettingsMenuClickOutside);
      }
    }).mount('#app');
  </script>
</body>
</html>
